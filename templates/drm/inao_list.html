{% extends 'drm/base_drm.html' %}
{% block title %}Codes INAO (Douanes){% endblock %}
{% block drm_content %}
{% include '_layout/breadcrumbs.html' %}

<div class="d-flex justify-content-between align-items-start mb-3">
  <div>
    <h1 class="h4 mb-1">Codes Vinicoles Interprofessionnels</h1>
    <p class="text-muted mb-0">
      <i class="bi bi-database me-1"></i>{{ total_count }} codes INAO/NC en base
    </p>
  </div>
  <a href="{{ douanes_url }}" target="_blank" rel="noopener" class="btn btn-outline-primary">
    <i class="bi bi-box-arrow-up-right me-1"></i>Site Douanes (source officielle)
  </a>
</div>

<div class="alert alert-warning d-flex align-items-start mb-3">
  <i class="bi bi-exclamation-triangle-fill text-warning me-2 mt-1" style="font-size: 1.2rem;"></i>
  <div>
    <strong>Avertissement important</strong><br>
    Ces données sont fournies à titre indicatif. Il appartient à l'utilisateur de <strong>contrôler la justesse des codes</strong> 
    utilisés dans ses déclarations. Les codes vinicoles interprofessionnels peuvent évoluer. 
    Consultez régulièrement le <a href="{{ douanes_url }}" target="_blank" rel="noopener">site officiel des Douanes</a> 
    pour les mises à jour.
  </div>
</div>

<form method="get" class="card card-body mb-3">
  <div class="row g-2">
    <div class="col-md-4">
      <label class="form-label">Recherche libre</label>
      <input type="text" name="q" value="{{ filters.q }}" class="form-control" placeholder="Code INAO, NC, appellation..." autofocus />
    </div>
    <div class="col-md-3">
      <label class="form-label">Appellation</label>
      <input type="text" name="appellation" value="{{ filters.appellation }}" class="form-control" placeholder="Ex: Côtes du Rhône" />
    </div>
    <div class="col-md-2">
      <label class="form-label">Catégorie</label>
      <select name="categorie" class="form-select">
        <option value="">Toutes</option>
        {% for code, label in categories %}
        <option value="{{ code }}" {% if filters.categorie == code %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Région</label>
      <select name="region" class="form-select">
        <option value="">Toutes</option>
        {% for r in regions %}
        <option value="{{ r }}" {% if filters.region == r %}selected{% endif %}>{{ r }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-1 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </div>
  {% if filters.q or filters.appellation or filters.categorie or filters.region %}
  <div class="mt-2">
    <a href="/drm/inao/" class="btn btn-sm btn-outline-secondary">
      <i class="bi bi-x-circle me-1"></i>Effacer les filtres
    </a>
    <span class="text-muted ms-2 small">{{ results|length }} résultat{{ results|pluralize }}</span>
  </div>
  {% endif %}
</form>

{% if limited %}
<div class="alert alert-info py-2">
  <i class="bi bi-info-circle me-1"></i>
  Affichage limité à 100 résultats. Utilisez les filtres pour affiner votre recherche.
</div>
{% endif %}

<div class="table-responsive">
  <table class="table table-sm table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th scope="col" style="width: 120px;">Code INAO</th>
        <th scope="col" style="width: 100px;">Code NC</th>
        <th scope="col">Appellation</th>
        <th scope="col" style="width: 100px;">Catégorie</th>
        <th scope="col" style="width: 100px;">Région</th>
        <th scope="col" style="width: 80px;">Contenance</th>
        <th scope="col" style="width: 100px;">Validité</th>
      </tr>
    </thead>
    <tbody>
      {% for r in results %}
      <tr>
        <td>
          <code class="bg-light px-2 py-1 rounded">{{ r.code_inao }}</code>
        </td>
        <td>
          <code class="text-muted">{{ r.code_nc }}</code>
        </td>
        <td>
          <strong>{{ r.appellation_label }}</strong>
        </td>
        <td>
          {% if r.categorie_code == 'aop_blanc' %}
          <span class="badge bg-warning-subtle text-warning-emphasis">AOP Blanc</span>
          {% elif r.categorie_code == 'aop_rouge_rose' %}
          <span class="badge bg-danger-subtle text-danger-emphasis">AOP Rouge/Rosé</span>
          {% elif r.categorie_code == 'igp_blanc' %}
          <span class="badge bg-success-subtle text-success-emphasis">IGP Blanc</span>
          {% elif r.categorie_code == 'igp_rouge_rose' %}
          <span class="badge bg-primary-subtle text-primary-emphasis">IGP Rouge/Rosé</span>
          {% else %}
          <span class="badge bg-secondary-subtle text-secondary-emphasis">Autre</span>
          {% endif %}
        </td>
        <td class="small text-muted">{{ r.region|default:"—" }}</td>
        <td class="small">{{ r.contenance|default:"—" }}</td>
        <td class="small text-muted">
          {% if r.date_validite %}
          {{ r.date_validite|date:"d/m/Y" }}
          {% else %}
          —
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7" class="text-center text-muted py-4">
          <i class="bi bi-search me-2"></i>Aucun code trouvé. Essayez d'autres critères de recherche.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="mt-3 text-muted small">
  <p class="mb-1">
    <i class="bi bi-info-circle me-1"></i>
    <strong>Source des données :</strong> Codes vinicoles interprofessionnels 2024 - Direction Générale des Douanes et Droits Indirects
  </p>
  <p class="mb-0">
    <a href="{{ douanes_url }}" target="_blank" rel="noopener" class="text-decoration-none">
      <i class="bi bi-link-45deg me-1"></i>Accéder au fichier Excel officiel sur douane.gouv.fr
    </a>
  </p>
</div>
{% endblock %}
