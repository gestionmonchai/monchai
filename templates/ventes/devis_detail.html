{% extends 'base.html' %}

{% block title %}Devis {{ quote.id|slice:":8" }}{% endblock %}

{% block content %}
<div class="row mb-3">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h1 class="mb-2">
          <i class="bi bi-receipt-cutoff me-2 text-primary"></i>
          Devis #{{ quote.id|slice:":8" }}
          <span class="badge {% if quote.status == 'accepted' %}bg-success{% elif quote.status == 'sent' %}bg-info{% elif quote.status == 'expired' %}bg-warning text-dark{% elif quote.status == 'lost' %}bg-danger{% else %}bg-secondary{% endif %} ms-2">
            {{ quote.get_status_display }}
          </span>
        </h1>
        <div class="text-muted">
          <i class="bi bi-calendar"></i> Créé le {{ quote.created_at|date:"d/m/Y H:i" }} • 
          <i class="bi bi-clock"></i> Valide jusqu'au {{ quote.valid_until|date:"d/m/Y" }}
        </div>
      </div>
      <div class="d-flex gap-2 flex-wrap">
        <a href="{% url 'ventes:devis_list' %}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left"></i> Retour
        </a>
        {% if user.get_active_membership.can_edit_data %}
          {% if quote.status == 'draft' %}
          <button class="btn btn-info" onclick="alert('Fonctionnalité à venir')">
            <i class="bi bi-send"></i> Envoyer
          </button>
          {% endif %}
          {% if quote.status == 'sent' %}
          <button class="btn btn-success" onclick="alert('Fonctionnalité à venir')">
            <i class="bi bi-check-circle"></i> Marquer accepté
          </button>
          {% endif %}
          {% if quote.status == 'accepted' %}
          <button class="btn btn-primary" onclick="alert('Fonctionnalité à venir')">
            <i class="bi bi-box-seam"></i> Convertir en commande
          </button>
          {% endif %}
          <button class="btn btn-outline-secondary" onclick="alert('Fonctionnalité à venir')">
            <i class="bi bi-files"></i> Dupliquer
          </button>
          <button class="btn btn-outline-danger" onclick="alert('Fonctionnalité à venir')">
            <i class="bi bi-file-pdf"></i> PDF
          </button>
          <a href="{% url 'ventes:devis_edit' quote_id=quote.id %}" class="btn btn-primary">
            <i class="bi bi-pencil"></i> Modifier
          </a>
        {% endif %}
      </div>
    </div>
    
    <!-- Workflow Timeline -->
    <div class="card mb-3">
      <div class="card-body py-2">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-3">
            <div class="{% if quote.status == 'draft' %}text-primary fw-bold{% else %}text-success{% endif %}">
              <i class="bi bi-{% if quote.status == 'draft' %}circle-fill{% else %}check-circle-fill{% endif %}"></i> Brouillon
            </div>
            <div class="border-top flex-grow-1" style="width:60px;"></div>
            <div class="{% if quote.status == 'sent' %}text-primary fw-bold{% elif quote.status in 'accepted,lost,expired' %}text-success{% else %}text-muted{% endif %}">
              <i class="bi bi-{% if quote.status == 'sent' %}circle-fill{% elif quote.status in 'accepted,lost,expired' %}check-circle-fill{% else %}circle{% endif %}"></i> Envoyé
            </div>
            <div class="border-top flex-grow-1" style="width:60px;"></div>
            <div class="{% if quote.status == 'accepted' %}text-success fw-bold{% elif quote.status in 'lost,expired' %}text-danger{% else %}text-muted{% endif %}">
              <i class="bi bi-{% if quote.status == 'accepted' %}check-circle-fill{% elif quote.status in 'lost,expired' %}x-circle-fill{% else %}circle{% endif %}"></i> 
              {% if quote.status == 'accepted' %}Accepté{% elif quote.status == 'lost' %}Perdu{% elif quote.status == 'expired' %}Expiré{% else %}En attente{% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-8">
    <!-- Client Info Card -->
    <div class="card mb-3">
      <div class="card-header bg-light">
        <h6 class="mb-0"><i class="bi bi-person-circle me-2"></i>Informations client</h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-2">
              <strong>Nom :</strong> {{ quote.customer.legal_name }}
            </div>
            <div class="mb-2">
              <strong>Type :</strong> 
              <span class="badge bg-secondary">{{ quote.customer.get_type_display }}</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-2">
              <strong>Devise :</strong> {{ quote.currency }}
            </div>
            <div class="mb-2">
              <strong>Conditions :</strong> {{ quote.customer.payment_terms|default:"Standard" }}
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Lines Card -->
    <div class="card">
      <div class="card-header bg-light">
        <h6 class="mb-0"><i class="bi bi-list-ul me-2"></i>Lignes du devis</h6>
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:40%">Produit / Service</th>
              <th class="text-end" style="width:10%">Qté</th>
              <th class="text-end" style="width:12%">PU HT</th>
              <th class="text-end" style="width:10%">Remise</th>
              <th class="text-end" style="width:10%">TVA</th>
              <th class="text-end" style="width:18%">Total HT</th>
            </tr>
          </thead>
          <tbody>
            {% for l in lines %}
            <tr>
              <td>
                {% if l.sku %}
                  <div class="fw-semibold">{{ l.sku.label }}</div>
                  <div class="text-muted small">{{ l.description|default:"-" }}</div>
                {% else %}
                  <div class="fw-semibold">{{ l.description }}</div>
                  <div class="text-muted small"><i class="bi bi-tag"></i> Service</div>
                {% endif %}
              </td>
              <td class="text-end">{{ l.qty }}</td>
              <td class="text-end">{{ l.unit_price }} €</td>
              <td class="text-end">{% if l.discount_pct %}{{ l.discount_pct }}%{% else %}-{% endif %}</td>
              <td class="text-end">{{ l.tax_code.rate_pct }}%</td>
              <td class="text-end fw-semibold">{{ l.total_ht }} €</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted py-4">
                <i class="bi bi-inbox"></i> Aucune ligne dans ce devis
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <!-- Totaux Card -->
    <div class="card mb-3">
      <div class="card-header bg-light">
        <h6 class="mb-0"><i class="bi bi-calculator me-2"></i>Totaux</h6>
      </div>
      <div class="card-body">
        <table class="table table-sm mb-0">
          <tr>
            <td>Total HT</td>
            <td class="text-end fw-semibold">{{ quote.total_ht }} {{ quote.currency }}</td>
          </tr>
          <tr>
            <td>Total TVA</td>
            <td class="text-end fw-semibold">{{ quote.total_tax }} {{ quote.currency }}</td>
          </tr>
          <tr class="table-primary">
            <td class="fw-bold">Total TTC</td>
            <td class="text-end fw-bold fs-5">{{ quote.total_ttc }} {{ quote.currency }}</td>
          </tr>
        </table>
      </div>
    </div>
    
    <!-- Actions rapides -->
    {% if user.get_active_membership.can_edit_data %}
    <div class="card mb-3">
      <div class="card-header bg-light">
        <h6 class="mb-0"><i class="bi bi-lightning me-2"></i>Actions rapides</h6>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          {% if quote.status == 'draft' %}
          <button class="btn btn-sm btn-info" onclick="alert('Fonctionnalité à venir')">
            <i class="bi bi-send"></i> Envoyer par email
          </button>
          {% endif %}
          <button class="btn btn-sm btn-outline-secondary" onclick="alert('Fonctionnalité à venir')">
            <i class="bi bi-file-pdf"></i> Télécharger PDF
          </button>
          <button class="btn btn-sm btn-outline-secondary" onclick="alert('Fonctionnalité à venir')">
            <i class="bi bi-printer"></i> Imprimer
          </button>
          <button class="btn btn-sm btn-outline-secondary" onclick="alert('Fonctionnalité à venir')">
            <i class="bi bi-files"></i> Dupliquer
          </button>
        </div>
      </div>
    </div>
    {% endif %}
    
    <!-- Métadonnées Card -->
    <div class="card">
      <div class="card-header bg-light">
        <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Informations</h6>
      </div>
      <div class="card-body small">
        <div class="mb-2">
          <strong>ID:</strong><br>
          <code class="small">{{ quote.id }}</code>
        </div>
        <div class="mb-2">
          <strong>Version:</strong> {{ quote.row_version }}
        </div>
        <div class="mb-2">
          <strong>Organisation:</strong><br>
          {{ quote.organization.name }}
        </div>
        <div class="mb-2">
          <strong>Créé le:</strong><br>
          {{ quote.created_at|date:"d/m/Y à H:i" }}
        </div>
        <div>
          <strong>Modifié le:</strong><br>
          {{ quote.updated_at|date:"d/m/Y à H:i" }}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
