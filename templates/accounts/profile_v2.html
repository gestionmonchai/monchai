{% extends 'base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block title %}Mon compte - Mon Chai{% endblock %}

{% block extra_css %}
<style>
    .account-nav {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        position: sticky;
        top: 80px;
    }
    .account-nav .nav-link {
        color: #495057;
        padding: 12px 20px;
        border-left: 3px solid transparent;
        transition: all 0.2s;
    }
    .account-nav .nav-link:hover {
        background: #f8f9fa;
        color: #8B1538;
    }
    .account-nav .nav-link.active {
        background: linear-gradient(90deg, rgba(139, 21, 56, 0.1) 0%, transparent 100%);
        border-left-color: #8B1538;
        color: #8B1538;
        font-weight: 600;
    }
    .account-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        padding: 24px;
        margin-bottom: 24px;
    }
    .section-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e9ecef;
    }
    .section-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }
    .section-icon.user { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .section-icon.org { background: linear-gradient(135deg, #8B1538 0%, #722f37 100%); color: white; }
    .section-icon.team { background: linear-gradient(135deg, #5a7c59 0%, #4a6649 100%); color: white; }
    .section-icon.prefs { background: linear-gradient(135deg, #d4af37 0%, #b8941e 100%); color: white; }
    
    .member-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
    }
    .member-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #6c757d;
    }
    .role-badge {
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 20px;
    }
    .role-owner { background: #8B1538; color: white; }
    .role-admin { background: #d4af37; color: #333; }
    .role-member { background: #e9ecef; color: #495057; }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #f1f3f4;
    }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: #6c757d; font-size: 0.9rem; }
    .info-value { font-weight: 500; }
    
    .avatar-upload {
        position: relative;
        width: 100px;
        height: 100px;
    }
    .avatar-upload img, .avatar-upload .avatar-placeholder {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #e9ecef;
    }
    .avatar-placeholder {
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        color: #adb5bd;
    }
    .avatar-upload-btn {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #8B1538;
        color: white;
        border: 2px solid white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.2s;
    }
    .avatar-upload-btn:hover { transform: scale(1.1); }
    
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }
    .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Navigation latérale -->
        <div class="col-lg-3 col-xl-2 mb-4">
            <div class="account-nav">
                <nav class="nav flex-column">
                    <a class="nav-link active" href="#profil" data-bs-toggle="pill">
                        <i class="bi bi-person me-2"></i>Mon profil
                    </a>
                    <a class="nav-link" href="#organisation" data-bs-toggle="pill">
                        <i class="bi bi-building me-2"></i>Mon organisation
                    </a>
                    <a class="nav-link" href="#equipe" data-bs-toggle="pill">
                        <i class="bi bi-people me-2"></i>Mon équipe
                    </a>
                    <a class="nav-link" href="#preferences" data-bs-toggle="pill">
                        <i class="bi bi-gear me-2"></i>Préférences
                    </a>
                    <hr class="my-2">
                    <a class="nav-link text-danger" href="{% url 'auth:logout' %}">
                        <i class="bi bi-box-arrow-right me-2"></i>Déconnexion
                    </a>
                </nav>
            </div>
        </div>
        
        <!-- Contenu principal -->
        <div class="col-lg-9 col-xl-10">
            {% include 'components/django_messages.html' %}
            
            <div class="tab-content">
                <!-- Section Profil -->
                <div class="tab-pane fade show active" id="profil">
                    <div class="account-section">
                        <div class="section-header">
                            <div class="section-icon user"><i class="bi bi-person-fill"></i></div>
                            <div>
                                <h4 class="mb-0">Mon profil</h4>
                                <small class="text-muted">Informations personnelles et connexion</small>
                            </div>
                        </div>
                        
                        <form method="post" enctype="multipart/form-data" id="profile-form">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="profile">
                            
                            <div class="row">
                                <div class="col-md-3 text-center mb-4">
                                    <div class="avatar-upload mx-auto">
                                        {% if profile.get_avatar_url %}
                                            <img src="{{ profile.get_avatar_url }}" alt="Avatar" id="avatar-preview">
                                        {% else %}
                                            <div class="avatar-placeholder" id="avatar-preview">
                                                <i class="bi bi-person"></i>
                                            </div>
                                        {% endif %}
                                        <label class="avatar-upload-btn" for="id_avatar">
                                            <i class="bi bi-camera-fill"></i>
                                        </label>
                                    </div>
                                    <input type="file" name="avatar" id="id_avatar" class="d-none" accept="image/*">
                                    <small class="text-muted d-block mt-2">Cliquez pour changer</small>
                                </div>
                                
                                <div class="col-md-9">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label class="form-label fw-bold">Email</label>
                                            <input type="email" class="form-control bg-light" value="{{ user.email }}" readonly>
                                            <small class="text-muted">L'email ne peut pas être modifié</small>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">Prénom</label>
                                            <input type="text" name="first_name" class="form-control" value="{{ user.first_name }}" placeholder="Votre prénom">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">Nom</label>
                                            <input type="text" name="last_name" class="form-control" value="{{ user.last_name }}" placeholder="Votre nom">
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label fw-bold">Nom d'affichage</label>
                                            <input type="text" name="display_name" class="form-control" value="{{ profile.display_name }}" placeholder="Comment vous voulez être appelé">
                                            <small class="text-muted">Si vide, votre prénom/nom ou email sera utilisé</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <hr class="my-4">
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                        <i class="bi bi-key me-1"></i>Changer mon mot de passe
                                    </a>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-lg me-2"></i>Enregistrer
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Section Organisation -->
                <div class="tab-pane fade" id="organisation">
                    <div class="account-section">
                        <div class="section-header">
                            <div class="section-icon org"><i class="bi bi-building"></i></div>
                            <div>
                                <h4 class="mb-0">Mon organisation</h4>
                                <small class="text-muted">Informations de l'exploitation</small>
                            </div>
                        </div>
                        
                        {% if organization %}
                        <form method="post" id="org-form">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="organization">
                            
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="form-label fw-bold">Nom de l'exploitation <span class="text-danger">*</span></label>
                                    <input type="text" name="org_name" class="form-control" value="{{ organization.name }}" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Devise</label>
                                    <select name="org_currency" class="form-select">
                                        <option value="EUR" {% if organization.currency == 'EUR' %}selected{% endif %}>EUR (€)</option>
                                        <option value="USD" {% if organization.currency == 'USD' %}selected{% endif %}>USD ($)</option>
                                        <option value="CHF" {% if organization.currency == 'CHF' %}selected{% endif %}>CHF</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">SIRET</label>
                                    <input type="text" name="org_siret" class="form-control" value="{{ organization.siret|default:'' }}" placeholder="14 chiffres (optionnel)" maxlength="14">
                                    <small class="text-muted">Optionnel - Numéro SIRET à 14 chiffres</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">N° TVA</label>
                                    <input type="text" name="org_tva" class="form-control" value="{{ organization.tva_number|default:'' }}" placeholder="FR12345678901 (optionnel)">
                                </div>
                                
                                <div class="col-12"><hr><h6 class="text-muted mb-3"><i class="bi bi-geo-alt me-2"></i>Adresse</h6></div>
                                
                                <div class="col-12">
                                    <label class="form-label">Adresse</label>
                                    <input type="text" name="org_address" class="form-control" value="{{ organization.address|default:'' }}" placeholder="Rue, numéro...">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Code postal</label>
                                    <input type="text" name="org_postal_code" class="form-control" value="{{ organization.postal_code|default:'' }}">
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label">Ville</label>
                                    <input type="text" name="org_city" class="form-control" value="{{ organization.city|default:'' }}">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Pays</label>
                                    <input type="text" name="org_country" class="form-control" value="{{ organization.country|default:'France' }}">
                                </div>
                            </div>
                            
                            <hr class="my-4">
                            
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-lg me-2"></i>Enregistrer
                                </button>
                            </div>
                        </form>
                        {% else %}
                        <div class="empty-state">
                            <i class="bi bi-building"></i>
                            <p>Aucune organisation associée</p>
                            <a href="{% url 'auth:create_organization' %}" class="btn btn-primary">
                                <i class="bi bi-plus-lg me-2"></i>Créer une organisation
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Section Équipe -->
                <div class="tab-pane fade" id="equipe">
                    <div class="account-section">
                        <div class="section-header">
                            <div class="section-icon team"><i class="bi bi-people-fill"></i></div>
                            <div class="flex-grow-1">
                                <h4 class="mb-0">Mon équipe</h4>
                                <small class="text-muted">Membres et invitations</small>
                            </div>
                            {% if can_manage_team %}
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#inviteModal">
                                <i class="bi bi-person-plus me-1"></i>Inviter
                            </button>
                            {% endif %}
                        </div>
                        
                        {% if members %}
                            <h6 class="text-muted mb-3">Membres ({{ members|length }})</h6>
                            {% for member in members %}
                            <div class="member-card">
                                <div class="member-avatar">
                                    {% if member.user.profile.get_avatar_url %}
                                        <img src="{{ member.user.profile.get_avatar_url }}" class="rounded-circle" style="width:100%;height:100%;object-fit:cover;">
                                    {% else %}
                                        {{ member.user.first_name|slice:":1"|upper }}{{ member.user.last_name|slice:":1"|upper }}
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">
                                        {{ member.user.get_full_name|default:member.user.email }}
                                        {% if member.user == user %}<span class="text-muted">(vous)</span>{% endif %}
                                    </div>
                                    <small class="text-muted">{{ member.user.email }}</small>
                                </div>
                                <span class="role-badge role-{{ member.role }}">
                                    {% if member.role == 'owner' %}Propriétaire
                                    {% elif member.role == 'admin' %}Admin
                                    {% else %}Membre{% endif %}
                                </span>
                                {% if can_manage_team and member.user != user and member.role != 'owner' %}
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#" data-member-id="{{ member.id }}" data-action="change-role">Changer le rôle</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" data-member-id="{{ member.id }}" data-action="remove">Retirer</a></li>
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                            
                            {% if pending_invitations %}
                            <h6 class="text-muted mb-3 mt-4">Invitations en attente ({{ pending_invitations|length }})</h6>
                            {% for inv in pending_invitations %}
                            <div class="member-card bg-warning bg-opacity-10">
                                <div class="member-avatar bg-warning text-white">
                                    <i class="bi bi-envelope"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">{{ inv.email }}</div>
                                    <small class="text-muted">Invité le {{ inv.created_at|date:"d/m/Y" }}</small>
                                </div>
                                <span class="badge bg-warning text-dark">En attente</span>
                                {% if can_manage_team %}
                                <button class="btn btn-sm btn-outline-danger" title="Annuler">
                                    <i class="bi bi-x"></i>
                                </button>
                                {% endif %}
                            </div>
                            {% endfor %}
                            {% endif %}
                        {% else %}
                            <div class="empty-state">
                                <i class="bi bi-people"></i>
                                <p>Vous êtes le seul membre</p>
                                {% if can_manage_team %}
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inviteModal">
                                    <i class="bi bi-person-plus me-2"></i>Inviter un collaborateur
                                </button>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Section Préférences -->
                <div class="tab-pane fade" id="preferences">
                    <div class="account-section">
                        <div class="section-header">
                            <div class="section-icon prefs"><i class="bi bi-gear-fill"></i></div>
                            <div>
                                <h4 class="mb-0">Préférences</h4>
                                <small class="text-muted">Paramètres d'affichage personnels</small>
                            </div>
                        </div>
                        
                        <form method="post" id="prefs-form">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="preferences">
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Langue</label>
                                    <select name="locale" class="form-select">
                                        <option value="fr" {% if profile.locale == 'fr' %}selected{% endif %}>Français</option>
                                        <option value="en" {% if profile.locale == 'en' %}selected{% endif %}>English</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Fuseau horaire</label>
                                    <select name="timezone" class="form-select">
                                        <option value="">-- Non défini --</option>
                                        <option value="Europe/Paris" {% if profile.timezone == 'Europe/Paris' %}selected{% endif %}>Europe/Paris (France)</option>
                                        <option value="Europe/Brussels" {% if profile.timezone == 'Europe/Brussels' %}selected{% endif %}>Europe/Brussels (Belgique)</option>
                                        <option value="Europe/Zurich" {% if profile.timezone == 'Europe/Zurich' %}selected{% endif %}>Europe/Zurich (Suisse)</option>
                                        <option value="America/Montreal" {% if profile.timezone == 'America/Montreal' %}selected{% endif %}>America/Montreal (Québec)</option>
                                    </select>
                                    <small class="text-muted">Optionnel - Pour l'affichage des dates</small>
                                </div>
                            </div>
                            
                            <hr class="my-4">
                            
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-lg me-2"></i>Enregistrer
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Invitation -->
<div class="modal fade" id="inviteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="invite">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Inviter un collaborateur</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Email</label>
                        <input type="email" name="invite_email" class="form-control" required placeholder="collaborateur@email.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Rôle</label>
                        <select name="invite_role" class="form-select">
                            <option value="member">Membre - Accès en lecture/écriture</option>
                            <option value="admin">Admin - Peut gérer l'équipe</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send me-2"></i>Envoyer l'invitation
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Changement mot de passe -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="password">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-key me-2"></i>Changer le mot de passe</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Mot de passe actuel</label>
                        <input type="password" name="current_password" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Nouveau mot de passe</label>
                        <input type="password" name="new_password" class="form-control" required minlength="8">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Confirmer le nouveau mot de passe</label>
                        <input type="password" name="confirm_password" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-2"></i>Changer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Prévisualisation avatar
    const avatarInput = document.getElementById('id_avatar');
    const avatarPreview = document.getElementById('avatar-preview');
    
    if (avatarInput) {
        avatarInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (avatarPreview.tagName === 'IMG') {
                        avatarPreview.src = e.target.result;
                    } else {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = 'Avatar';
                        img.id = 'avatar-preview';
                        avatarPreview.parentNode.replaceChild(img, avatarPreview);
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Navigation par hash
    const hash = window.location.hash;
    if (hash) {
        const tab = document.querySelector(`[href="${hash}"]`);
        if (tab) {
            tab.click();
        }
    }
    
    // Update hash on tab change
    document.querySelectorAll('.account-nav .nav-link').forEach(link => {
        link.addEventListener('click', function() {
            history.pushState(null, '', this.getAttribute('href'));
        });
    });
});
</script>
{% endblock %}
