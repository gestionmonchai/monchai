{% extends 'production/base_production.html' %}
{% load static %}
{% block title %}Nouvelle mise — Étape 3{% endblock %}
{% block production_content %}
<h1 class="h4 mb-3">Nouvelle mise — Étape 3: Récapitulatif</h1>

<div class="row g-3">
  <div class="col-lg-8">
    <div class="card mb-3">
      <div class="card-header">Analyses & Pré-mise</div>
      <div class="card-body">
        <div class="d-flex flex-wrap gap-3 align-items-center">
          <div>Analyses: <span id="badge-analyses" class="badge text-bg-secondary">—</span></div>
          <div>Statut prêts mise: <span id="badge-pret" class="badge text-bg-secondary">—</span></div>
          <div class="text-muted small" id="missing-list"></div>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header">Coûts estimés</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">CMP vrac estimé (€/L)</label>
            <div id="cmp-vrac" class="form-control-plaintext">—</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">MO mise (€/u)</label>
            <input id="mo-eur-u" type="number" step="0.0001" class="form-control" placeholder="0.0000">
          </div>
          <div class="col-md-4">
            <label class="form-label">Coût unitaire estimé (€/u)</label>
            <div id="cout-u" class="form-control-plaintext">—</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Validation</div>
      <div class="card-body">
        <form method="post" id="form-final">
          {% csrf_token %}
          <input type="hidden" name="step" value="3">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Cuvée cible (optionnel)</label>
              <input type="text" name="cuvee_id" class="form-control" placeholder="UUID cuvée (optionnel)">
            </div>
            <div class="col-md-6">
              <label class="form-label">MO mise total (EUR)</label>
              <input type="number" name="mo_eur" class="form-control" step="0.01" placeholder="0.00">
            </div>
            <div class="col-12" id="override-block" style="display:none;">
              <label class="form-label">Justification override (requis si non prêt mise / analyses manquantes)</label>
              <textarea name="override_justification" class="form-control" rows="3" placeholder="Expliquer la dérogation (min 12 caractères)"></textarea>
            </div>
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="chk-confirm" name="confirmer">
                <label class="form-check-label" for="chk-confirm">Je confirme la création de la mise et des lots commerciaux</label>
              </div>
            </div>
          </div>
          <div class="mt-3 d-flex justify-content-between">
            <a href="?step=2" class="btn btn-outline-secondary">Retour Étape 2</a>
            <button id="btn-submit" class="btn btn-primary" disabled>Valider la mise & créer le tirage</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card">
      <div class="card-header">Messages</div>
      <div class="card-body">
        <div id="msg-zone" class="small text-muted">Prévisualisation en cours…</div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  function getCookie(name){ const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m?m.pop():''; }
  const csrftoken = getCookie('csrftoken');
  const badgeAnalyses = document.getElementById('badge-analyses');
  const badgePret = document.getElementById('badge-pret');
  const missingList = document.getElementById('missing-list');
  const overrideBlock = document.getElementById('override-block');
  const btnSubmit = document.getElementById('btn-submit');
  const chkConfirm = document.getElementById('chk-confirm');
  const cmpVrac = document.getElementById('cmp-vrac');
  const coutU = document.getElementById('cout-u');
  const moEurU = document.getElementById('mo-eur-u');
  const msg = document.getElementById('msg-zone');

  async function preview(){
    const fd = new FormData();
    fd.append('mo_eur_u', moEurU.value||'0');
    const resp = await fetch('{% url "production:mise_validate_preview" %}', {
      method:'POST', headers:{'X-CSRFToken': csrftoken}, body: fd, credentials:'same-origin'
    });
    const data = await resp.json();
    // badges
    badgeAnalyses.className = 'badge ' + (data.analyses_ok? 'text-bg-success':'text-bg-danger');
    badgeAnalyses.textContent = data.analyses_ok? '✓ OK' : '✗ Manquantes';
    badgePret.className = 'badge ' + (data.pret_mise_ok? 'text-bg-success':'text-bg-danger');
    badgePret.textContent = data.pret_mise_ok? '✓ OK' : '✗ Non prêt';
    missingList.textContent = (data.missing||[]).length? ('Manquants: ' + data.missing.join(', ')) : '';
    // costs
    cmpVrac.textContent = data.cmp_vrac_eur_l || '0.0000';
    coutU.textContent = data.cout_unitaire_estime_eur_u || '0.0000';
    // override
    overrideBlock.style.display = (data.override_allowed? 'block':'none');
    // guidance
    if(!data.analyses_ok || !data.pret_mise_ok){
      msg.textContent = 'Override possible: fournir une justification et cocher la confirmation.';
    } else {
      msg.textContent = 'Tout est prêt. Vous pouvez confirmer la mise.';
    }
    updateSubmitState();
  }

  function updateSubmitState(){
    const needOverride = overrideBlock.style.display !== 'none';
    const justification = document.querySelector('textarea[name="override_justification"]').value || '';
    const okJustif = !needOverride || justification.length >= 12;
    if(chkConfirm.checked && okJustif){ btnSubmit.disabled = false; } else { btnSubmit.disabled = true; }
  }

  moEurU.addEventListener('input', debounce(preview, 200));
  chkConfirm.addEventListener('change', updateSubmitState);
  document.querySelector('textarea[name="override_justification"]').addEventListener('input', updateSubmitState);

  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,a), ms); } }

  preview();
})();
</script>
{% endblock %}
