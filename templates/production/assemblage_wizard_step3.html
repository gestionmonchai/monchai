{% extends 'production/base_production.html' %}
{% block title %}Assemblage – Étape 3{% endblock %}
{% block production_content %}
<h1 class="h4 mb-3">Assemblage – Étape 3/3: Cible</h1>
{% if error %}<div class="alert alert-danger">{{ error }}</div>{% endif %}
<form method="post" action="/production/assemblages/nouveau/">
  {% csrf_token %}
  <input type="hidden" name="step" value="3">
  <input type="hidden" name="asm_token" value="{{ asm_token }}">

  <div class="card mb-3">
    <div class="card-header">Cible</div>
    <div class="card-body">
      <div class="form-check mb-2">
        <input class="form-check-input" type="radio" name="target_mode" id="tm_new" value="new" checked>
        <label class="form-check-label" for="tm_new">Créer un nouveau lot</label>
      </div>
      <div class="row g-3 ms-3 mb-3" id="target_new_block">
        <div class="col-md-6">
          <label class="form-label">Cuvée</label>
          <select class="form-select" name="cuvee_id">
            <option value="">— Sélectionner une cuvée —</option>
            {% for c in cuvees %}
            <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Contenant</label>
          <input class="form-control" type="text" name="contenant" placeholder="Cuve assemblage">
        </div>
      </div>

      <div class="form-check mb-2">
        <input class="form-check-input" type="radio" name="target_mode" id="tm_existing" value="existing">
        <label class="form-check-label" for="tm_existing">Ajouter à un lot existant</label>
      </div>
      <div class="row g-3 ms-3" id="target_existing_block" style="display:none;">
        <div class="col-md-8">
          <label class="form-label">Lot cible</label>
          <select class="form-select" name="target_id">
            <option value="">— Sélectionner un lot —</option>
            {% for l in target_lots %}
            <option value="{{ l.id }}">{{ l.code }} ({{ l.campagne }})</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex gap-2">
    <a href="/production/assemblages/nouveau/?step=2" class="btn btn-secondary">Retour</a>
    <button class="btn btn-primary" type="submit">Valider l'assemblage</button>
  </div>
</form>

<script>
(function(){
  const tmNew = document.getElementById('tm_new');
  const tmExist = document.getElementById('tm_existing');
  const blockNew = document.getElementById('target_new_block');
  const blockExist = document.getElementById('target_existing_block');
  function sync(){
    if (tmNew.checked){ blockNew.style.display='flex'; blockExist.style.display='none'; }
    else { blockNew.style.display='none'; blockExist.style.display='flex'; }
  }
  tmNew.addEventListener('change', sync);
  tmExist.addEventListener('change', sync);
  sync();
})();
</script>
{% endblock %}
