{% extends 'production/base_production.html' %}
{% block title %}{{ page_title }} - Mon Chai{% endblock %}

{% block production_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 mb-1">{{ page_title }}</h1>
    {% if lot_prefill %}
    <p class="text-muted mb-0">
      <i class="bi bi-box me-1"></i>
      {{ lot_prefill.code }} — {{ lot_prefill.cuvee.nom|default:"Sans cuvée" }} — {{ lot_prefill.volume_l }} L
    </p>
    {% endif %}
  </div>
  <a href="{% url 'production:analyses_oeno_list' %}" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left me-1"></i>Retour à la liste
  </a>
</div>

<form method="post" novalidate>
  {% csrf_token %}
  
  <!-- Légende et aide -->
  <div class="alert alert-light border mb-3 py-2">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <span class="text-danger">*</span> = champ obligatoire
        <span class="text-muted ms-3">|</span>
        <span class="text-muted ms-3 small">Tous les autres champs sont optionnels</span>
      </div>
      <div class="small text-muted">
        <i class="bi bi-info-circle me-1"></i>
        Les alertes sont calculées automatiquement selon les seuils (SO₂, pH, acidité volatile)
      </div>
    </div>
  </div>
  
  {% if form.errors %}
  <div class="alert alert-danger mb-3">
    <strong><i class="bi bi-exclamation-triangle me-1"></i>Erreurs de validation :</strong>
    <ul class="mb-0 mt-2">
      {% for field in form %}
        {% for error in field.errors %}
          <li><strong>{{ field.label }}</strong> : {{ error }}</li>
        {% endfor %}
      {% endfor %}
      {% for error in form.non_field_errors %}
        <li>{{ error }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
  
  <!-- Bloc A: Contexte de l'analyse -->
  <div class="card mb-3">
    <div class="card-header">
      <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Contexte de l'analyse</h6>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label for="id_lot" class="form-label">Lot en élevage <span class="text-danger">*</span></label>
          {{ form.lot }}
          {% if form.lot.errors %}
            <div class="invalid-feedback d-block">{{ form.lot.errors.0 }}</div>
          {% endif %}
        </div>
        <div class="col-md-2">
          <label for="id_date" class="form-label">Date d'analyse <span class="text-danger">*</span></label>
          {{ form.date }}
          {% if form.date.errors %}
            <div class="invalid-feedback d-block">{{ form.date.errors.0 }}</div>
          {% endif %}
        </div>
        <div class="col-md-3">
          <label for="id_type_analyse" class="form-label">Type d'analyse <span class="text-danger">*</span></label>
          {{ form.type_analyse }}
        </div>
        <div class="col-md-3">
          <label for="id_statut" class="form-label">Statut <span class="text-danger">*</span></label>
          {{ form.statut }}
        </div>
      </div>
      
      <div class="row g-3 mt-1">
        <div class="col-md-4">
          <label class="form-label">Origine des résultats</label>
          <div class="d-flex gap-4">
            {% for radio in form.origine %}
              <div class="form-check">
                {{ radio.tag }}
                <label class="form-check-label" for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
              </div>
            {% endfor %}
          </div>
        </div>
        <div class="col-md-4" id="labo-externe-wrapper">
          <label for="id_labo_externe_nom" class="form-label">Nom du laboratoire externe</label>
          {{ form.labo_externe_nom }}
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bloc B: Résultats analytiques -->
  <div class="card mb-3">
    <div class="card-header">
      <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Résultats analytiques</h6>
    </div>
    <div class="card-body">
      
      <!-- Sous-bloc B1: Structure & Acidité -->
      <div class="accordion" id="accordionResultats">
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseStructure">
              <i class="bi bi-droplet-half me-2"></i>Structure & Acidité
            </button>
          </h2>
          <div id="collapseStructure" class="accordion-collapse collapse show">
            <div class="accordion-body">
              <div class="row g-3">
                <div class="col-md-2">
                  <label class="form-label">Densité</label>
                  {{ form.densite }}
                  <small class="text-muted">à 20°C</small>
                </div>
                <div class="col-md-2">
                  <label class="form-label">TAV</label>
                  {{ form.tav }}
                  <small class="text-muted">% vol</small>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Sucres résiduels</label>
                  {{ form.sucres_residuels }}
                  <small class="text-muted">g/L</small>
                </div>
                <div class="col-md-2">
                  <label class="form-label">pH</label>
                  {{ form.ph }}
                  {% if form.ph.errors %}
                    <div class="invalid-feedback d-block">{{ form.ph.errors.0 }}</div>
                  {% endif %}
                </div>
                <div class="col-md-2">
                  <label class="form-label">Acidité totale</label>
                  {{ form.acidite_totale }}
                  <small class="text-muted">g/L H₂SO₄</small>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Acidité volatile</label>
                  {{ form.acidite_volatile }}
                  <small class="text-muted">g/L H₂SO₄</small>
                </div>
              </div>
              <div class="row g-3 mt-1">
                <div class="col-md-2">
                  <label class="form-label">Acide malique</label>
                  {{ form.acide_malique }}
                  <small class="text-muted">g/L</small>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Acide lactique</label>
                  {{ form.acide_lactique }}
                  <small class="text-muted">g/L</small>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Sous-bloc B2: SO₂ & Oxydation -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSO2">
              <i class="bi bi-shield-check me-2"></i>SO₂ & Oxydation
            </button>
          </h2>
          <div id="collapseSO2" class="accordion-collapse collapse show">
            <div class="accordion-body">
              <div class="row g-3">
                <div class="col-md-2">
                  <label class="form-label">SO₂ libre</label>
                  {{ form.so2_libre }}
                  <small class="text-muted">mg/L</small>
                </div>
                <div class="col-md-2">
                  <label class="form-label">SO₂ total</label>
                  {{ form.so2_total }}
                  <small class="text-muted">mg/L</small>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Potentiel redox</label>
                  {{ form.potentiel_redox }}
                  <small class="text-muted">mV</small>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Commentaire SO₂</label>
                  {{ form.so2_commentaire }}
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Sous-bloc B3: Autres paramètres -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAutres">
              <i class="bi bi-sliders me-2"></i>Autres paramètres (optionnel)
            </button>
          </h2>
          <div id="collapseAutres" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="row g-3">
                <div class="col-md-2">
                  <label class="form-label">Azote assim.</label>
                  {{ form.azote_assimilable }}
                  <small class="text-muted">mg/L</small>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Turbidité</label>
                  {{ form.turbidite }}
                  <small class="text-muted">NTU</small>
                </div>
                <div class="col-md-2">
                  <label class="form-label">DO 420nm</label>
                  {{ form.couleur_do420 }}
                </div>
                <div class="col-md-2">
                  <label class="form-label">DO 520nm</label>
                  {{ form.couleur_do520 }}
                </div>
                <div class="col-md-2">
                  <label class="form-label">DO 620nm</label>
                  {{ form.couleur_do620 }}
                </div>
                <div class="col-md-2">
                  <label class="form-label">IPT</label>
                  {{ form.ipt }}
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Sous-bloc B4: Appréciation -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAppreciation">
              <i class="bi bi-star me-2"></i>Appréciation interne
            </button>
          </h2>
          <div id="collapseAppreciation" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="row g-3">
                <div class="col-md-2">
                  <label class="form-label">Note globale</label>
                  {{ form.note_globale }}
                </div>
                <div class="col-md-5">
                  <label class="form-label">Notes de dégustation</label>
                  {{ form.notes_degustation }}
                </div>
                <div class="col-md-5">
                  <label class="form-label">Commentaires internes</label>
                  {{ form.commentaires_internes }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bloc C: Statut & Alertes -->
  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h6 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Alertes & Suivi</h6>
      <span class="badge bg-light text-muted border">Optionnel</span>
    </div>
    <div class="card-body">
      <!-- Info sur le calcul automatique -->
      <div class="alert alert-info py-2 mb-3">
        <small>
          <i class="bi bi-robot me-1"></i>
          <strong>Calcul automatique :</strong> Une alerte sera automatiquement déclenchée si :
          <ul class="mb-0 mt-1">
            <li>SO₂ libre &lt; 15 mg/L (surveillance &lt; 20)</li>
            <li>Acidité volatile &gt; 0.7 g/L (surveillance &gt; 0.5)</li>
            <li>pH &lt; 2.9 ou &gt; 3.8 (surveillance &lt; 3.1 ou &gt; 3.6)</li>
          </ul>
        </small>
      </div>
      
      <div class="row g-3">
        <div class="col-12">
          <div class="form-check">
            {{ form.alerte_declenchee }}
            <label class="form-check-label fw-medium" for="id_alerte_declenchee">
              Déclencher une alerte manuellement (prioritaire sur le calcul automatique)
            </label>
          </div>
        </div>
      </div>
      
      <div id="alerte-details" class="mt-3" style="display: none;">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Type d'alerte</label>
            {{ form.alerte_type }}
            {% if form.alerte_type.errors %}
              <div class="invalid-feedback d-block">{{ form.alerte_type.errors.0 }}</div>
            {% endif %}
          </div>
          <div class="col-md-5">
            <label class="form-label">Description de l'alerte</label>
            {{ form.alerte_description }}
          </div>
          <div class="col-md-4">
            <label class="form-label">Recommandation de suivi</label>
            {{ form.alerte_recommandation }}
          </div>
        </div>
        <div class="row g-3 mt-1">
          <div class="col-md-3">
            <label class="form-label">Date prochaine analyse recommandée</label>
            {{ form.prochaine_analyse_date }}
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Boutons d'action -->
  <div class="d-flex justify-content-between">
    <a href="{% url 'production:analyses_oeno_list' %}" class="btn btn-link text-muted">Annuler</a>
    <div class="btn-group">
      {% if not is_edit %}
      <button type="submit" name="save_and_new" class="btn btn-outline-primary">
        <i class="bi bi-plus me-1"></i>Enregistrer et créer une autre
      </button>
      {% endif %}
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-check-lg me-1"></i>
        {% if is_edit %}Enregistrer les modifications{% else %}Enregistrer{% endif %}
      </button>
    </div>
  </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Afficher/masquer le champ labo externe selon l'origine
  const origineRadios = document.querySelectorAll('input[name="origine"]');
  const laboWrapper = document.getElementById('labo-externe-wrapper');
  
  function toggleLaboExterne() {
    const selected = document.querySelector('input[name="origine"]:checked');
    if (selected && selected.value === 'externe') {
      laboWrapper.style.display = 'block';
    } else {
      laboWrapper.style.display = 'none';
    }
  }
  
  origineRadios.forEach(function(radio) {
    radio.addEventListener('change', toggleLaboExterne);
  });
  toggleLaboExterne();
  
  // Afficher/masquer les détails d'alerte
  const alerteCheckbox = document.getElementById('id_alerte_declenchee');
  const alerteDetails = document.getElementById('alerte-details');
  
  function toggleAlerteDetails() {
    if (alerteCheckbox && alerteCheckbox.checked) {
      alerteDetails.style.display = 'block';
    } else {
      alerteDetails.style.display = 'none';
    }
  }
  
  if (alerteCheckbox) {
    alerteCheckbox.addEventListener('change', toggleAlerteDetails);
    toggleAlerteDetails();
  }
});
</script>
{% endblock %}
