{% extends 'production/base_production.html' %}
{% block title %}Lot {{ lot.code }} - Mon Chai{% endblock %}

{% block production_content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb mb-0">
    <li class="breadcrumb-item"><a href="{% url 'production:production_home' %}" class="text-decoration-none">Production</a></li>
    <li class="breadcrumb-item"><a href="{% url 'production:lots_tech_list' %}" class="text-decoration-none">Lots techniques</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ lot.code }}</li>
  </ol>
</nav>

<!-- Header avec badges -->
<div class="d-flex justify-content-between align-items-start mb-3">
  <h1 class="h4 mb-0 d-flex align-items-center gap-2 flex-wrap">
    <span>Lot technique</span>
    <span class="badge bg-dark">{{ lot.code }}</span>
    <span class="badge bg-light text-dark">{{ lot.campagne }}</span>
    <span class="badge {% if lot.statut == 'en_cours' or lot.statut == 'VIN_EN_FA' or lot.statut == 'VIN_EN_FML' %}bg-warning text-dark{% elif lot.statut == 'pret_mise' or lot.statut == 'VIN_PRET_MISE' %}bg-success{% elif lot.statut == 'epuise' %}bg-secondary{% else %}bg-primary{% endif %}">
      {{ lot.get_statut_display }}
    </span>
    {% if lot.location_kind == 'OFFSITE' %}
      <span class="badge bg-warning text-dark"><i class="bi bi-geo-alt me-1"></i>Hors site</span>
    {% endif %}
    {% if lot.cuvee %}
      <span class="badge bg-info text-dark"><i class="bi bi-cup-straw me-1"></i>{{ lot.cuvee.nom }}</span>
    {% endif %}
  </h1>
  <div class="d-flex gap-2">
    {% if lot.statut == 'pret_mise' or lot.statut == 'VIN_PRET_MISE' %}
    <a href="{% url 'produits:product_new' %}?source_lot={{ lot.pk }}" class="btn btn-success btn-sm">
      <i class="bi bi-box-seam me-1"></i>Créer produit
    </a>
    {% endif %}
    <div class="btn-group">
      <a href="{% url 'production:lot_tech_affecter_cuvee' pk=lot.pk %}" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-pencil me-1"></i>Modifier
      </a>
      <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown">
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item" href="{% url 'production:lots_elevage_journal' %}?lot={{ lot.code }}"><i class="bi bi-journal-text me-2"></i>Journal vrac</a></li>
        <li><a class="dropdown-item" href="{% url 'production:lot_mouvements_export' pk=lot.pk %}"><i class="bi bi-download me-2"></i>Exporter mouvements</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="{% url 'produits:product_new' %}?source_lot={{ lot.pk }}"><i class="bi bi-box-seam me-2"></i>Créer un produit</a></li>
      </ul>
    </div>
  </div>
</div>

<div class="row g-3">
  <!-- Colonne principale -->
  <div class="col-lg-8">
    
    <!-- Card: Identité & volumes -->
    <div class="card mb-3">
      <div class="card-header fw-semibold"><i class="bi bi-box-seam me-2"></i>Identité & Volumes</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <div class="text-muted small">Volume net</div>
            <div class="fs-5 fw-bold text-primary">{{ volume_net_calc|default:lot.volume_l|floatformat:0 }} L</div>
            <div class="text-muted small">{% widthratio volume_net_calc|default:lot.volume_l 100 1 %} hL</div>
          </div>
          <div class="col-md-3">
            <div class="text-muted small">Volume @20°C</div>
            {% if lot.volume_hl20 %}
            <div>{{ lot.volume_hl20|floatformat:2 }} hL</div>
            <div class="text-muted small">{% widthratio lot.volume_hl20 1 100 %} L</div>
            {% else %}—{% endif %}
          </div>
          <div class="col-md-3">
            <div class="text-muted small">Contenant</div>
            <div>{{ lot.contenant|default:"—" }}</div>
          </div>
          <div class="col-md-3">
            <div class="text-muted small">Source vendange</div>
            <div>
              {% if lot.source %}
                <a href="{% url 'production:vendange_detail' pk=lot.source.pk %}">{{ lot.source.code }}</a>
              {% else %}—{% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card: Paramètres analytiques -->
    <div class="card mb-3">
      <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
        <span><i class="bi bi-graph-up me-2"></i>Paramètres analytiques</span>
        {% if param_alerts %}
          <span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle me-1"></i>Alertes</span>
        {% endif %}
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-2">
            <div class="text-muted small">Densité</div>
            <div class="fw-semibold">{{ latest_densite|default:"—" }}</div>
          </div>
          <div class="col-md-2">
            <div class="text-muted small">TAV (%)</div>
            <div class="fw-semibold">{% if abv_pct %}{{ abv_pct }}%{% else %}—{% endif %}</div>
          </div>
          <div class="col-md-2">
            <div class="text-muted small">pH</div>
            <div class="fw-semibold">{{ latest_ph|default:"—" }}</div>
          </div>
          <div class="col-md-3">
            <div class="text-muted small">État technique</div>
            <div>{{ etat_technique|default:"—" }}</div>
          </div>
          <div class="col-md-3">
            <div class="text-muted small">Dernier soutirage</div>
            <div>{% if last_transfer_soutirage %}{{ last_transfer_soutirage|date:"d/m/Y" }}{% else %}—{% endif %}</div>
          </div>
        </div>
        
        <!-- Dernières mesures -->
        {% if vinif_measurements %}
        <hr class="my-3">
        <h6 class="text-muted mb-2">Dernières mesures</h6>
        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Valeur</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
              {% for m in vinif_measurements|slice:":5" %}
              <tr>
                <td>{{ m.date|date:"d/m/Y H:i" }}</td>
                <td>{{ m.get_type_display }}</td>
                <td class="fw-semibold">{{ m.value }} {{ m.unit }}</td>
                <td class="text-muted small">{{ m.notes|default:"—" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Card: Interventions -->
    <div class="card mb-3">
      <div class="card-header fw-semibold"><i class="bi bi-wrench me-2"></i>Interventions récentes</div>
      <div class="card-body p-0">
        {% if vinif_interventions %}
        <table class="table table-sm table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Notes</th>
              <th class="text-end">Volume sortie</th>
            </tr>
          </thead>
          <tbody>
            {% for itv in vinif_interventions|slice:":8" %}
            <tr>
              <td>{{ itv.date|date:"d/m/Y" }}</td>
              <td><span class="badge bg-light text-dark">{{ itv.get_type_display }}</span></td>
              <td class="text-muted small">{{ itv.notes|default:"—" }}</td>
              <td class="text-end">{% if itv.volume_out_l %}<span class="text-danger">-{{ itv.volume_out_l }} L</span>{% else %}—{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="p-3 text-center text-muted">
          <i class="bi bi-info-circle me-1"></i>Aucune intervention enregistrée
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Card: Origine & Traçabilité -->
    <div class="card mb-3">
      <div class="card-header fw-semibold"><i class="bi bi-diagram-3 me-2"></i>Origine & Traçabilité</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <h6 class="text-muted mb-2">Parents (provenance)</h6>
            {% if lineage_parents %}
            <ul class="list-group list-group-flush">
              {% for ln in lineage_parents %}
              <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                <span>
                  {% if ln.parent_lot %}
                    <a href="{% url 'production:lot_tech_detail' pk=ln.parent_lot.pk %}">{{ ln.parent_lot.code }}</a>
                  {% else %}—{% endif %}
                  <span class="text-muted small ms-2">({{ ln.operation.get_kind_display }} · {{ ln.operation.date|date:"d/m/Y" }})</span>
                </span>
                {% if ln.ratio %}<span class="badge bg-light text-dark">{{ ln.ratio|floatformat:0 }}%</span>{% endif %}
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <div class="text-muted small">Aucun parent (lot source)</div>
            {% endif %}
          </div>
          <div class="col-md-6">
            <h6 class="text-muted mb-2">Enfants (destination)</h6>
            {% if lineage_children %}
            <ul class="list-group list-group-flush">
              {% for ln in lineage_children %}
              <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                <span>
                  <a href="{% url 'production:lot_tech_detail' pk=ln.child_lot.pk %}">{{ ln.child_lot.code }}</a>
                  <span class="text-muted small ms-2">({{ ln.operation.get_kind_display }} · {{ ln.operation.date|date:"d/m/Y" }})</span>
                </span>
                {% if ln.ratio %}<span class="badge bg-light text-dark">{{ ln.ratio|floatformat:0 }}%</span>{% endif %}
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <div class="text-muted small">Aucun enfant</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Card: Mouvements -->
    <div class="card mb-3">
      <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
        <span><i class="bi bi-arrow-left-right me-2"></i>Historique mouvements</span>
        <a href="{% url 'production:lot_mouvements_export' pk=lot.pk %}" class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-download me-1"></i>Exporter
        </a>
      </div>
      <div class="card-body p-0">
        {% if mouvements %}
        <table class="table table-sm table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th class="text-end">Volume</th>
              <th>Détails</th>
            </tr>
          </thead>
          <tbody>
            {% for mv in mouvements|slice:":10" %}
            <tr>
              <td>{{ mv.date|date:"d/m/Y H:i" }}</td>
              <td>{{ mv.type }}</td>
              <td class="text-end {% if mv.volume_l < 0 %}text-danger{% else %}text-success{% endif %}">
                {% if mv.volume_l > 0 %}+{% endif %}{{ mv.volume_l }} L
              </td>
              <td class="text-muted small text-truncate" style="max-width: 200px;">{{ mv.meta|default:"—" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="p-3 text-center text-muted">Aucun mouvement</div>
        {% endif %}
      </div>
    </div>

  </div>

  <!-- Colonne latérale -->
  <div class="col-lg-4">
    
    <!-- Prochaine étape -->
    {% if next_step %}
    <div class="card mb-3 border-primary">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <div class="small text-muted">Prochaine étape</div>
          <div class="fw-semibold">{{ next_step.label }}</div>
        </div>
        <a href="{{ next_step.url }}" class="btn btn-primary">Continuer</a>
      </div>
    </div>
    {% endif %}

    <!-- Changement de statut -->
    <div class="card mb-3 border-success">
      <div class="card-header fw-semibold bg-success bg-opacity-10">
        <i class="bi bi-signpost-2 me-2"></i>Changer le statut
      </div>
      <div class="card-body">
        <form method="post" action="{% url 'production:lot_tech_action' pk=lot.pk action='change_status' %}">
          {% csrf_token %}
          <select name="new_status" class="form-select mb-2" onchange="this.form.submit()">
            <option value="">— Sélectionner le nouveau statut —</option>
            <optgroup label="Vinification">
              <option value="MOUT_ENCUVE" {% if lot.statut == 'MOUT_ENCUVE' %}selected{% endif %}>Moût encuvé</option>
              <option value="MOUT_PRESSE" {% if lot.statut == 'MOUT_PRESSE' %}selected{% endif %}>Moût de presse</option>
              <option value="MOUT_DEBOURBE" {% if lot.statut == 'MOUT_DEBOURBE' %}selected{% endif %}>Moût débourbé</option>
              <option value="VIN_EN_FA" {% if lot.statut == 'VIN_EN_FA' %}selected{% endif %}>Vin en FA</option>
              <option value="VIN_POST_FA" {% if lot.statut == 'VIN_POST_FA' %}selected{% endif %}>Vin post-FA</option>
              <option value="VIN_EN_FML" {% if lot.statut == 'VIN_EN_FML' %}selected{% endif %}>Vin en FML</option>
              <option value="VIN_POST_FML" {% if lot.statut == 'VIN_POST_FML' %}selected{% endif %}>Vin post-FML</option>
            </optgroup>
            <optgroup label="Élevage & Stabilisation">
              <option value="VIN_ELEVAGE" {% if lot.statut == 'VIN_ELEVAGE' %}selected{% endif %}>Vin en élevage</option>
              <option value="VIN_STABILISE" {% if lot.statut == 'VIN_STABILISE' %}selected{% endif %}>Vin stabilisé</option>
              <option value="VIN_FILTRATION_STERILE" {% if lot.statut == 'VIN_FILTRATION_STERILE' %}selected{% endif %}>Vin filtré stérile</option>
              <option value="VIN_PRET_MISE" {% if lot.statut == 'VIN_PRET_MISE' %}selected{% endif %}>Vin prêt mise</option>
            </optgroup>
            <optgroup label="Conditionnement">
              <option value="pret_mise" {% if lot.statut == 'pret_mise' %}selected{% endif %}>Prêt mise</option>
              <option value="conditionne_partiel" {% if lot.statut == 'conditionne_partiel' %}selected{% endif %}>Conditionné partiel</option>
              <option value="epuise" {% if lot.statut == 'epuise' %}selected{% endif %}>Épuisé</option>
            </optgroup>
          </select>
        </form>
        <div class="small text-muted">Statut actuel : <strong>{{ lot.get_statut_display }}</strong></div>
      </div>
    </div>

    <!-- Actions rapides -->
    <div class="card mb-3">
      <div class="card-header fw-semibold">Actions</div>
      <div class="card-body d-grid gap-2">
        <a href="{% url 'production:mise_new' %}?lot={{ lot.id }}" class="btn btn-primary">
          <i class="bi bi-box-seam me-2"></i>Planifier une mise
        </a>
        <a href="{% url 'production:assemblage_wizard' %}?source={{ lot.id }}" class="btn btn-outline-primary">
          <i class="bi bi-layers me-2"></i>Créer un assemblage
        </a>
        <a href="{% url 'production:analyse_oeno_new' %}?lot={{ lot.id }}" class="btn btn-outline-secondary">
          <i class="bi bi-droplet me-2"></i>Nouvelle analyse
        </a>
      </div>
    </div>

    <!-- Affectation cuvée -->
    <div class="card mb-3">
      <div class="card-header fw-semibold">Affectation cuvée</div>
      <div class="card-body">
        <form method="post" action="{% url 'production:lot_tech_affecter_cuvee' pk=lot.pk %}">
          {% csrf_token %}
          <div class="mb-2">
            <select class="form-select" name="cuvee_id" required>
              <option value="">— Sélectionner une cuvée —</option>
              {% for c in cuvees %}
                <option value="{{ c.id }}" {% if lot.cuvee and lot.cuvee.id == c.id %}selected{% endif %}>{{ c.nom }}</option>
              {% endfor %}
            </select>
          </div>
          <button class="btn btn-outline-primary w-100" type="submit">Affecter</button>
        </form>
      </div>
    </div>

    <!-- Déclarations rapides -->
    <div class="card mb-3">
      <div class="card-header fw-semibold">Déclarations rapides</div>
      <div class="card-body">
        <!-- Mesure -->
        <form method="post" action="{% url 'production:lot_vinif_add_measure' pk=lot.pk %}" class="mb-3">
          {% csrf_token %}
          <div class="fw-medium mb-2 small">Ajouter une mesure</div>
          <div class="row g-2 mb-2">
            <div class="col-6">
              <select name="type" class="form-select form-select-sm">
                <option value="temperature">Température (°C)</option>
                <option value="densite">Densité</option>
                <option value="ph">pH</option>
                <option value="sucre">Sucres (g/L)</option>
                <option value="tav">TAV (%)</option>
                <option value="so2_libre">SO₂ libre (mg/L)</option>
                <option value="so2_total">SO₂ total (mg/L)</option>
                <option value="acidite_totale">Acidité totale (g/L H₂SO₄)</option>
                <option value="acidite_volatile">Acidité volatile (g/L H₂SO₄)</option>
              </select>
            </div>
            <div class="col-6">
              <input type="number" step="0.01" name="value" class="form-control form-control-sm" placeholder="Valeur" required>
            </div>
          </div>
          <div class="mb-2">
            <input type="datetime-local" name="date" class="form-control form-control-sm" value="{{ 'now'|date:'Y-m-d' }}T{{ 'now'|time:'H:i' }}">
          </div>
          <button class="btn btn-outline-primary btn-sm w-100">Ajouter</button>
        </form>
        
        <hr>
        
        <!-- Intervention -->
        <form method="post" action="{% url 'production:lot_vinif_add_intervention' pk=lot.pk %}">
          {% csrf_token %}
          <div class="fw-medium mb-2 small">Ajouter une intervention</div>
          <div class="mb-2">
            <select name="type" class="form-select form-select-sm" id="intervention-type">
              <optgroup label="Vinification">
                <option value="remontage">Remontage</option>
                <option value="pigeage">Pigeage</option>
                <option value="delestage">Délestage</option>
                <option value="debourbage">Débourbage</option>
                <option value="pressurage">Pressurage</option>
                <option value="maceration">Macération pelliculaire</option>
                <option value="ecoulage">Écoulage</option>
              </optgroup>
              <optgroup label="Intrants">
                <option value="so2">Ajout SO₂</option>
                <option value="levurage">Levurage</option>
                <option value="enzymage">Enzymage</option>
                <option value="collage">Collage</option>
                <option value="acidification">Acidification</option>
                <option value="chaptalisation">Chaptalisation</option>
              </optgroup>
              <optgroup label="Élevage">
                <option value="soutirage">Soutirage</option>
                <option value="batonnage">Bâtonnage</option>
                <option value="ouillage">Ouillage</option>
              </optgroup>
              <optgroup label="Finition">
                <option value="filtration">Filtration</option>
                <option value="stabilisation">Stabilisation tartrique</option>
              </optgroup>
            </select>
          </div>
          <div class="row g-2 mb-2">
            <div class="col-6">
              <input type="number" step="0.01" name="quantite" class="form-control form-control-sm" placeholder="Dose/Qté">
            </div>
            <div class="col-6">
              <select name="unite" class="form-select form-select-sm">
                <option value="">— Unité —</option>
                <option value="g/hL">g/hL</option>
                <option value="mg/L">mg/L</option>
                <option value="mL/hL">mL/hL</option>
                <option value="kg">kg</option>
                <option value="L">L</option>
              </select>
            </div>
          </div>
          <div class="mb-2">
            <input type="text" name="notes" class="form-control form-control-sm" placeholder="Notes (optionnel)">
          </div>
          <button class="btn btn-outline-primary btn-sm w-100">Ajouter</button>
        </form>
      </div>
    </div>

    <!-- Opérations de volume -->
    <div class="card mb-3">
      <div class="card-header fw-semibold">Opérations volume</div>
      <div class="card-body">
        <!-- Perte -->
        <form method="post" action="{% url 'production:lot_tech_action' pk=lot.pk action='perte' %}" class="mb-3">
          {% csrf_token %}
          <div class="fw-medium mb-2 small text-danger">Déclarer une perte</div>
          <div class="input-group input-group-sm">
            <input type="number" step="0.01" name="volume_l" class="form-control" placeholder="Volume (L)" required>
            <button class="btn btn-outline-danger">Enregistrer</button>
          </div>
        </form>

        <hr>

        <!-- Transfert -->
        <form method="post" action="{% url 'production:lot_tech_action' pk=lot.pk action='transfert' %}">
          {% csrf_token %}
          <div class="fw-medium mb-2 small">Transférer vers un autre lot</div>
          <div class="mb-2">
            <input type="number" step="0.01" name="volume_l" class="form-control form-control-sm" placeholder="Volume (L)" required>
          </div>
          <div class="mb-2">
            <select class="form-select form-select-sm" name="dst_lot_id" required>
              <option value="">— Lot destination —</option>
              {% for other in other_lots %}
                <option value="{{ other.id }}">{{ other.code }} ({{ other.campagne }})</option>
              {% endfor %}
            </select>
          </div>
          <button class="btn btn-outline-primary btn-sm w-100">Transférer</button>
        </form>
      </div>
    </div>

    <!-- Localisation -->
    {% if lot.location_kind != 'OFFSITE' %}
    <div class="card mb-3">
      <div class="card-header fw-semibold">Localisation</div>
      <div class="card-body d-grid gap-2">
        <form method="post" action="{% url 'production:lot_tech_action' pk=lot.pk action='offsite_send' %}">
          {% csrf_token %}
          <input type="hidden" name="tiers" value="">
          <button class="btn btn-outline-warning w-100">
            <i class="bi bi-send me-2"></i>Envoyer hors site
          </button>
        </form>
      </div>
    </div>
    {% else %}
    <div class="card mb-3 border-warning">
      <div class="card-header fw-semibold bg-warning text-dark">
        <i class="bi bi-geo-alt me-2"></i>Lot hors site
      </div>
      <div class="card-body d-grid gap-2">
        <form method="post" action="{% url 'production:lot_tech_action' pk=lot.pk action='offsite_return_neutral' %}">
          {% csrf_token %}
          <button class="btn btn-outline-primary w-100">Retour (neutre)</button>
        </form>
        <form method="post" action="{% url 'production:lot_tech_action' pk=lot.pk action='offsite_return_non_neutral' %}">
          {% csrf_token %}
          <button class="btn btn-outline-danger w-100">Retour (non neutre)</button>
        </form>
      </div>
    </div>
    {% endif %}

    <!-- Contenant & Emplacement -->
    {% if lot_containers or lot_detail %}
    <div class="card mb-3">
      <div class="card-header fw-semibold">Contenant & Emplacement</div>
      <div class="card-body">
        {% if lot_containers %}
        <div class="mb-3">
          <div class="small text-muted mb-1">Contenants liés</div>
          {% for c in lot_containers %}
          <div class="d-flex justify-content-between">
            <span>{{ c.get_type_display }} {{ c.identifiant }}</span>
            <span class="badge bg-light text-dark">{{ c.volume_occupe_l }} / {{ c.capacite_l }} L</span>
          </div>
          {% endfor %}
        </div>
        {% endif %}
        
        {% if lot_detail %}
        <div class="small text-muted mb-1">Emplacement</div>
        <div>
          Allée {{ lot_detail.emplacement_rangee|default:"—" }} / 
          Travée {{ lot_detail.emplacement_travee|default:"—" }} / 
          Niveau {{ lot_detail.emplacement_niveau|default:"—" }}
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- Documents -->
    {% if lot_documents %}
    <div class="card mb-3">
      <div class="card-header fw-semibold">Documents</div>
      <div class="card-body">
        {% for d in lot_documents %}
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="small text-muted">{{ d.get_type_display }}</div>
            <div class="text-truncate" style="max-width: 180px;">{{ d.description|default:d.document.name }}</div>
          </div>
          <a class="btn btn-sm btn-outline-primary" href="{{ d.document.url }}" target="_blank">
            <i class="bi bi-download"></i>
          </a>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Coûts -->
    {% if cost_snapshot %}
    <div class="card">
      <div class="card-header fw-semibold">Coût de revient</div>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <span>Prix de revient €/L</span>
          <span class="fs-5 fw-bold text-primary">{{ cost_snapshot.cmp_vrac_eur_l|default:"0.00" }} €</span>
        </div>
        <div class="text-muted small mt-1">Coût moyen pondéré du vrac</div>
      </div>
    </div>
    {% endif %}

  </div>
</div>
{% endblock %}
