{% extends 'production/base_production.html' %}
{% block title %}Nouveau lot technique - Mon Chai{% endblock %}
{% block production_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Nouveau lot technique</h1>
  <div>
    <a href="/production/lots-techniques/" class="btn btn-outline-secondary"><i class="bi bi-arrow-left me-1"></i>Retour liste</a>
  </div>
 </div>

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
  {% endfor %}
{% endif %}

<form id="lottech-wizard" method="post" class="card">
  {% csrf_token %}
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-origine" data-bs-toggle="tab" data-bs-target="#pane-origine" type="button" role="tab">1. Origine (vendange)</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-params" data-bs-toggle="tab" data-bs-target="#pane-params" type="button" role="tab">2. Paramètres</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-resume" data-bs-toggle="tab" data-bs-target="#pane-resume" type="button" role="tab">3. Résumé</button>
      </li>
    </ul>
  </div>

  <div class="card-body tab-content">
    <!-- Origine -->
    <div class="tab-pane fade show active" id="pane-origine" role="tabpanel" aria-labelledby="tab-origine">
      <div class="row g-3 align-items-end">
        <div class="col-md-6">
          <label class="form-label">Rechercher une vendange</label>
          <input type="search" id="vendangeSearch" class="form-control" placeholder="Code, parcelle…" oninput="filterVendanges()">
        </div>
        <div class="col-md-6 text-end">
          <span class="text-muted small">Sélectionnez une vendange à débiter (kg restant &gt; 0 conseillé).</span>
        </div>
      </div>
      <div class="table-responsive mt-3" style="max-height: 320px;">
        <table class="table table-hover align-middle mb-0" id="vendangesTable">
          <thead class="table-light">
            <tr>
              <th>Code</th>
              <th>Date</th>
              <th>Parcelle</th>
              <th>Cuvée</th>
              <th class="text-end">Kg restant</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for v in vendanges %}
              <tr data-id="{{ v.id }}" data-code="{{ v.code }}" data-parcelle="{{ v.parcelle }}" data-cuvee="{{ v.cuvee }}" data-kg="{{ v.kg_restant }}">
                <td><span class="fw-semibold">{{ v.code|default:'—' }}</span></td>
                <td>{{ v.date }}</td>
                <td>{{ v.parcelle|default:'—' }}</td>
                <td>{{ v.cuvee|default:'—' }}</td>
                <td class="text-end"><span class="badge bg-secondary">{{ v.kg_restant }}</span></td>
                <td class="text-end"><button type="button" class="btn btn-sm btn-outline-primary" onclick="selectVendange(this)">Choisir</button></td>
              </tr>
            {% empty %}
              <tr><td colspan="6" class="text-center text-muted">Aucune vendange disponible</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <input type="hidden" name="vendange_id" id="vendange_id">
      <div class="mt-3">
        <div class="alert alert-info mb-0" id="vendangeSelected" style="display:none;"></div>
      </div>
    </div>

    <!-- Paramètres -->
    <div class="tab-pane fade" id="pane-params" role="tabpanel" aria-labelledby="tab-params">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Contenant</label>
          <input type="text" name="contenant" id="contenant" class="form-control" placeholder="Ex: Cuve inox 50hL" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Volume mesuré (L) <span class="text-muted">(optionnel)</span></label>
          <input type="number" step="0.01" min="0" name="volume_mesure_l" id="volume_mesure_l" class="form-control" placeholder="Si mesuré">
        </div>
        <div class="col-md-2">
          <label class="form-label">Rdt base (L/kg)</label>
          <input type="number" step="0.01" min="0.01" name="rendement_base" id="rendement_base" value="0.75" class="form-control">
        </div>
        <div class="col-md-2">
          <label class="form-label">Efficacité (%)</label>
          <input type="number" step="0.1" min="1" name="effic_pct" id="effic_pct" value="100" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">Kg débités (fraction)</label>
          <input type="number" step="0.01" min="0.01" name="poids_debite_kg" id="poids_debite_kg" class="form-control" placeholder="Ex: 500">
        </div>
        <div class="col-md-2">
          <label class="form-label">ou Part (%)</label>
          <input type="number" step="0.1" min="0.1" max="100" name="part_pct" id="part_pct" class="form-control" placeholder="Ex: 50">
        </div>
        <div class="col-md-2">
          <label class="form-label">Temp. (°C)</label>
          <input type="number" step="0.1" name="temperature_c" id="temperature_c" class="form-control" placeholder="Ex: 18.5">
        </div>
        <div class="col-md-5">
          <label class="form-label">Notes</label>
          <input type="text" name="notes" id="notes" class="form-control" placeholder="Notes encuvage (optionnel)">
        </div>
        <div class="col-md-3">
          <label class="form-label">Mode encuvage</label>
          <select name="mode_encuvage" id="mode_encuvage" class="form-select">
            <option value="">—</option>
            <option value="égrappé">Égrappé</option>
            <option value="entier">Grappes entières</option>
            <option value="pressurage_direct">Pressurage direct</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Type de lot</label>
          <select name="lot_type" id="lot_type" class="form-select">
            <option value="">—</option>
            <option value="mout">Moût</option>
            <option value="vin">Vin</option>
          </select>
        </div>
      </div>
      <div class="alert alert-secondary mt-3" id="calcHint">Astuce: si vous saisissez "Kg débités" ou "Part (%)", le volume estimé sera calculé à partir du rendement et de l'efficacité.</div>
    </div>

    <!-- Résumé -->
    <div class="tab-pane fade" id="pane-resume" role="tabpanel" aria-labelledby="tab-resume">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="card h-100"><div class="card-body">
            <h6 class="text-uppercase text-muted">Origine</h6>
            <div id="resumeOrigine">Sélectionnez une vendange…</div>
          </div></div>
        </div>
        <div class="col-md-6">
          <div class="card h-100"><div class="card-body">
            <h6 class="text-uppercase text-muted">Paramètres & Volume estimé</h6>
            <div id="resumeParams">—</div>
          </div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card-footer d-flex justify-content-between">
    <div class="text-muted small">Statuts disponibles: <span class="badge bg-secondary">En élevage</span> <span class="badge bg-warning text-dark">Prêt mise</span> <span class="badge bg-dark">Épuisés</span> (gérés ensuite depuis la fiche du lot).</div>
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">Précédent</button>
      <button type="button" class="btn btn-outline-primary" onclick="nextTab()">Suivant</button>
      <button type="submit" class="btn btn-primary" onclick="return validateBeforeSubmit()">Créer le lot</button>
    </div>
  </div>
</form>

<script>
  function filterVendanges(){
    const q = (document.getElementById('vendangeSearch').value || '').toLowerCase();
    const rows = document.querySelectorAll('#vendangesTable tbody tr');
    rows.forEach(tr => {
      const code = (tr.dataset.code || '').toLowerCase();
      const parc = (tr.dataset.parcelle || '').toLowerCase();
      const cuv = (tr.dataset.cuvee || '').toLowerCase();
      tr.style.display = (code.includes(q) || parc.includes(q) || cuv.includes(q)) ? '' : 'none';
    });
  }
  function selectVendange(btn){
    const tr = btn.closest('tr');
    const id = tr.dataset.id; const code = tr.dataset.code; const parc = tr.dataset.parcelle; const cuv = tr.dataset.cuvee; const kg = tr.dataset.kg;
    document.getElementById('vendange_id').value = id;
    const el = document.getElementById('vendangeSelected');
    el.textContent = `Vendange ${code || '—'} – ${parc || '—'} – ${cuv || '—'} – kg restant ${kg}`;
    el.style.display = '';
    // Aller à l'onglet paramètres
    document.querySelector('#tab-params').click();
    updateResume();
  }
  function nextTab(){
    const active = document.querySelector('.nav-link.active');
    if (active && active.id === 'tab-origine'){ document.querySelector('#tab-params').click(); }
    else if (active && active.id === 'tab-params'){ document.querySelector('#tab-resume').click(); updateResume(); }
  }
  function prevTab(){
    const active = document.querySelector('.nav-link.active');
    if (active && active.id === 'tab-resume'){ document.querySelector('#tab-params').click(); }
    else if (active && active.id === 'tab-params'){ document.querySelector('#tab-origine').click(); }
  }
  function updateResume(){
    const vend = document.getElementById('vendangeSelected').textContent || '—';
    document.getElementById('resumeOrigine').textContent = vend || '—';
    // Calcul volume estimé
    const volMes = parseFloat(document.getElementById('volume_mesure_l').value || '');
    const kg = parseFloat(document.getElementById('poids_debite_kg').value || '');
    const pct = parseFloat(document.getElementById('part_pct').value || '');
    const base = parseFloat(document.getElementById('rendement_base').value || '0.75');
    const eff = parseFloat(document.getElementById('effic_pct').value || '100');
    let estimated = null; let explanation = '';
    if (!isNaN(volMes) && volMes > 0){ estimated = volMes; explanation = 'Volume mesuré'; }
    else {
      let kgUsed = (!isNaN(kg) && kg > 0) ? kg : null;
      if (!kgUsed && !isNaN(pct) && pct > 0){
        // Approx: pas d'accès au poids total ici; afficher formule générique
        explanation = 'Estimation basée sur part (%) et rendement';
      }
      if (kgUsed){ estimated = kgUsed * base * (eff/100.0); explanation = 'Estimation basée sur kg débités'; }
    }
    const cont = document.getElementById('contenant').value || '—';
    const txt = `Contenant: ${cont}. Rendement: ${base} L/kg, Efficacité: ${eff}%.` + (estimated? ` Volume estimé: ${estimated.toFixed(2)} L (${explanation}).` : '');
    document.getElementById('resumeParams').textContent = txt;
  }
  ['volume_mesure_l','poids_debite_kg','part_pct','rendement_base','effic_pct','contenant','notes','mode_encuvage','lot_type'].forEach(id=>{
    const el = document.getElementById(id); if (el){ el.addEventListener('input', updateResume); el.addEventListener('change', updateResume); }
  });
  function validateBeforeSubmit(){
    const v = document.getElementById('vendange_id').value;
    if (!v){ alert('Sélectionnez une vendange.'); document.querySelector('#tab-origine').click(); return false; }
    const cont = document.getElementById('contenant').value.trim();
    if (!cont){ alert('Le contenant est requis.'); document.querySelector('#tab-params').click(); return false; }
    return true;
  }
</script>
{% endblock %}
