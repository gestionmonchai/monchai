{% extends 'production/base_production.html' %}
{% block title %}Nouveau lot technique - Mon Chai{% endblock %}
{% block production_content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb mb-0">
    <li class="breadcrumb-item"><a href="{% url 'production:production_home' %}" class="text-decoration-none">Production</a></li>
    <li class="breadcrumb-item"><a href="{% url 'production:lots_tech_list' %}" class="text-decoration-none">Lots techniques</a></li>
    <li class="breadcrumb-item active" aria-current="page">Nouveau lot</li>
  </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 mb-0">Nouveau lot technique</h1>
    <p class="text-muted mb-0 small" id="subtitle-text">Créez un lot à partir d'une vendange</p>
  </div>
  <a href="{% url 'production:lots_tech_list' %}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left me-1"></i>Retour</a>
</div>

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
  {% endfor %}
{% endif %}

<form id="lottech-wizard" method="post" class="card">
  {% csrf_token %}
  <div class="card-body border-bottom bg-light-subtle">
    <h6 class="mb-3"><i class="bi bi-signpost-split me-2"></i>Mode de création</h6>
    <div class="btn-group w-100 mb-3" role="group">
      <input type="radio" class="btn-check" name="creation_mode" id="mode_vendange" value="vendange" checked>
      <label class="btn btn-outline-primary" for="mode_vendange">
        <i class="bi bi-basket me-2"></i>Depuis une vendange
        <small class="d-block text-muted mt-1">Traçabilité complète</small>
      </label>
      
      <input type="radio" class="btn-check" name="creation_mode" id="mode_direct" value="direct">
      <label class="btn btn-outline-warning" for="mode_direct">
        <i class="bi bi-lightning me-2"></i>Création directe
        <small class="d-block text-muted mt-1">Sans vendange préalable</small>
      </label>
    </div>

    <!-- Disclaimer pour création directe -->
    <div class="alert alert-warning mb-0" id="disclaimer-direct" style="display:none;">
      <h6 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Attention : Traçabilité limitée</h6>
      <p class="mb-2">En créant un lot directement sans vendange, vous ne pourrez pas :</p>
      <ul class="mb-3">
        <li>Lier le lot à une parcelle spécifique</li>
        <li>Conserver les données de vendange (poids, degré, date de récolte)</li>
        <li>Générer une traçabilité complète pour les exports réglementaires</li>
      </ul>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="accept_disclaimer" name="accept_disclaimer">
        <label class="form-check-label fw-bold" for="accept_disclaimer">
          Je comprends et accepte de créer un lot sans traçabilité complète
        </label>
      </div>
    </div>
  </div>
  
  <!-- Barre de progression pour mode vendange -->
  <div class="card-header" id="progress-vendange">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h6 class="mb-0"><i class="bi bi-basket me-2"></i>Création depuis vendange</h6>
      <small class="text-muted">Traçabilité complète</small>
    </div>
    <div class="progress" style="height: 8px;">
      <div class="progress-bar" id="progress-bar-vendange" role="progressbar" style="width: 33%" aria-valuenow="33" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
    <div class="d-flex justify-content-between mt-2 small">
      <span class="step-label active" id="step-v1"><i class="bi bi-1-circle-fill"></i> Vendange</span>
      <span class="step-label" id="step-v2"><i class="bi bi-2-circle"></i> Contenant</span>
      <span class="step-label" id="step-v3"><i class="bi bi-3-circle"></i> Validation</span>
    </div>
  </div>
  
  <!-- Barre de progression pour mode direct -->
  <div class="card-header" id="progress-direct" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h6 class="mb-0"><i class="bi bi-lightning me-2"></i>Création directe</h6>
      <small class="text-muted">Sans vendange préalable</small>
    </div>
    <div class="progress" style="height: 8px;">
      <div class="progress-bar bg-warning" id="progress-bar-direct" role="progressbar" style="width: 33%" aria-valuenow="33" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
    <div class="d-flex justify-content-between mt-2 small">
      <span class="step-label active" id="step-d1"><i class="bi bi-1-circle-fill"></i> Informations</span>
      <span class="step-label" id="step-d2"><i class="bi bi-2-circle"></i> Contenant</span>
      <span class="step-label" id="step-d3"><i class="bi bi-3-circle"></i> Validation</span>
    </div>
  </div>

  <div class="card-body tab-content">
    <!-- Origine & Cuvée (mode vendange) -->
    <div class="tab-pane fade show active" id="pane-origine" role="tabpanel" aria-labelledby="tab-origine">
      <div class="row g-3 align-items-end mb-3">
        <div class="col-md-5">
          <label class="form-label">Rechercher une vendange</label>
          <input type="search" id="vendangeSearch" class="form-control" placeholder="Code, parcelle…" oninput="filterVendanges()">
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold"><i class="bi bi-wine me-1"></i>Cuvée de destination</label>
          <select name="cuvee_id" id="cuvee_id" class="form-select">
            <option value="">— Sélectionner ou garder celle de la vendange —</option>
            {% for c in cuvees %}
              <option value="{{ c.id }}">{{ c.nom }}{% if c.couleur %} ({{ c.couleur }}){% endif %}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3 text-end">
          <span class="text-muted small">Kg restant &gt; 0 conseillé</span>
        </div>
      </div>
      <div class="table-responsive" style="max-height: 300px;">
        <table class="table table-hover align-middle mb-0" id="vendangesTable">
          <thead class="table-light sticky-top">
            <tr>
              <th>Code</th>
              <th>Date</th>
              <th>Parcelle</th>
              <th>Cuvée actuelle</th>
              <th class="text-end">Kg restant</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for v in vendanges %}
              <tr data-id="{{ v.id }}" data-code="{{ v.code }}" data-parcelle="{{ v.parcelle }}" data-cuvee="{{ v.cuvee }}" data-cuvee-id="{{ v.cuvee_id }}" data-kg="{{ v.kg_restant }}" class="{% if v.kg_restant <= 0 %}table-secondary{% endif %}">
                <td><span class="fw-semibold">{{ v.code|default:'—' }}</span></td>
                <td>{{ v.date }}</td>
                <td>{{ v.parcelle|default:'—' }}</td>
                <td>{% if v.cuvee %}<span class="badge bg-primary">{{ v.cuvee }}</span>{% else %}<span class="text-danger small">Non affectée</span>{% endif %}</td>
                <td class="text-end">
                  {% if v.kg_restant > 0 %}
                    <span class="badge bg-success">{{ v.kg_restant }} kg</span>
                  {% else %}
                    <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>Épuisée</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  {% if v.kg_restant > 0 %}
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectVendange(this)">Choisir</button>
                  {% else %}
                    <button type="button" class="btn btn-sm btn-outline-secondary" disabled title="Vendange épuisée"><i class="bi bi-lock"></i></button>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="6" class="text-center text-muted">Aucune vendange disponible</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <input type="hidden" name="vendange_id" id="vendange_id">
      <div class="mt-3">
        <div class="alert alert-info mb-0" id="vendangeSelected" style="display:none;"></div>
      </div>
    </div>

    <!-- Création directe (mode direct) -->
    <div class="tab-pane fade" id="pane-direct" role="tabpanel" aria-labelledby="tab-direct" style="display:none;">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label fw-semibold">Campagne <span class="text-danger">*</span></label>
          <input type="text" name="campagne" id="campagne_direct" class="form-control" placeholder="Ex: 2024-2025" pattern="\d{4}-\d{4}" value="{{ default_campagne }}">
          <small class="text-muted">Format: AAAA-AAAA</small>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold"><i class="bi bi-wine me-1"></i>Cuvée <span class="text-danger">*</span></label>
          <select name="cuvee_id_direct" id="cuvee_id_direct" class="form-select">
            <option value="">— Sélectionner une cuvée —</option>
            {% for c in cuvees %}
              <option value="{{ c.id }}">{{ c.nom }}{% if c.couleur %} ({{ c.couleur }}){% endif %}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold">Volume initial (L) <span class="text-danger">*</span></label>
          <input type="number" step="0.01" min="0.01" name="volume_initial_l" id="volume_initial_l" class="form-control" placeholder="Ex: 1000">
        </div>
        <div class="col-md-4">
          <label class="form-label">Date d'encuvage <span class="text-danger">*</span></label>
          <input type="date" name="date_encuvage" id="date_encuvage" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label">Statut initial</label>
          <select name="statut_initial" id="statut_initial" class="form-select">
            <option value="VIN_ELEVAGE" selected>Vin en élevage</option>
            <option value="MOUT_ENCUVE">Moût encuvé</option>
            <option value="VIN_EN_FA">Vin en FA</option>
            <option value="VIN_POST_FA">Vin post-FA</option>
            <option value="VIN_EN_FML">Vin en FML</option>
            <option value="VIN_STABILISE">Vin stabilisé</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Nom du lot <span class="text-muted">(optionnel)</span></label>
          <input type="text" name="nom_lot" id="nom_lot" class="form-control" placeholder="Ex: Cuvée Prestige 2024" value="{{ default_lot_name }}" data-auto-generated="true">
        </div>
        <div class="col-md-6">
          <label class="form-label">Origine géographique <span class="text-muted">(optionnel)</span></label>
          <input type="text" name="origine_geo" id="origine_geo" class="form-control" placeholder="Ex: Parcelle Les Vignes">
        </div>
        <div class="col-md-6">
          <label class="form-label">Cépages <span class="text-muted">(optionnel)</span></label>
          <input type="text" name="cepages" id="cepages" class="form-control" placeholder="Ex: Merlot 60%, Cabernet 40%">
        </div>
        <div class="col-md-3">
          <label class="form-label">Température (°C)</label>
          <input type="number" step="0.1" name="temperature_c_direct" id="temperature_c_direct" class="form-control" placeholder="18.5">
        </div>
        <div class="col-md-3">
          <label class="form-label">Mode encuvage</label>
          <select name="mode_encuvage_direct" id="mode_encuvage_direct" class="form-select">
            <option value="">—</option>
            <option value="égrappé">Égrappé</option>
            <option value="entier">Grappes entières</option>
            <option value="pressurage_direct">Pressurage direct</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label">Notes</label>
          <textarea name="notes_direct" id="notes_direct" class="form-control" rows="3" placeholder="Notes sur l'origine, la vinification, etc."></textarea>
        </div>
      </div>
    </div>

    <!-- Destination & Paramètres -->
    <div class="tab-pane fade" id="pane-params" role="tabpanel" aria-labelledby="tab-params">
      <!-- Sélection Cuve / Barrique -->
      <div class="card mb-3 border-primary">
        <div class="card-header bg-primary text-white py-2">
          <i class="bi bi-bucket me-1"></i> Cuve / Barrique de destination
        </div>
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Filtrer par type</label>
              <select id="contenantTypeFilter" class="form-select form-select-sm" onchange="filterContenants()">
                <option value="">Tous</option>
                <option value="cuve">Cuves uniquement</option>
                <option value="barrique">Barriques / Fûts</option>
              </select>
            </div>
            <div class="col-md-9">
              <label class="form-label fw-semibold">Sélectionner le contenant <span class="text-danger">*</span></label>
              <select name="contenant" id="contenant" class="form-select" required>
                <option value="">— Choisir une cuve ou barrique —</option>
                {% for c in contenants %}
                  <option value="{{ c.id }}" 
                          data-type="{{ c.type_code }}" 
                          data-is-cuve="{{ c.is_cuve|yesno:'true,false' }}"
                          data-capacite="{{ c.capacite_l }}"
                          data-libre="{{ c.libre_l }}"
                          data-localisation="{{ c.localisation }}">
                    {{ c.code }}{% if c.label %} – {{ c.label }}{% endif %} ({{ c.type }}) — {{ c.libre_l|floatformat:0 }} L libres / {{ c.capacite_l|floatformat:0 }} L{% if c.localisation %} — {{ c.localisation }}{% endif %}
                  </option>
                {% empty %}
                  <option value="" disabled>Aucun contenant disponible</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div id="contenantInfo" class="mt-2 small text-muted" style="display:none;">
            <i class="bi bi-info-circle me-1"></i><span id="contenantInfoText"></span>
          </div>
        </div>
      </div>

      <!-- Paramètres d'encuvage -->
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Volume mesuré (L) <span class="text-muted">(optionnel)</span></label>
          <input type="number" step="0.01" min="0" name="volume_mesure_l" id="volume_mesure_l" class="form-control" placeholder="Si mesuré directement">
        </div>
        <div class="col-md-4">
          <label class="form-label">Rdt base (L/kg)</label>
          <input type="number" step="0.01" min="0.01" name="rendement_base" id="rendement_base" value="0.75" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label">Efficacité (%)</label>
          <input type="number" step="0.1" min="1" name="effic_pct" id="effic_pct" value="100" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">Kg débités (fraction)</label>
          <input type="number" step="0.01" min="0.01" name="poids_debite_kg" id="poids_debite_kg" class="form-control" placeholder="Ex: 500">
        </div>
        <div class="col-md-2">
          <label class="form-label">ou Part (%)</label>
          <input type="number" step="0.1" min="0.1" max="100" name="part_pct" id="part_pct" class="form-control" placeholder="Ex: 50">
        </div>
        <div class="col-md-2">
          <label class="form-label">Temp. (°C)</label>
          <input type="number" step="0.1" name="temperature_c" id="temperature_c" class="form-control" placeholder="18.5">
        </div>
        <div class="col-md-5">
          <label class="form-label">Notes</label>
          <input type="text" name="notes" id="notes" class="form-control" placeholder="Notes encuvage (optionnel)">
        </div>
        <div class="col-md-3">
          <label class="form-label">Mode encuvage</label>
          <select name="mode_encuvage" id="mode_encuvage" class="form-select">
            <option value="">—</option>
            <option value="égrappé">Égrappé</option>
            <option value="entier">Grappes entières</option>
            <option value="pressurage_direct">Pressurage direct</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Type de lot</label>
          <select name="lot_type" id="lot_type" class="form-select">
            <option value="">—</option>
            <option value="mout">Moût</option>
            <option value="vin">Vin</option>
          </select>
        </div>
      </div>
      <div class="alert alert-secondary mt-3 small" id="calcHint">
        <i class="bi bi-lightbulb me-1"></i> <strong>Astuce :</strong> Si vous saisissez "Kg débités" ou "Part (%)", le volume estimé sera calculé à partir du rendement et de l'efficacité.
      </div>
    </div>

    <!-- Résumé -->
    <div class="tab-pane fade" id="pane-resume" role="tabpanel" aria-labelledby="tab-resume">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="card h-100"><div class="card-body">
            <h6 class="text-uppercase text-muted">Origine</h6>
            <div id="resumeOrigine">Sélectionnez une vendange…</div>
          </div></div>
        </div>
        <div class="col-md-6">
          <div class="card h-100"><div class="card-body">
            <h6 class="text-uppercase text-muted">Paramètres & Volume estimé</h6>
            <div id="resumeParams">—</div>
          </div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card-footer d-flex justify-content-between">
    <button type="button" class="btn btn-outline-secondary" id="btn-prev" onclick="prevStep()" style="display:none;"><i class="bi bi-arrow-left me-1"></i>Précédent</button>
    <div class="ms-auto d-flex gap-2">
      <button type="button" class="btn btn-primary" id="btn-next" onclick="nextStep()">Suivant<i class="bi bi-arrow-right ms-1"></i></button>
      <button type="submit" class="btn btn-success" id="btn-submit" style="display:none;" onclick="return validateBeforeSubmit()"><i class="bi bi-check-circle me-1"></i>Créer le lot</button>
    </div>
  </div>
</form>

<style>
.step-label {
  color: #6c757d;
  font-weight: 500;
  transition: all 0.3s;
}
.step-label.active {
  color: #0d6efd;
  font-weight: 600;
}
.step-label.completed {
  color: #198754;
}
.step-label i {
  font-size: 1.1rem;
  vertical-align: middle;
}
</style>

<script>
  // Variables globales pour la gestion des étapes
  let currentStep = 1;
  let currentMode = 'vendange';
  
  document.addEventListener('DOMContentLoaded', function() {
    const modeRadios = document.querySelectorAll('input[name="creation_mode"]');
    const disclaimerDiv = document.getElementById('disclaimer-direct');
    const paneOrigine = document.getElementById('pane-origine');
    const paneDirect = document.getElementById('pane-direct');
    const paneParams = document.getElementById('pane-params');
    const paneResume = document.getElementById('pane-resume');
    const subtitleText = document.getElementById('subtitle-text');
    const progressVendange = document.getElementById('progress-vendange');
    const progressDirect = document.getElementById('progress-direct');
    
    const campagneInput = document.getElementById('campagne_direct');
    const lotNameInput = document.getElementById('nom_lot');

    function autoUpdateLotName() {
      if (!lotNameInput) return;
      const isAuto = lotNameInput.dataset.autoGenerated === 'true';
      if (!isAuto) return;
      const campagne = (campagneInput?.value || '').trim();
      const year = campagne.split('-')[0] || '';
      if (year.match(/^\d{4}$/)) {
        lotNameInput.value = `Cuvée ${year}`;
      }
    }

    if (campagneInput) {
      campagneInput.addEventListener('input', autoUpdateLotName);
    }
    if (lotNameInput) {
      lotNameInput.addEventListener('input', () => { lotNameInput.dataset.autoGenerated = 'false'; });
    }

    function updateMode() {
      const isDirect = document.getElementById('mode_direct').checked;
      currentMode = isDirect ? 'direct' : 'vendange';
      currentStep = 1;
      
      // Afficher/masquer les sections
      disclaimerDiv.style.display = isDirect ? '' : 'none';
      progressVendange.style.display = isDirect ? 'none' : '';
      progressDirect.style.display = isDirect ? '' : 'none';
      
      // Réinitialiser les panes
      paneOrigine.classList.remove('show', 'active');
      paneDirect.classList.remove('show', 'active');
      paneParams.classList.remove('show', 'active');
      paneResume.classList.remove('show', 'active');
      
      // Afficher le premier pane selon le mode
      if (isDirect) {
        paneDirect.classList.add('show', 'active');
        paneDirect.style.display = '';
        paneOrigine.style.display = 'none';
        subtitleText.textContent = 'Création directe sans vendange préalable';
      } else {
        paneOrigine.classList.add('show', 'active');
        paneOrigine.style.display = '';
        paneDirect.style.display = 'none';
        subtitleText.textContent = 'Créez un lot à partir d\'une vendange';
      }
      
      // Ajuster les champs requis
      document.getElementById('vendange_id').required = !isDirect;
      document.getElementById('accept_disclaimer').required = isDirect;
      
      const directFields = ['campagne_direct', 'cuvee_id_direct', 'volume_initial_l', 'date_encuvage'];
      directFields.forEach(id => {
        const field = document.getElementById(id);
        if (field) field.required = isDirect;
      });
      
      // Réinitialiser la progression
      if (isDirect) {
        autoUpdateLotName();
      }
      updateProgress();
    }
    
    modeRadios.forEach(radio => {
      radio.addEventListener('change', updateMode);
    });
    
    // Initialiser l'état au chargement
    updateMode();
  });
  
  // Mise à jour de la barre de progression
  function updateProgress() {
    const isDirect = currentMode === 'direct';
    const progressBar = isDirect ? document.getElementById('progress-bar-direct') : document.getElementById('progress-bar-vendange');
    const prefix = isDirect ? 'd' : 'v';
    
    // Calculer le pourcentage
    const percent = (currentStep / 3) * 100;
    progressBar.style.width = percent + '%';
    progressBar.setAttribute('aria-valuenow', percent);
    
    // Mettre à jour les labels d'étapes
    for (let i = 1; i <= 3; i++) {
      const stepLabel = document.getElementById('step-' + prefix + i);
      const icon = stepLabel.querySelector('i');
      
      if (i < currentStep) {
        stepLabel.classList.add('completed');
        stepLabel.classList.remove('active');
        icon.className = 'bi bi-check-circle-fill';
      } else if (i === currentStep) {
        stepLabel.classList.add('active');
        stepLabel.classList.remove('completed');
        icon.className = 'bi bi-' + i + '-circle-fill';
      } else {
        stepLabel.classList.remove('active', 'completed');
        icon.className = 'bi bi-' + i + '-circle';
      }
    }
    
    // Afficher/masquer les boutons
    document.getElementById('btn-prev').style.display = currentStep > 1 ? '' : 'none';
    document.getElementById('btn-next').style.display = currentStep < 3 ? '' : 'none';
    document.getElementById('btn-submit').style.display = currentStep === 3 ? '' : 'none';
  }
  
  // Navigation entre les étapes
  function nextStep() {
    const isDirect = currentMode === 'direct';
    
    // Validation avant de passer à l'étape suivante
    if (currentStep === 1) {
      if (isDirect) {
        // Valider disclaimer et champs obligatoires
        const disclaimer = document.getElementById('accept_disclaimer');
        if (!disclaimer.checked) {
          alert('Vous devez accepter le disclaimer pour continuer.');
          return;
        }
        const campagne = document.getElementById('campagne_direct').value.trim();
        const cuvee = document.getElementById('cuvee_id_direct').value.trim();
        const volume = document.getElementById('volume_initial_l').value.trim();
        const date = document.getElementById('date_encuvage').value.trim();
        
        if (!campagne || !cuvee || !volume || !date) {
          alert('Veuillez remplir tous les champs obligatoires.');
          return;
        }
      } else {
        // Valider vendange sélectionnée
        const vendangeId = document.getElementById('vendange_id').value;
        if (!vendangeId) {
          alert('Veuillez sélectionner une vendange.');
          return;
        }
      }
    } else if (currentStep === 2) {
      // Valider contenant
      const contenant = document.getElementById('contenant').value.trim();
      if (!contenant) {
        alert('Veuillez sélectionner un contenant.');
        return;
      }
    }
    
    // Passer à l'étape suivante
    currentStep++;
    showStep(currentStep);
    updateProgress();
  }
  
  function prevStep() {
    if (currentStep > 1) {
      currentStep--;
      showStep(currentStep);
      updateProgress();
    }
  }
  
  function showStep(step) {
    const isDirect = currentMode === 'direct';
    const paneOrigine = document.getElementById('pane-origine');
    const paneDirect = document.getElementById('pane-direct');
    const paneParams = document.getElementById('pane-params');
    const paneResume = document.getElementById('pane-resume');
    
    // Masquer tous les panes
    [paneOrigine, paneDirect, paneParams, paneResume].forEach(pane => {
      pane.classList.remove('show', 'active');
    });
    
    // Afficher le pane approprié
    if (step === 1) {
      if (isDirect) {
        paneDirect.classList.add('show', 'active');
      } else {
        paneOrigine.classList.add('show', 'active');
      }
    } else if (step === 2) {
      paneParams.classList.add('show', 'active');
    } else if (step === 3) {
      paneResume.classList.add('show', 'active');
      updateResume();
    }
  }

  // Filtrage des vendanges par recherche
  function filterVendanges(){
    const q = (document.getElementById('vendangeSearch').value || '').toLowerCase();
    const rows = document.querySelectorAll('#vendangesTable tbody tr');
    rows.forEach(tr => {
      const code = (tr.dataset.code || '').toLowerCase();
      const parc = (tr.dataset.parcelle || '').toLowerCase();
      const cuv = (tr.dataset.cuvee || '').toLowerCase();
      tr.style.display = (code.includes(q) || parc.includes(q) || cuv.includes(q)) ? '' : 'none';
    });
  }

  // Sélection d'une vendange
  function selectVendange(btn){
    const tr = btn.closest('tr');
    const id = tr.dataset.id;
    const code = tr.dataset.code;
    const parc = tr.dataset.parcelle;
    const cuv = tr.dataset.cuvee;
    const cuvId = tr.dataset.cuveeId;
    const kg = parseFloat(tr.dataset.kg);
    
    // Vérifier que la vendange a du raisin restant
    if (kg <= 0) {
      alert('Cette vendange est épuisée. Veuillez en sélectionner une autre.');
      return;
    }
    
    document.getElementById('vendange_id').value = id;
    
    // Pré-sélectionner la cuvée de la vendange si elle en a une et qu'on n'a pas déjà choisi
    const cuveeSelect = document.getElementById('cuvee_id');
    if (cuvId && cuveeSelect.value === '') {
      cuveeSelect.value = cuvId;
    }
    
    // Afficher le résumé de sélection
    const el = document.getElementById('vendangeSelected');
    let html = `<strong>Vendange sélectionnée :</strong> ${code || '—'} — ${parc || '—'}`;
    if (cuv) {
      html += ` — <span class="badge bg-primary">${cuv}</span>`;
    } else {
      html += ` — <span class="text-danger">Cuvée non affectée</span>`;
    }
    html += ` — <span class="badge bg-secondary">${kg} kg restants</span>`;
    el.innerHTML = html;
    el.style.display = '';
    
    // Surligner la ligne sélectionnée
    document.querySelectorAll('#vendangesTable tbody tr').forEach(r => r.classList.remove('table-primary'));
    tr.classList.add('table-primary');
    
    // Passer automatiquement à l'étape suivante
    nextStep();
  }

  // Filtrage des contenants par type (cuve/barrique)
  function filterContenants(){
    const filter = document.getElementById('contenantTypeFilter').value;
    const select = document.getElementById('contenant');
    const options = select.querySelectorAll('option[data-type]');
    
    options.forEach(opt => {
      const isCuve = opt.dataset.isCuve === 'true';
      if (filter === '') {
        opt.style.display = '';
      } else if (filter === 'cuve') {
        opt.style.display = isCuve ? '' : 'none';
      } else if (filter === 'barrique') {
        opt.style.display = !isCuve ? '' : 'none';
      }
    });
    
    // Si l'option sélectionnée est maintenant cachée, reset
    if (select.selectedOptions[0] && select.selectedOptions[0].style.display === 'none') {
      select.value = '';
    }
    updateContenantInfo();
  }

  // Afficher infos du contenant sélectionné
  function updateContenantInfo(){
    const select = document.getElementById('contenant');
    const opt = select.selectedOptions[0];
    const infoDiv = document.getElementById('contenantInfo');
    const infoText = document.getElementById('contenantInfoText');
    
    if (opt && opt.value) {
      const libre = parseFloat(opt.dataset.libre || 0);
      const capacite = parseFloat(opt.dataset.capacite || 0);
      const pct = capacite > 0 ? ((capacite - libre) / capacite * 100).toFixed(0) : 0;
      const loc = opt.dataset.localisation || '';
      
      let txt = `Capacité libre : ${libre.toFixed(0)} L sur ${capacite.toFixed(0)} L (${pct}% occupé)`;
      if (loc) txt += ` — Localisation : ${loc}`;
      
      infoText.textContent = txt;
      infoDiv.style.display = '';
    } else {
      infoDiv.style.display = 'none';
    }
    updateResume();
  }


  // Mise à jour du résumé
  function updateResume(){
    // Origine
    const vendSel = document.getElementById('vendangeSelected');
    const origineHtml = vendSel.style.display !== 'none' ? vendSel.innerHTML : 'Sélectionnez une vendange…';
    document.getElementById('resumeOrigine').innerHTML = origineHtml;
    
    // Cuvée
    const cuveeSelect = document.getElementById('cuvee_id');
    const cuveeName = cuveeSelect.selectedOptions[0]?.textContent || '—';
    
    // Contenant
    const contSelect = document.getElementById('contenant');
    const contOpt = contSelect.selectedOptions[0];
    const contName = contOpt && contOpt.value ? contOpt.textContent.split('—')[0].trim() : '—';
    
    // Calcul volume estimé
    const volMes = parseFloat(document.getElementById('volume_mesure_l').value || '');
    const kg = parseFloat(document.getElementById('poids_debite_kg').value || '');
    const pct = parseFloat(document.getElementById('part_pct').value || '');
    const base = parseFloat(document.getElementById('rendement_base').value || '0.75');
    const eff = parseFloat(document.getElementById('effic_pct').value || '100');
    
    let estimated = null;
    let explanation = '';
    if (!isNaN(volMes) && volMes > 0){ 
      estimated = volMes; 
      explanation = 'Volume mesuré'; 
    } else {
      let kgUsed = (!isNaN(kg) && kg > 0) ? kg : null;
      if (!kgUsed && !isNaN(pct) && pct > 0){
        explanation = 'Estimation basée sur part (%) et rendement';
      }
      if (kgUsed){ 
        estimated = kgUsed * base * (eff/100.0); 
        explanation = 'Estimation basée sur kg débités'; 
      }
    }
    
    let html = `<p><strong>Cuvée :</strong> ${cuveeName}</p>`;
    html += `<p><strong>Contenant :</strong> ${contName}</p>`;
    html += `<p>Rendement: ${base} L/kg, Efficacité: ${eff}%</p>`;
    if (estimated) {
      html += `<p class="text-success fw-semibold"><i class="bi bi-droplet me-1"></i>Volume estimé : ${estimated.toFixed(0)} L <small class="text-muted">(${explanation})</small></p>`;
    }
    document.getElementById('resumeParams').innerHTML = html;
  }

  // Event listeners
  document.getElementById('contenant').addEventListener('change', updateContenantInfo);
  document.getElementById('cuvee_id').addEventListener('change', updateResume);
  ['volume_mesure_l','poids_debite_kg','part_pct','rendement_base','effic_pct','notes','mode_encuvage','lot_type'].forEach(id => {
    const el = document.getElementById(id); 
    if (el){ 
      el.addEventListener('input', updateResume); 
      el.addEventListener('change', updateResume); 
    }
  });

  // Validation avant soumission
  function validateBeforeSubmit(){
    const isDirect = document.getElementById('mode_direct').checked;
    
    if (isDirect) {
      // Validation mode direct
      const disclaimer = document.getElementById('accept_disclaimer');
      if (!disclaimer.checked) {
        alert('Vous devez accepter le disclaimer pour créer un lot sans vendange.');
        return false;
      }
      
      const campagne = document.getElementById('campagne_direct').value.trim();
      if (!campagne) {
        alert('La campagne est obligatoire.');
        document.querySelector('#tab-origine').click();
        return false;
      }
      
      const cuvee = document.getElementById('cuvee_id_direct').value.trim();
      if (!cuvee) {
        alert('La cuvée est obligatoire.');
        document.querySelector('#tab-origine').click();
        return false;
      }
      
      const volume = document.getElementById('volume_initial_l').value.trim();
      if (!volume || parseFloat(volume) <= 0) {
        alert('Le volume initial doit être supérieur à 0.');
        document.querySelector('#tab-origine').click();
        return false;
      }
      
      const date = document.getElementById('date_encuvage').value.trim();
      if (!date) {
        alert('La date d\'encuvage est obligatoire.');
        document.querySelector('#tab-origine').click();
        return false;
      }
    } else {
      // Validation mode vendange (existant)
      const v = document.getElementById('vendange_id').value;
      if (!v){ 
        alert('Sélectionnez une vendange.'); 
        document.querySelector('#tab-origine').click(); 
        return false; 
      }
    }
    
    // Validation commune: contenant
    const cont = document.getElementById('contenant').value.trim();
    if (!cont){ 
      alert('Sélectionnez une cuve ou barrique.'); 
      document.querySelector('#tab-params').click(); 
      return false; 
    }
    
    return true;
  }
</script>
{% endblock %}
