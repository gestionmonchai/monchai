{% extends 'production/base_production.html' %}
{% block title %}Lots & Élevage - Analyses{% endblock %}
{% block production_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Analyses</h1>
  <div class="btn-group">
    <a href="/production/lots-elevage/" class="btn btn-outline-secondary">Retour Lots & Élevage</a>
    <a href="/production/lots-techniques/?status=en_cours" class="btn btn-outline-secondary"><i class="bi bi-table me-1"></i>Vue BDD</a>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h6 class="mb-0"><i class="bi bi-funnel me-2"></i>Filtres de recherche</h6>
      <div class="btn-group btn-group-sm" role="group">
        <button type="button" class="btn btn-outline-secondary" id="toggle-advanced-search"><i class="bi bi-chevron-down"></i> Avancé</button>
        <button type="button" class="btn btn-outline-danger" id="clear-filters"><i class="bi bi-x-circle"></i> Effacer</button>
      </div>
    </div>
    <form id="analyses-filter-form"
          hx-get="{% url 'production:lots_elevage_analyses_table' %}"
          hx-target="#analyses-table" hx-swap="innerHTML"
          hx-trigger="change, keyup delay:200ms from:input">
      <!-- Recherche rapide -->
      <div class="row mb-3">
        <div class="col-md-8">
          <div class="position-relative">
            <input type="text" name="q" id="quick-search" placeholder="Recherche rapide (lot, cuvée, notes)" class="form-control pe-5" autocomplete="off">
            <div class="position-absolute top-50 end-0 translate-middle-y me-3">
              <i class="bi bi-search text-muted" id="search-icon"></i>
              <div class="spinner-border spinner-border-sm text-primary d-none" id="search-spinner" role="status"><span class="visually-hidden">Recherche...</span></div>
            </div>
          </div>
        </div>
        <div class="col-md-4"><div id="search-info" class="text-muted small mt-2">—</div></div>
      </div>
      <!-- Avancé -->
      <div id="advanced-filters" class="collapse">
        <hr>
        <div class="row g-2">
          <div class="col-md-2">
            <label class="form-label">Type</label>
            <select name="type" class="form-select">
              <option value="">Tous</option>
              {% for code,label in meas_choices %}
                <option value="{{ code }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Cuvée (nom ou UUID)</label>
            <input type="text" name="cuvee" class="form-control" placeholder="ex: Tradition 2024">
          </div>
          <div class="col-md-3">
            <label class="form-label">Lot (code contient)</label>
            <input type="text" name="lot" class="form-control" placeholder="ex: LT-2024-001">
          </div>
          <div class="col-md-2">
            <label class="form-label">Du</label>
            <input type="date" name="start" class="form-control">
          </div>
          <div class="col-md-2">
            <label class="form-label">Au</label>
            <input type="date" name="end" class="form-control">
          </div>
          <div class="col-md-2">
            <label class="form-label">Valeur min</label>
            <input type="number" step="0.001" name="vmin" class="form-control">
          </div>
          <div class="col-md-2">
            <label class="form-label">Valeur max</label>
            <input type="number" step="0.001" name="vmax" class="form-control">
          </div>
          <div class="col-md-2">
            <label class="form-label">Tri</label>
            <select name="sort" class="form-select">
              <option value="date_desc">Date ↓</option>
              <option value="date_asc">Date ↑</option>
              <option value="type">Type</option>
            </select>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<div id="analyses-table" hx-get="{% url 'production:lots_elevage_analyses_table' %}" hx-trigger="load" hx-target="#analyses-table" hx-swap="innerHTML">
  <div class="text-center text-muted py-4">Chargement…</div>
  <!-- Table rendue ici via partial _analyses_table.html -->
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const advBtn = document.getElementById('toggle-advanced-search');
    const clearBtn = document.getElementById('clear-filters');
    const adv = document.getElementById('advanced-filters');
    const quick = document.getElementById('quick-search');
    const spinner = document.getElementById('search-spinner');
    const icon = document.getElementById('search-icon');
    const info = document.getElementById('search-info');
    const form = document.getElementById('analyses-filter-form');

    function setLoading(isLoading) {
      if (isLoading) { spinner.classList.remove('d-none'); icon.classList.add('d-none'); }
      else { spinner.classList.add('d-none'); icon.classList.remove('d-none'); }
    }
    if (advBtn && adv) {
      advBtn.addEventListener('click', function() {
        adv.classList.toggle('show');
        const i = advBtn.querySelector('i');
        if (i) i.className = adv.classList.contains('show') ? 'bi bi-chevron-up' : 'bi bi-chevron-down';
      });
    }
    if (clearBtn) {
      clearBtn.addEventListener('click', function() {
        form.reset();
        form.dispatchEvent(new Event('change', { bubbles: true }));
      });
    }
    if (quick) { quick.addEventListener('input', function() { setLoading(true); }); }
    document.body.addEventListener('htmx:afterSwap', function(evt) {
      if (evt.target && evt.target.id === 'analyses-table') {
        setLoading(false);
        const meta = document.getElementById('analyses-table-meta');
        if (meta && info) {
          const total = meta.getAttribute('data-total') || '0';
          info.textContent = total + ' mesure' + (parseInt(total) > 1 ? 's' : '');
        }
      }
    });
  });
</script>
{% endblock %}
