{% extends 'production/base_production.html' %}
{% block title %}Fiche vendange - Mon Chai{% endblock %}
{% block production_content %}
<div class="d-flex justify-content-between align-items-start mb-3">
  <h1 class="h4 mb-0 d-flex align-items-center gap-3 flex-wrap">
    <span>Fiche vendange</span>
    {% if vendange.code %}<span class="badge bg-light text-dark">{{ vendange.code }}</span>{% endif %}
    {% if vendange.statut %}
      <span class="badge {% if vendange.statut == 'brouillon' %}bg-secondary{% elif vendange.statut == 'receptionnee' %}bg-primary{% elif vendange.statut == 'encuvee' %}bg-success{% else %}bg-info{% endif %}">
        {{ vendange.get_statut_display }}
      </span>
    {% endif %}
    {% if vendange.campagne %}<span class="badge bg-light text-dark">{{ vendange.campagne }}</span>{% endif %}
    {% if vendange.cuvee %}
      <span class="badge bg-warning text-dark"><i class="bi bi-cup-straw me-1"></i>{{ vendange.cuvee.nom }}</span>
    {% endif %}
  </h1>
  <a href="{% url 'production:vendange_update' vendange.pk %}" class="btn btn-outline-primary">
    <i class="bi bi-pencil me-1"></i>Modifier
  </a>
</div>

<div class="row g-3 mb-3">
  <div class="col-lg-8">
    <div class="card mb-3">
      <div class="card-header fw-semibold">Identité & contexte</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3"><strong>Date</strong><div>{{ vendange.date }}</div></div>
          <div class="col-md-4"><strong>Parcelle</strong><div>{{ vendange.parcelle }}</div></div>
          <div class="col-md-3"><strong>Type vendange</strong><div>{{ vendange.get_type_vendange_display }}</div></div>
          <div class="col-md-2"><strong>Type récolte</strong><div>{{ vendange.get_type_recolte_display }}</div></div>
        </div>
      </div>
    </div>

    <!-- Répartition par cépage -->
    <div class="card mb-3">
      <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
        <span><i class="bi bi-pie-chart me-2"></i>Répartition par cépage</span>
        <span class="badge bg-primary">Total: {{ vendange.poids_total|default:"0" }} kg</span>
      </div>
      <div class="card-body p-0">
        {% if vendange.lignes.exists %}
        <table class="table table-sm mb-0">
          <thead class="table-light">
            <tr>
              <th>Cépage</th>
              <th>Quantité (kg)</th>
              <th>Rangs</th>
              <th>Degré</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            {% for ligne in vendange.lignes.all %}
            <tr>
              <td><strong>{{ ligne.cepage.nom }}</strong></td>
              <td>{{ ligne.quantite_kg }} kg</td>
              <td>{% if ligne.rangs_texte %}{{ ligne.rangs_texte }}{% elif ligne.rang_debut and ligne.rang_fin %}{{ ligne.rang_debut }}-{{ ligne.rang_fin }}{% else %}—{% endif %}</td>
              <td>{{ ligne.degre_potentiel|default:"-" }}°</td>
              <td class="text-muted small">{{ ligne.notes|default:"-"|truncatechars:50 }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="p-3 text-center text-muted">
          <i class="bi bi-info-circle me-1"></i>Aucune répartition définie.
          {% if vendange.cepage %}Cépage unique : <strong>{{ vendange.cepage.nom }}</strong> — {{ vendange.poids_kg|default:"0" }} kg{% endif %}
        </div>
        {% endif %}
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header fw-semibold">Réception & tri</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3"><strong>Température (°C)</strong><div>{{ vendange.temperature_c|default:'-' }}</div></div>
          <div class="col-md-3"><strong>Tri</strong><div>{% if vendange.tri %}Oui{% else %}Non{% endif %}</div></div>
          <div class="col-md-6"><strong>Notes tri</strong><div>{{ vendange.tri_notes|default:'-' }}</div></div>
          <div class="col-md-6"><strong>Bennes / Palox</strong><div>{{ vendange.bennes_palox|default:'-' }}</div></div>
          <div class="col-md-3"><strong>État sanitaire</strong><div>{{ vendange.etat_sanitaire|default:'-' }}</div></div>
          <div class="col-md-9"><strong>Notes sanitaires</strong><div>{{ vendange.etat_sanitaire_notes|default:'-' }}</div></div>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header fw-semibold">Mesures & volumes</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3"><strong>Poids total (kg)</strong><div class="fs-5 text-primary fw-bold">{{ vendange.poids_total|default:'0' }}</div></div>
          <div class="col-md-3"><strong>Kg débités</strong><div>{{ vendange.kg_debites_cumules|default:'0' }}</div></div>
          <div class="col-md-3"><strong>Kg restant</strong><div class="text-success fw-bold">{{ vendange.kg_restant|default:'0' }}</div></div>
          <div class="col-md-3"><strong>Degré potentiel</strong><div>{{ vendange.degre_potentiel|default:'-' }}°</div></div>
          <div class="col-md-3"><strong>Rendement (%)</strong><div>{{ vendange.rendement_pct|default:'-' }}</div></div>
          <div class="col-md-3"><strong>Volume mesuré (L)</strong><div>{{ vendange.volume_mesure_l|default:'-' }}</div></div>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header fw-semibold">Coûts</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3"><strong>Prix raisin (€/kg)</strong><div>{{ vendange.prix_raisin_eur_kg|default:'-' }}</div></div>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header fw-semibold">Notes</div>
      <div class="card-body">{{ vendange.notes|linebreaks }}</div>
    </div>
  </div>
  <div class="col-lg-4">
    {% if next_step %}
    <div class="card mb-3">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <div class="small text-muted">Prochaine étape</div>
          <div class="fw-semibold">{{ next_step.label }}</div>
        </div>
        <a href="{{ next_step.url }}" class="btn btn-primary">Continuer</a>
      </div>
    </div>
    {% endif %}
    <div class="card mb-3" id="affectation-cuvee">
      <div class="card-header fw-semibold">Affectation Cuvée</div>
      <div class="card-body">
        <form method="post" action="/production/vendanges/{{ vendange.id }}/affecter-cuvee/">
          {% csrf_token %}
          <div class="mb-2">
            <select class="form-select" name="cuvee_id" required>
              <option value="">— Sélectionner une cuvée —</option>
              {% for c in cuvees %}
                <option value="{{ c.id }}" {% if vendange.cuvee and vendange.cuvee.id == c.id %}selected{% endif %}>{{ c.nom }}</option>
              {% endfor %}
            </select>
          </div>
          <button class="btn btn-outline-primary w-100" type="submit">Affecter la cuvée</button>
        </form>
      </div>
    </div>
    <div class="card">
      <div class="card-header fw-semibold">Actions</div>
      <div class="card-body d-grid gap-2">
        <a id="btn-create-encuvage" href="/production/vendanges/{{ vendange.id }}/encuvage/" class="btn btn-success">Encuvage / Pressurage</a>
        {% if lot_technique %}
          <a href="/production/lots-techniques/{{ lot_technique.id }}/" class="btn btn-outline-primary">Voir le lot technique</a>
        {% endif %}
        <a href="/production/mises/nouveau/?step=1" class="btn btn-outline-secondary">Planifier une mise</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}
