{% extends 'production/base_production.html' %}
{% block title %}Encuvage / Pressurage - Mon Chai{% endblock %}
{% block production_content %}
<h1 class="h4 mb-3">Encuvage / Pressurage</h1>

<div class="mb-3">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      {% for bc in breadcrumb_items %}
        {% if bc.name != 'Production' %}
          {% if bc.url %}
            <li class="breadcrumb-item"><a href="{{ bc.url }}">{{ bc.name }}</a></li>
          {% else %}
            <li class="breadcrumb-item active" aria-current="page">{{ bc.name }}</li>
          {% endif %}
        {% endif %}
      {% endfor %}
    </ol>
  </nav>
</div>

{% if not vendange.cuvee %}
  <div class="alert alert-warning mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Cuvée non affectée.</strong> Sélectionnez ou créez une cuvée avant l'encuvage.
      </div>
    </div>
    <form method="post" action="{% url 'production:vendange_affecter_cuvee' vendange.id %}" class="d-flex gap-2 align-items-end">
      {% csrf_token %}
      <div class="flex-grow-1">
        <label class="form-label small mb-1">Affecter une cuvée existante</label>
        <select name="cuvee_id" class="form-select form-select-sm">
          <option value="">— Sélectionner une cuvée —</option>
          {% for c in cuvees %}
            <option value="{{ c.id }}">{{ c.nom }}{% if c.code %} ({{ c.code }}){% endif %}</option>
          {% endfor %}
        </select>
      </div>
      <button type="submit" class="btn btn-warning btn-sm">
        <i class="bi bi-check me-1"></i>Affecter
      </button>
      <span class="text-muted">ou</span>
      <a class="btn btn-outline-primary btn-sm" href="{% url 'produits:cuvee_new' %}">
        <i class="bi bi-plus me-1"></i>Créer
      </a>
    </form>
  </div>
{% endif %}

<div class="card mb-4">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-3"><strong>Date vendange</strong><div>{{ vendange.date }}</div></div>
      <div class="col-md-3"><strong>Parcelle</strong><div>{{ vendange.parcelle }}</div></div>
      <div class="col-md-3"><strong>Poids total (kg)</strong><div>{{ vendange.poids_kg }}</div></div>
      <div class="col-md-3"><strong>Cuvée</strong><div>{% if vendange.cuvee %}{{ vendange.cuvee.nom }}{% else %}<span class="text-danger">Non affectée</span>{% endif %}</div></div>
    </div>
  </div>
  <div class="card-footer">
    <div class="small text-muted">Restant disponible: <strong id="kg-restant-label">{{ defaults.kg_restant }}</strong> kg (débités cumulés: {{ defaults.kg_debites_cumules }})</div>
  </div>
 </div>

<form method="post" id="encuvage-form">
  {% csrf_token %}
  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-semibold">Entrées / volumes</span>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="toggle-advanced">
            <label class="form-check-label" for="toggle-advanced">Mode avancé</label>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Kg débités</label>
              <input type="number" step="0.01" min="0" class="form-control" name="poids_debite_kg" id="kg-debites" value="{{ defaults.kg_restant }}" placeholder="ex: {{ defaults.kg_restant }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">Part de la vendange (%)</label>
              <input type="number" step="0.01" min="0" max="100" class="form-control" name="part_pct" id="part-pct" placeholder="ex: 50.00">
            </div>
            <div class="col-md-4">
              <label class="form-label">Volume mesuré (L) — prioritaire</label>
              <input type="number" step="0.01" min="0" class="form-control" name="volume_mesure_l" id="vol-mesure" placeholder="ex: 680.00">
            </div>
            <div class="col-md-3 adv-only">
              <label class="form-label">Rdt base (L/kg)</label>
              <input type="number" step="0.0001" min="0" class="form-control" name="rendement_base" id="rdt-base" value="{{ defaults.rendement_base }}">
            </div>
            <div class="col-md-3 adv-only">
              <label class="form-label">Efficacité (%)</label>
              <input type="number" step="0.01" min="0" class="form-control" name="effic_pct" id="effic-pct" value="{{ defaults.effic_pct }}">
            </div>
          </div>
          <div class="row g-3 mt-2">
            <div class="col-md-8">
              <label class="form-label">Contenant</label>
              <div class="input-group">
                <select class="form-select" id="container-select">
                  <option value="">— Sélectionner —</option>
                  {% if contenants %}
                    <optgroup label="Référentiel">
                      {% for c in contenants %}
                        <option value="{{ c.code }}" data-free="{{ c.free }}" data-cap="{{ c.cap }}" data-type="{{ c.type }}">
                          {{ c.code }} — {{ c.type }} (libre: {{ c.free }} L / utile: {{ c.cap }} L)
                        </option>
                      {% endfor %}
                    </optgroup>
                  {% endif %}
                  {% if containers %}
                    <optgroup label="Historique">
                      {% for c in containers %}
                        <option value="{{ c }}">{{ c }}</option>
                      {% endfor %}
                    </optgroup>
                  {% endif %}
                  <option value="__free__">Autre…</option>
                </select>
                <input type="text" class="form-control" name="contenant" id="container-input" placeholder="Cuve Inox 1">
              </div>
              <div id="container-capacity" class="small text-muted mt-2"></div>
              <div id="container-warning" class="alert alert-warning mt-2 d-none"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-3 adv-only">
        <div class="card-header fw-semibold">Paramètres vinification</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label d-block">Mode encuvage</label>
              <div class="d-flex gap-3">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="mode_encuvage" id="mode-erafle" value="erafle">
                  <label class="form-check-label" for="mode-erafle">Éraflé</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="mode_encuvage" id="mode-foule" value="foule">
                  <label class="form-check-label" for="mode-foule">Foulé</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="mode_encuvage" id="mode-pressurage" value="pressurage_direct">
                  <label class="form-check-label" for="mode-pressurage">Pressurage direct</label>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Type de lot généré</label>
              <select name="lot_type" id="lot-type" class="form-select">
                <option value="">— Optionnel —</option>
                <option value="vin_de_goutte">Vin de goutte</option>
                <option value="vin_de_presse">Vin de presse</option>
                <option value="mout_mute">Moût muté</option>
              </select>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Température (°C)</label>
              <input type="number" step="0.1" class="form-control" name="temperature_c" id="temp-c" placeholder="ex: 16.5">
            </div>
            <div class="col-12">
              <label class="form-label">Notes d'encuvage</label>
              <textarea class="form-control" name="notes" id="notes" rows="3" placeholder="Observations spécifiques"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between">
        <a href="/production/vendanges/{{ vendange.id }}/" class="btn btn-outline-secondary">Retour</a>
        <button type="submit" class="btn btn-primary" {% if not vendange.cuvee %}disabled{% endif %}>Créer le lot technique</button>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card">
        <div class="card-header fw-semibold">Résumé (live)</div>
        <div class="card-body">
          <div class="mb-2"><strong>Kg débités</strong><div id="sum-kg">—</div></div>
          <div class="mb-2"><strong>Volume utilisé</strong><div id="sum-vol">—</div></div>
          <div class="mb-2"><strong>Rendement effectif (L/kg)</strong><div id="sum-lkg">—</div></div>
          <div class="mb-2 d-flex align-items-center gap-2">
            <div><strong>Efficacité</strong></div>
            <div id="sum-effic" class="badge text-bg-secondary">—</div>
          </div>
          <hr>
          <div class="mb-2"><strong>Cuvée</strong><div>{% if vendange.cuvee %}{{ vendange.cuvee.nom }}{% else %}<span class="text-danger">Non affectée</span>{% endif %}</div></div>
          <div class="mb-2"><strong>Contenant</strong><div id="sum-contenant">—</div></div>
          <div class="mb-2"><strong>Coût matière estimé</strong><div id="sum-cost">—</div></div>
          <div class="small text-muted">Restant après débit: <span id="sum-restant">—</span> kg</div>
        </div>
      </div>
    </div>
  </div>
</form>

<script>
  (function() {
    const elKg = document.getElementById('kg-debites');
    const elPct = document.getElementById('part-pct');
    const elVol = document.getElementById('vol-mesure');
    const elBase = document.getElementById('rdt-base');
    const elEffic = document.getElementById('effic-pct');
    const restant0 = parseFloat('{{ defaults.kg_restant|default:"0" }}') || 0;
    const prixKg = parseFloat('{{ defaults.prix_raisin_eur_kg|default:"" }}') || null;
    const elSumKg = document.getElementById('sum-kg');
    const elSumVol = document.getElementById('sum-vol');
    const elSumLkg = document.getElementById('sum-lkg');
    const elSumEffic = document.getElementById('sum-effic');
    const elSumCost = document.getElementById('sum-cost');
    const elSumRest = document.getElementById('sum-restant');
    const elContSel = document.getElementById('container-select');
    const elContInp = document.getElementById('container-input');
    const elSumCont = document.getElementById('sum-contenant');
    const toggleAdv = document.getElementById('toggle-advanced');
    const elContCap = document.getElementById('container-capacity');
    const elContWarn = document.getElementById('container-warning');

    function clamp(x) { return isFinite(x) && x > 0 ? x : 0; }

    function currentKg() {
      const pct = parseFloat(elPct.value);
      if (isFinite(pct) && pct > 0) return restant0 * (pct/100);
      const kg = parseFloat(elKg.value);
      return isFinite(kg) ? kg : 0;
    }

    function compute() {
      const kg = clamp(currentKg());
      const base = parseFloat(elBase.value);
      const measured = parseFloat(elVol.value);
      const efficPct = parseFloat(elEffic.value);
      const theoretic = isFinite(base) && base>0 ? kg * base : null;
      const usedVol = isFinite(measured) && measured>0 ? measured : (isFinite(base) && isFinite(efficPct) ? kg * base * (efficPct/100) : null);
      const lkg = (isFinite(kg) && kg>0 && isFinite(usedVol)) ? (usedVol/kg) : null;
      const effic = (theoretic && isFinite(usedVol)) ? (usedVol / theoretic * 100) : null;

      elSumKg.textContent = kg ? kg.toFixed(2) + ' kg' : '—';
      elSumVol.textContent = (usedVol ? usedVol.toFixed(2) + ' L' : '—') + (isFinite(measured) && measured>0 ? ' (mesuré)' : ' (calculé)');
      elSumLkg.textContent = lkg ? lkg.toFixed(3) : '—';
      if (effic != null) {
        elSumEffic.textContent = effic.toFixed(1) + '%';
        elSumEffic.className = 'badge ' + (effic>100 || effic<50 ? 'text-bg-warning' : 'text-bg-success');
      } else {
        elSumEffic.textContent = '—';
        elSumEffic.className = 'badge text-bg-secondary';
      }
      if (prixKg != null && kg) {
        elSumCost.textContent = (kg * prixKg).toFixed(2) + ' €';
      } else {
        elSumCost.textContent = '—';
      }
      const rest = Math.max(0, restant0 - kg);
      elSumRest.textContent = rest.toFixed(2);

      // Container binding
      const cont = elContInp.value || '';
      elSumCont.textContent = cont || '—';
      // Capacity info and warning
      let free = null, capU = null;
      if (elContSel && elContSel.selectedIndex >= 0) {
        const opt = elContSel.options[elContSel.selectedIndex];
        if (opt && opt.dataset) {
          const f = parseFloat(opt.dataset.free);
          const c = parseFloat(opt.dataset.cap);
          free = isFinite(f) ? f : null;
          capU = isFinite(c) ? c : null;
        }
      }
      if (capU != null) {
        elContCap.textContent = `Capacité utile: ${capU.toFixed(2)} L` + (free!=null ? ` — Libre: ${free.toFixed(2)} L` : '');
      } else {
        elContCap.textContent = '';
      }
      if (free != null && isFinite(usedVol)) {
        if (usedVol > free + 1e-6) {
          elContWarn.textContent = `Volume estimé ${usedVol.toFixed(2)} L supérieur au libre ${free.toFixed(2)} L`;
          elContWarn.classList.remove('d-none');
        } else {
          elContWarn.classList.add('d-none');
          elContWarn.textContent = '';
        }
      } else {
        elContWarn.classList.add('d-none');
        elContWarn.textContent = '';
      }
    }

    elKg.addEventListener('input', compute);
    elPct.addEventListener('input', compute);
    elVol.addEventListener('input', compute);
    elBase.addEventListener('input', compute);
    elEffic.addEventListener('input', compute);
    elContSel.addEventListener('change', function() {
      if (this.value === '__free__') {
        elContInp.value = '';
        elContInp.focus();
      } else {
        elContInp.value = this.value;
      }
      compute();
    });
    elContInp.addEventListener('input', compute);

    // Toggle advanced
    function applyAdvVisibility() {
      const adv = toggleAdv.checked;
      document.querySelectorAll('.adv-only').forEach(el => {
        el.style.display = adv ? '' : 'none';
      });
    }
    toggleAdv.addEventListener('change', applyAdvVisibility);
    applyAdvVisibility();
    compute();
  })();
</script>
{% endblock %}
