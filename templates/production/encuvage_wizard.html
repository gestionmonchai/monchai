{% extends 'production/base_production.html' %}
{% block title %}Encuvage / Pressurage - Mon Chai{% endblock %}
{% block production_content %}
<h1 class="h4 mb-3">Encuvage / Pressurage</h1>

<div class="mb-3">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      {% for bc in breadcrumb_items %}
        {% if bc.name != 'Production' %}
          {% if bc.url %}
            <li class="breadcrumb-item"><a href="{{ bc.url }}">{{ bc.name }}</a></li>
          {% else %}
            <li class="breadcrumb-item active" aria-current="page">{{ bc.name }}</li>
          {% endif %}
        {% endif %}
      {% endfor %}
    </ol>
  </nav>
</div>

<div class="card mb-4 border-primary border-opacity-25">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-3">
        <div class="small text-muted text-uppercase">Date vendange</div>
        <div class="fw-medium">{{ vendange.date|date:"d/m/Y" }}</div>
      </div>
      <div class="col-md-3">
        <div class="small text-muted text-uppercase">Parcelle</div>
        <div class="fw-medium">{{ vendange.parcelle.nom }}</div>
      </div>
      <div class="col-md-3">
        <div class="small text-muted text-uppercase">Poids total</div>
        <div class="fw-medium">{{ vendange.poids_total|floatformat:0 }} kg</div>
      </div>
      <div class="col-md-3">
        <div class="small text-muted text-uppercase">Cuvée source</div>
        <div class="fw-medium">
            {% if vendange.cuvee %}
                {{ vendange.cuvee.nom }}
            {% else %}
                <span class="badge bg-warning text-dark">À définir</span>
            {% endif %}
        </div>
      </div>
    </div>
  </div>
  <div class="card-footer bg-light">
    <div class="small text-muted d-flex justify-content-between">
        <span>Restant disponible: <strong id="kg-restant-label">{{ defaults.kg_restant }}</strong> kg</span>
        <span>(Déjà débités: {{ defaults.kg_debites_cumules }} kg)</span>
    </div>
  </div>
 </div>

<form method="post" id="encuvage-form">
  {% csrf_token %}
  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card mb-3 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center bg-white py-3">
          <span class="fw-bold text-primary"><i class="bi bi-box-arrow-in-right me-2"></i>Configuration du lot</span>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="toggle-advanced">
            <label class="form-check-label small" for="toggle-advanced">Avancé</label>
          </div>
        </div>
        <div class="card-body">
          
          <!-- Section Cuvée (optionnelle) -->
          <div class="row g-3 mb-4">
            <div class="col-md-12">
                <label class="form-label fw-bold">Cuvée de destination <span class="text-muted small">(optionnel)</span></label>
                <div class="input-group">
                    <select name="cuvee_id" class="form-select">
                        <option value="">— Sans cuvée pour l'instant —</option>
                        {% for c in cuvees %}
                        <option value="{{ c.id }}" {% if vendange.cuvee_id == c.id %}selected{% endif %}>
                            {{ c.nom }}{% if c.code %} ({{ c.code }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <a href="{% url 'produits:cuvee_new' %}?next={{ request.path }}" class="btn btn-outline-secondary" title="Créer une nouvelle cuvée">
                        <i class="bi bi-plus-lg"></i>
                    </a>
                </div>
                <div class="form-text text-muted"><i class="bi bi-info-circle me-1"></i>Vous pourrez affecter une cuvée plus tard si besoin.</div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Kg à encuver</label>
              <div class="input-group">
                  <input type="number" step="0.01" min="0" class="form-control fw-bold" name="poids_debite_kg" id="kg-debites" value="{{ defaults.kg_restant }}" placeholder="{{ defaults.kg_restant }}">
                  <span class="input-group-text">kg</span>
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Ou Part (%)</label>
              <div class="input-group">
                  <input type="number" step="0.01" min="0" max="100" class="form-control" name="part_pct" id="part-pct" placeholder="100">
                  <span class="input-group-text">%</span>
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Volume obtenu (L)</label>
              <div class="input-group">
                  <input type="number" step="0.01" min="0" class="form-control" name="volume_mesure_l" id="vol-mesure" placeholder="Auto">
                  <span class="input-group-text">L</span>
              </div>
              <div class="form-text small">Laisser vide pour calculer via rendement</div>
            </div>
            
            <div class="col-md-6 adv-only">
              <label class="form-label text-muted small">Rendement théorique (L/kg)</label>
              <input type="number" step="0.0001" min="0" class="form-control form-control-sm" name="rendement_base" id="rdt-base" value="{{ defaults.rendement_base }}">
            </div>
            <div class="col-md-6 adv-only">
              <label class="form-label text-muted small">Efficacité extraction (%)</label>
              <input type="number" step="0.01" min="0" class="form-control form-control-sm" name="effic_pct" id="effic-pct" value="{{ defaults.effic_pct }}">
            </div>
          </div>

          <hr class="my-4">

          <div class="row g-3">
            <div class="col-md-8">
              <label class="form-label fw-bold">Contenant de réception <span class="text-danger">*</span></label>
              <div class="input-group">
                <select class="form-select" id="container-select">
                  <option value="">— Choisir ou saisir —</option>
                  {% if contenants %}
                    <optgroup label="Disponibles (Chai)">
                      {% for c in contenants %}
                        <option value="{{ c.code }}" data-free="{{ c.free }}" data-cap="{{ c.cap }}" data-type="{{ c.type }}">
                          {{ c.code }} (Libre: {{ c.free }} L)
                        </option>
                      {% endfor %}
                    </optgroup>
                  {% endif %}
                  <option value="__free__">Saisie manuelle...</option>
                </select>
                <input type="text" class="form-control" name="contenant" id="container-input" placeholder="Code cuve (ex: C12)" required>
              </div>
              <div id="container-capacity" class="small text-muted mt-1"></div>
              <div id="container-warning" class="alert alert-warning mt-2 py-2 small d-none"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-3 adv-only">
        <div class="card-header fw-semibold bg-white py-3">Options techniques</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label d-block">Mode encuvage</label>
              <div class="btn-group w-100" role="group">
                  <input type="radio" class="btn-check" name="mode_encuvage" id="mode-erafle" value="erafle" checked>
                  <label class="btn btn-outline-secondary" for="mode-erafle">Éraflé</label>

                  <input type="radio" class="btn-check" name="mode_encuvage" id="mode-foule" value="foule">
                  <label class="btn btn-outline-secondary" for="mode-foule">Foulé</label>

                  <input type="radio" class="btn-check" name="mode_encuvage" id="mode-pressurage" value="pressurage_direct">
                  <label class="btn btn-outline-secondary" for="mode-pressurage">Pres. Direct</label>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Type de lot</label>
              <select name="lot_type" id="lot-type" class="form-select">
                <option value="mout_encuve" selected>Moût en cuvaison</option>
                <option value="vin_de_goutte">Vin de goutte</option>
                <option value="vin_de_presse">Vin de presse</option>
                <option value="mout_mute">Moût muté</option>
              </select>
            </div>
            
            <div class="col-md-4">
              <label class="form-label">Température (°C)</label>
              <input type="number" step="0.1" class="form-control" name="temperature_c" id="temp-c" placeholder="ex: 18.5">
            </div>
            <div class="col-12">
              <label class="form-label">Notes / Observations</label>
              <textarea class="form-control" name="notes" id="notes" rows="2" placeholder="Intrants, état sanitaire, SO2..."></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between mt-4">
        <a href="/production/vendanges/{{ vendange.id }}/" class="btn btn-outline-secondary px-4">Annuler</a>
        <button type="submit" class="btn btn-primary px-4 py-2 fw-bold shadow-sm">
            <i class="bi bi-check-lg me-2"></i>Valider l'encuvage
        </button>
      </div>
    </div>

    <!-- Sidebar Résumé -->
    <div class="col-lg-4">
      <div class="card shadow-sm border-0 bg-primary text-white mb-3" style="background: linear-gradient(145deg, #8b1e3f, #6a102d);">
        <div class="card-body text-center py-4">
            <div class="small opacity-75 text-uppercase mb-1">Volume estimé</div>
            <div class="display-4 fw-bold mb-0"><span id="sum-vol">0</span> <span class="fs-4">L</span></div>
            <div class="small mt-2 opacity-75">Rendement: <span id="sum-lkg">-</span> L/kg</div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header fw-semibold bg-light">Détails de l'opération</div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between px-0">
                <span>Poids débité</span>
                <strong id="sum-kg">—</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between px-0">
                <span>Reste sur vendange</span>
                <span class="text-muted"><span id="sum-restant">—</span> kg</span>
            </li>
            <li class="list-group-item d-flex justify-content-between px-0">
                <span>Contenant</span>
                <strong id="sum-contenant" class="text-truncate" style="max-width: 150px;">—</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between px-0">
                <span>Coût matière (est.)</span>
                <strong id="sum-cost">—</strong>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</form>

<script>
  (function() {
    const elKg = document.getElementById('kg-debites');
    const elPct = document.getElementById('part-pct');
    const elVol = document.getElementById('vol-mesure');
    const elBase = document.getElementById('rdt-base');
    const elEffic = document.getElementById('effic-pct');
    const restant0 = parseFloat('{{ defaults.kg_restant|default:"0" }}') || 0;
    const prixKg = parseFloat('{{ defaults.prix_raisin_eur_kg|default:"" }}') || null;
    const elSumKg = document.getElementById('sum-kg');
    const elSumVol = document.getElementById('sum-vol');
    const elSumLkg = document.getElementById('sum-lkg');
    const elSumEffic = document.getElementById('sum-effic');
    const elSumCost = document.getElementById('sum-cost');
    const elSumRest = document.getElementById('sum-restant');
    const elContSel = document.getElementById('container-select');
    const elContInp = document.getElementById('container-input');
    const elSumCont = document.getElementById('sum-contenant');
    const toggleAdv = document.getElementById('toggle-advanced');
    const elContCap = document.getElementById('container-capacity');
    const elContWarn = document.getElementById('container-warning');

    function clamp(x) { return isFinite(x) && x > 0 ? x : 0; }

    function currentKg() {
      const pct = parseFloat(elPct.value);
      if (isFinite(pct) && pct > 0) return restant0 * (pct/100);
      const kg = parseFloat(elKg.value);
      return isFinite(kg) ? kg : 0;
    }

    function compute() {
      const kg = clamp(currentKg());
      const base = parseFloat(elBase.value);
      const measured = parseFloat(elVol.value);
      const efficPct = parseFloat(elEffic.value);
      const theoretic = isFinite(base) && base>0 ? kg * base : null;
      const usedVol = isFinite(measured) && measured>0 ? measured : (isFinite(base) && isFinite(efficPct) ? kg * base * (efficPct/100) : null);
      const lkg = (isFinite(kg) && kg>0 && isFinite(usedVol)) ? (usedVol/kg) : null;
      const effic = (theoretic && isFinite(usedVol)) ? (usedVol / theoretic * 100) : null;

      elSumKg.textContent = kg ? kg.toFixed(2) + ' kg' : '—';
      elSumVol.textContent = (usedVol ? usedVol.toFixed(2) + ' L' : '—') + (isFinite(measured) && measured>0 ? ' (mesuré)' : ' (calculé)');
      elSumLkg.textContent = lkg ? lkg.toFixed(3) : '—';
      if (effic != null) {
        elSumEffic.textContent = effic.toFixed(1) + '%';
        elSumEffic.className = 'badge ' + (effic>100 || effic<50 ? 'text-bg-warning' : 'text-bg-success');
      } else {
        elSumEffic.textContent = '—';
        elSumEffic.className = 'badge text-bg-secondary';
      }
      if (prixKg != null && kg) {
        elSumCost.textContent = (kg * prixKg).toFixed(2) + ' €';
      } else {
        elSumCost.textContent = '—';
      }
      const rest = Math.max(0, restant0 - kg);
      elSumRest.textContent = rest.toFixed(2);

      // Container binding
      const cont = elContInp.value || '';
      elSumCont.textContent = cont || '—';
      // Capacity info and warning
      let free = null, capU = null;
      if (elContSel && elContSel.selectedIndex >= 0) {
        const opt = elContSel.options[elContSel.selectedIndex];
        if (opt && opt.dataset) {
          const f = parseFloat(opt.dataset.free);
          const c = parseFloat(opt.dataset.cap);
          free = isFinite(f) ? f : null;
          capU = isFinite(c) ? c : null;
        }
      }
      if (capU != null) {
        elContCap.textContent = `Capacité utile: ${capU.toFixed(2)} L` + (free!=null ? ` — Libre: ${free.toFixed(2)} L` : '');
      } else {
        elContCap.textContent = '';
      }
      if (free != null && isFinite(usedVol)) {
        if (usedVol > free + 1e-6) {
          elContWarn.textContent = `Volume estimé ${usedVol.toFixed(2)} L supérieur au libre ${free.toFixed(2)} L`;
          elContWarn.classList.remove('d-none');
        } else {
          elContWarn.classList.add('d-none');
          elContWarn.textContent = '';
        }
      } else {
        elContWarn.classList.add('d-none');
        elContWarn.textContent = '';
      }
    }

    elKg.addEventListener('input', compute);
    elPct.addEventListener('input', compute);
    elVol.addEventListener('input', compute);
    elBase.addEventListener('input', compute);
    elEffic.addEventListener('input', compute);
    elContSel.addEventListener('change', function() {
      if (this.value === '__free__') {
        elContInp.value = '';
        elContInp.focus();
      } else {
        elContInp.value = this.value;
      }
      compute();
    });
    elContInp.addEventListener('input', compute);

    // Toggle advanced
    function applyAdvVisibility() {
      const adv = toggleAdv.checked;
      document.querySelectorAll('.adv-only').forEach(el => {
        el.style.display = adv ? '' : 'none';
      });
    }
    toggleAdv.addEventListener('change', applyAdvVisibility);
    applyAdvVisibility();
    compute();
  })();
</script>
{% endblock %}
