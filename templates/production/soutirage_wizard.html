{% extends 'production/base_production.html' %}
{% load smart_tags %}
{% block title %}Soutirage – {{ lot.code }}{% endblock %}
{% block production_content %}
<div class="container-fluid">
  <h1 class="h4 mb-4">Assistant Soutirage – <span class="text-muted">{{ lot.code }}</span></h1>

  <div class="alert alert-info">
    <strong>Lot source :</strong> {{ lot.code }} ({{ lot.campagne }})<br>
    Volume actuel : <strong>{{ lot.volume_l|floatformat:2 }} L</strong><br>
    Contenant actuel : {{ lot.contenant }}
  </div>

  <form method="post" class="card shadow-sm">
    {% csrf_token %}
    <div class="card-header bg-white py-3">
      <h5 class="card-title mb-0">Paramètres de l'opération</h5>
    </div>
    <div class="card-body">
      <div class="row g-4">
        <!-- Colonne Gauche: Séparation -->
        <div class="col-md-6 border-end">
          <h6 class="text-uppercase text-muted small mb-3">1. Séparation</h6>
          
          <div class="mb-3">
            <label class="form-label fw-bold text-danger">Volume de Lies / Bourbes (L)</label>
            {{ form.volume_lies_pertes_l }}
            <div class="form-text">Volume éliminé ou perdu lors de l'opération. Sera déduit du total.</div>
            {% if form.volume_lies_pertes_l.errors %}
              <div class="text-danger small mt-1">{{ form.volume_lies_pertes_l.errors|join:', ' }}</div>
            {% endif %}
          </div>

          <div class="mb-3">
             <label class="form-label">Type de soutirage</label>
             <select name="type_soutirage" class="form-select">
               <option value="aere">Aéré (oxygénation)</option>
               <option value="protege" selected>Protégé (sous gaz neutre)</option>
             </select>
          </div>
        </div>

        <!-- Colonne Droite: Destination -->
        <div class="col-md-6">
          <h6 class="text-uppercase text-muted small mb-3">2. Destination du Vin Clair</h6>
          
          {% if cuve_suggestions %}
          <div class="mb-3">
            <label class="form-label fw-bold text-success">
              <i class="bi bi-lightbulb text-warning me-1"></i>Cuves suggérées
              <span class="badge bg-warning-subtle text-warning-emphasis ms-1">✨ IA</span>
            </label>
            <div class="row g-2">
              {% for s in cuve_suggestions %}
              <div class="col-6 col-lg-4">
                <div class="card cuve-card h-100 {% if s.highlight == 'perfect' %}border-success glow-success{% elif s.highlight == 'good' %}border-primary{% elif s.highlight == 'disabled' %}disabled opacity-50{% endif %}"
                     data-cuve-code="{{ s.contenant.code }}"
                     onclick="{% if s.highlight != 'disabled' %}selectCuve('{{ s.contenant.code }}'){% endif %}"
                     style="cursor: {% if s.highlight != 'disabled' %}pointer{% else %}not-allowed{% endif %};">
                  <div class="card-body p-2 text-center">
                    <div class="fw-bold">{{ s.contenant.code }}</div>
                    <div class="small text-muted">{{ s.contenant.capacite_l|floatformat:0 }} L</div>
                    <div class="progress mt-1" style="height: 4px;">
                      <div class="progress-bar {% if s.contenant.occupancy_pct > 80 %}bg-danger{% elif s.contenant.occupancy_pct > 50 %}bg-warning{% else %}bg-success{% endif %}" 
                           style="width: {{ s.contenant.occupancy_pct }}%"></div>
                    </div>
                    <div class="small mt-1">
                      {% if s.highlight == 'perfect' %}
                      <span class="text-success"><i class="bi bi-check-circle-fill"></i> Parfait</span>
                      {% elif s.highlight == 'good' %}
                      <span class="text-primary"><i class="bi bi-hand-thumbs-up"></i> Bon</span>
                      {% elif s.highlight == 'disabled' %}
                      <span class="text-muted">Indisponible</span>
                      {% else %}
                      <span class="text-secondary">Possible</span>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            <div class="form-text mt-2">
              <i class="bi bi-info-circle"></i> Cliquez sur une cuve pour la sélectionner
            </div>
          </div>
          {% endif %}
          
          <div class="mb-3">
            <label class="form-label fw-bold text-success">Nouveau contenant (Transfert)</label>
            {{ form.destination_contenant }}
            <div class="form-text">
              Saisissez le code/nom de la cuve propre de destination.<br>
              <i class="bi bi-info-circle"></i> Si laissé vide, le vin clair reste dans le contenant actuel (soutirage "sur place").
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Notes / Observations</label>
            {{ form.notes }}
            <div class="form-text">Ex: aspect des lies, turbidité, etc.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="card-footer bg-light d-flex justify-content-between py-3">
      <a href="/production/lots-techniques/{{ lot.id }}/" class="btn btn-outline-secondary">Annuler</a>
      <button type="submit" class="btn btn-primary px-4">
        <i class="bi bi-check-lg"></i> Valider le soutirage
      </button>
    </div>
  </form>

  <!-- Style rapide pour les inputs -->
  <style>
    input[name="volume_lies_pertes_l"] {
      font-size: 1.2rem;
      font-weight: bold;
      color: #dc3545;
      border-color: #dc3545;
    }
    input[name="destination_contenant"] {
      border-color: #198754;
    }
    .cuve-card { transition: all 0.2s ease; border: 2px solid transparent; }
    .cuve-card:hover:not(.disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .cuve-card.selected { border-color: #198754 !important; box-shadow: 0 0 0 3px rgba(25, 135, 84, 0.25); }
    .glow-success { animation: glow-pulse 2s ease-in-out infinite alternate; }
    @keyframes glow-pulse { from { box-shadow: 0 0 5px rgba(25, 135, 84, 0.3); } to { box-shadow: 0 0 15px rgba(25, 135, 84, 0.5); } }
  </style>
  <script>
  function selectCuve(code) {
    // Mettre à jour le champ de destination
    var input = document.querySelector('input[name="destination_contenant"]');
    if (input) {
      input.value = code;
      input.dispatchEvent(new Event('change'));
    }
    // Marquer visuellement la cuve sélectionnée
    document.querySelectorAll('.cuve-card').forEach(function(card) {
      card.classList.remove('selected');
    });
    var selected = document.querySelector('.cuve-card[data-cuve-code="' + code + '"]');
    if (selected) {
      selected.classList.add('selected');
    }
  }
  </script>
</div>
{% endblock %}
