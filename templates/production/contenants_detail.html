{% extends 'production/base_production.html' %}
{% load static %}
{% block title %}Fiche contenant - Mon Chai{% endblock %}
{% block production_content %}
<h1 class="h4 mb-3 d-flex align-items-center gap-3">
  <span>Contenant {{ contenant.code }}</span>
  <span class="badge text-bg-secondary">{{ contenant.get_type_display }}</span>
  <span class="badge text-bg-light">Statut: {{ contenant.get_statut_display }}</span>
  {% if contenant.localisation %}<span class="badge text-bg-info">{{ contenant.localisation }}</span>{% endif %}
</h1>

<ul class="nav nav-tabs mb-3" id="tabsContenant" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="tab-resume-tab" data-bs-toggle="tab" data-bs-target="#tab-resume" type="button" role="tab">Résumé</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-occupation-tab" data-bs-toggle="tab" data-bs-target="#tab-occupation" type="button" role="tab">Occupation actuelle</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-mouvements-tab" data-bs-toggle="tab" data-bs-target="#tab-mouvements" type="button" role="tab">Historique mouvements</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-maintenance-tab" data-bs-toggle="tab" data-bs-target="#tab-maintenance" type="button" role="tab">Maintenance / HACCP</button>
  </li>
</ul>

<div class="tab-content" id="tabsContenantContent">
  <!-- Résumé -->
  <div class="tab-pane fade show active" id="tab-resume" role="tabpanel">
    <div class="row g-3 mb-3">
      <div class="col-lg-8">
        <div class="card mb-3">
          <div class="card-header fw-semibold">Capacités & état</div>
          <div class="card-body">
            <div class="row g-3 align-items-center">
              <div class="col-md-4">
                <div class="text-center">
                  <div class="progress-circle" style="--pct: {{ occupancy_pct|default:'0' }}%">
                    <div class="pct">{{ occupancy_pct|floatformat:0 }}%</div>
                  </div>
                  <div class="small text-muted mt-2">Taux d'occupation</div>
                </div>
              </div>
              <div class="col-md-8">
                <div class="row g-3">
                  <div class="col-md-6"><strong>Capacité nominale</strong><div>{{ contenant.capacite_l }} L</div></div>
                  <div class="col-md-6"><strong>Capacité utile</strong><div>{{ contenant.capacite_utile_l|default:contenant.capacite_l }} L</div></div>
                  <div class="col-md-6"><strong>Occupé</strong><div>{{ contenant.volume_occupe_l }} L</div></div>
                  <div class="col-md-6"><strong>Libre</strong><div>{{ free_capacity_l }} L</div></div>
                  <div class="col-md-6"><strong>Thermo-régulé</strong><div>{% if contenant.thermo_regule %}Oui{% else %}Non{% endif %}</div></div>
                  <div class="col-md-6"><strong>Temp. cible</strong><div>{{ contenant.temperature_cible|default:'—' }} {% if contenant.temperature_cible %}°C{% endif %}</div></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header fw-semibold">Lot & localisation</div>
          <div class="card-body row g-3">
            <div class="col-md-4"><strong>Lot courant</strong><div>{% if contenant.lot_courant %}<a href="/production/lots-techniques/{{ contenant.lot_courant.id }}/">{{ contenant.lot_courant.code }}</a>{% else %}—{% endif %}</div></div>
            <div class="col-md-4"><strong>Localisation</strong><div>{{ contenant.localisation|default:'—' }}</div></div>
            <div class="col-md-4"><strong>Organisation</strong><div>{{ contenant.organization|default:'—' }}</div></div>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card mb-3">
          <div class="card-header fw-semibold">Actions</div>
          <div class="card-body d-grid gap-2">
            <a href="/production/contenants/{{ contenant.id }}/edit/" class="btn btn-outline-primary">Modifier</a>
            <form method="post" action="/production/contenants/{{ contenant.id }}/occupancy/recalc/">
              {% csrf_token %}
              <button class="btn btn-outline-secondary w-100" type="submit">Recalculer occupation</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Occupation actuelle -->
  <div class="tab-pane fade" id="tab-occupation" role="tabpanel">
    <div class="card mb-3">
      <div class="card-header fw-semibold">Affectation du lot</div>
      <div class="card-body">
        <form method="post" action="/production/contenants/{{ contenant.id }}/actions/affecter-lot/" class="row g-3">
          {% csrf_token %}
          <div class="col-md-6">
            <label class="form-label">Lot</label>
            <select name="lot_id" class="form-select" required>
              <option value="">— Sélectionner —</option>
              {% for lot in lots %}
                <option value="{{ lot.id }}">{{ lot.code }} — {{ lot.volume_l }} L</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Volume (L)</label>
            <input type="number" step="0.01" min="0" name="volume_l" class="form-control" placeholder="0">
          </div>
          <div class="col-md-3 align-self-end">
            <button class="btn btn-primary" type="submit">Affecter</button>
          </div>
        </form>
        <hr>
        <div class="d-flex gap-2">
          <form method="post" action="/production/contenants/{{ contenant.id }}/actions/vidange/">{% csrf_token %}<button class="btn btn-outline-danger" type="submit">Vidange</button></form>
          <form method="post" action="/production/contenants/{{ contenant.id }}/actions/nettoyage/">{% csrf_token %}<button class="btn btn-outline-secondary" type="submit">Nettoyage</button></form>
        </div>
      </div>
    </div>
  </div>

  <!-- Historique mouvements -->
  <div class="tab-pane fade" id="tab-mouvements" role="tabpanel">
    <div class="card">
      <div class="card-header fw-semibold">Derniers mouvements du lot courant</div>
      <div class="card-body">
        {% if mouvements %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead><tr><th>Date</th><th>Type</th><th class="text-end">Volume (L)</th><th>Note</th></tr></thead>
            <tbody>
              {% for m in mouvements %}
              <tr>
                <td>{{ m.date }}</td>
                <td>{{ m.get_type_display }}</td>
                <td class="text-end">{{ m.volume_l }}</td>
                <td>{{ m.meta.note|default:'—' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="text-end">
          {% if contenant.lot_courant %}<a href="/production/lots-techniques/{{ contenant.lot_courant.id }}/mouvements/export/" class="btn btn-sm btn-outline-secondary">Export CSV</a>{% endif %}
        </div>
        {% else %}
          <div class="text-muted">Aucun mouvement disponible.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Maintenance / HACCP -->
  <div class="tab-pane fade" id="tab-maintenance" role="tabpanel">
    <div class="card mb-3">
      <div class="card-header fw-semibold">Suivi sanitaire</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3"><strong>Dernier nettoyage</strong><div>{{ contenant.date_dernier_nettoyage|default:'—' }}</div></div>
          <div class="col-md-3"><strong>Prochain nettoyage</strong><div>{{ next_nettoyage|default:'—' }}</div></div>
          <div class="col-md-3"><strong>Dernier ouillage</strong><div>{{ contenant.date_dernier_ouillage|default:'—' }}</div></div>
          <div class="col-md-3"><strong>Prochain ouillage</strong><div>{{ next_ouillage|default:'—' }}</div></div>
          <div class="col-12"><strong>Notes sanitaires</strong><div>{{ contenant.note_sanitaire|linebreaks }}</div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.progress-circle { width: 140px; height: 140px; border-radius: 50%; background: conic-gradient(#8b1e3f var(--pct), #f1f5f9 0); display: grid; place-items: center; margin: 0 auto; position: relative; }
.progress-circle::after { content: ""; width: 110px; height: 110px; border-radius: 50%; background: #fff; position: absolute; }
.progress-circle .pct { position: relative; font-weight: 700; }
</style>
{% endblock %}
