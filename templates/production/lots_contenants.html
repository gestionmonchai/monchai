{% extends 'production/base_production.html' %}
{% block title %}Cuves & barriques - Mon Chai{% endblock %}
{% block production_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Cuves & barriques</h1>
  <div class="btn-group">
    <a href="{% url 'production:container_create' %}" class="btn btn-primary">
      <i class="bi bi-plus-circle me-1"></i>Nouvelle cuve / barrique
    </a>
  </div>
</div>


<div class="row g-3 mb-3">
  <div class="col-md-3"><div class="card p-3"><div class="small text-muted">Cuves & barriques</div><div class="fs-4">{{ kpi.count|default:"—" }}</div></div></div>
  <div class="col-md-3"><div class="card p-3"><div class="small text-muted">Capacité totale (hL)</div><div class="fs-4">{% if kpi.total_capacity_l %}{% widthratio kpi.total_capacity_l 100 1 %}{% else %}0{% endif %}</div></div></div>
  <div class="col-md-3"><div class="card p-3"><div class="small text-muted">Occupé total (hL)</div><div class="fs-4">{% if kpi.total_occupied_l %}{% widthratio kpi.total_occupied_l 100 1 %}{% else %}0{% endif %}</div></div></div>
  <div class="col-md-3"><div class="card p-3"><div class="small text-muted">Taux moyen (%)</div><div class="fs-4">{% if kpi.total_capacity_l and kpi.total_capacity_l > 0 %}{% widthratio kpi.total_occupied_l kpi.total_capacity_l 100 %}{% else %}0{% endif %}</div></div></div>
</div>

<form method="get" class="row g-2 align-items-end mb-3">
  <div class="col-md-3">
    <label class="form-label">Type</label>
    <select name="type" class="form-select">
      <option value="">Tous</option>
      <option value="cuve" {% if selected.type == 'cuve' %}selected{% endif %}>Cuve</option>
      <option value="fut" {% if selected.type == 'fut' %}selected{% endif %}>Fût</option>
      <option value="barrique" {% if selected.type == 'barrique' %}selected{% endif %}>Barrique</option>
      <option value="autre" {% if selected.type == 'autre' %}selected{% endif %}>Autre</option>
    </select>
  </div>
  <div class="col-md-5">
    <label class="form-label">Recherche</label>
    <input type="search" name="q" value="{{ selected.q }}" class="form-control" placeholder="lot, cuvée, identifiant...">
  </div>
  <div class="col-md-4 text-end">
    <button class="btn btn-primary">Filtrer</button>
  </div>
</form>

<style>
.container-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
.container-card { position: relative; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; background: #fff; overflow: hidden; }
.container-card .title { font-weight: 600; }
.progress-circle { width: 120px; height: 120px; border-radius: 50%; background: conic-gradient(#8b1e3f var(--pct), #f1f5f9 0); display: grid; place-items: center; margin: 0 auto; position: relative; }
.progress-circle::after { content: ""; width: 92px; height: 92px; border-radius: 50%; background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.6)); position: absolute; }
.progress-circle .pct { position: relative; font-weight: 700; }
.wine-anim { position: absolute; left: -20%; right: -20%; bottom: -10px; height: 40%; background: radial-gradient(ellipse at center, rgba(139,30,63,.25) 0%, rgba(139,30,63,.45) 60%, rgba(139,30,63,.6) 100%); filter: blur(10px); animation: sway 5s ease-in-out infinite; }
@keyframes sway { 0% { transform: translateY(0) rotate(-1deg);} 50% { transform: translateY(-4px) rotate(1deg);} 100% { transform: translateY(0) rotate(-1deg);} }
.badge-type { background: #f1f5f9; border-radius: 9999px; padding: 2px 8px; font-size: 12px; }
.meta { font-size: 12px; color: #6b7280; }
</style>

<div class="container-grid">
  {% for c in cards %}
  <div class="container-card">
    <div class="d-flex justify-content-between align-items-start mb-2">
      <div>
        <div class="title">{{ c.type }} {{ c.identifiant }}</div>
        <div class="meta">Lot {{ c.lot_code }} · {{ c.cuvee }} · {{ c.warehouse }}</div>
      </div>
      <span class="badge-type">{{ c.capacity }} L</span>
    </div>
    <div class="d-flex align-items-center gap-3">
      <div class="position-relative">
        <div class="progress-circle" style="--pct: {{ c.pct }}%">
          <div class="pct">{{ c.pct|floatformat:0 }}%</div>
        </div>
        <div class="wine-anim" style="opacity: .85"></div>
      </div>
      <div>
        <div><strong>Occupé</strong>: {{ c.occupied }} L</div>
        <div><strong>Libre</strong>: —</div>
      </div>
    </div>
    <a href="/production/contenants/{{ c.id }}/" class="stretched-link" aria-label="Ouvrir la fiche"></a>
  </div>
  {% empty %}
  <div class="text-muted">Aucune cuve ou barrique trouvée.</div>
  {% endfor %}
</div>
<div id="container-modal"></div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/htmx.org@1.9.12"></script>
{% endblock %}
