{% extends 'production/base_production.html' %}
{% block title %}Encuvages - Mon Chai{% endblock %}
{% block production_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Encuvages & Pressurages</h1>
  <div class="btn-group">
    <a class="btn btn-outline-secondary" href="/production/vendanges/">
        <i class="bi bi-arrow-left me-1"></i>Voir vendanges
    </a>
    <a class="btn btn-primary" href="/production/pressurages/">
        <i class="bi bi-droplet-half me-1"></i>Pressurages
    </a>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h6 class="mb-0"><i class="bi bi-funnel me-2"></i>Filtres de recherche</h6>
      <div class="btn-group btn-group-sm" role="group">
        <button type="button" class="btn btn-outline-secondary" id="toggle-advanced-search">
          <i class="bi bi-chevron-down"></i> Avancé
        </button>
        <button type="button" class="btn btn-outline-danger" id="clear-filters">
          <i class="bi bi-x-circle"></i> Effacer
        </button>
      </div>
    </div>

    <form id="encuvages-filter-form"
          hx-get="{% url 'production:encuvages_table' %}"
          hx-target="#encuvages-table"
          hx-swap="innerHTML"
          hx-trigger="change, keyup delay:200ms from:input">
      <!-- Recherche rapide -->
      <div class="row mb-3">
        <div class="col-md-8">
          <div class="position-relative">
            <input type="text" name="q" id="quick-search" value="{{ selected.q }}" placeholder="Recherche rapide (code, cuvée)" class="form-control pe-5" autocomplete="off">
            <div class="position-absolute top-50 end-0 translate-middle-y me-3">
              <i class="bi bi-search text-muted" id="search-icon"></i>
              <div class="spinner-border spinner-border-sm text-primary d-none" id="search-spinner" role="status">
                <span class="visually-hidden">Recherche...</span>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div id="search-info" class="text-muted small mt-2">—</div>
        </div>
      </div>

      <!-- Filtres avancés -->
      <div id="advanced-filters" class="collapse">
        <hr>
        <div class="row g-2">
          <div class="col-md-3">
            <label class="form-label">Statut</label>
            <select name="statut" class="form-select">
              <option value="">— Tous —</option>
              {% for code,label in statut_choices %}
                <option value="{{ code }}" {% if selected.statut == code %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Code</label>
            <input type="text" name="code" value="{{ selected.code }}" class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label">Cuvée</label>
            <input type="text" name="cuvee" value="{{ selected.cuvee }}" class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label">Campagne</label>
            <input type="text" name="campagne" value="{{ selected.campagne }}" class="form-control">
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<div id="encuvages-table" hx-get="{% url 'production:encuvages_table' %}" hx-trigger="load" hx-target="#encuvages-table" hx-swap="innerHTML">
  <div class="text-center text-muted py-4">Chargement…</div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const advBtn = document.getElementById('toggle-advanced-search');
    const clearBtn = document.getElementById('clear-filters');
    const adv = document.getElementById('advanced-filters');
    const quick = document.getElementById('quick-search');
    const spinner = document.getElementById('search-spinner');
    const icon = document.getElementById('search-icon');
    const info = document.getElementById('search-info');
    const form = document.getElementById('encuvages-filter-form');

    function setLoading(isLoading) {
      if (isLoading) {
        spinner.classList.remove('d-none');
        icon.classList.add('d-none');
      } else {
        spinner.classList.add('d-none');
        icon.classList.remove('d-none');
      }
    }

    if (advBtn && adv) {
      advBtn.addEventListener('click', function() {
        adv.classList.toggle('show');
        const i = advBtn.querySelector('i');
        if (i) i.className = adv.classList.contains('show') ? 'bi bi-chevron-up' : 'bi bi-chevron-down';
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener('click', function() {
        form.reset();
        form.dispatchEvent(new Event('change', { bubbles: true }));
      });
    }

    if (quick) {
      quick.addEventListener('input', function() { setLoading(true); });
    }

    document.body.addEventListener('htmx:afterSwap', function(evt) {
      if (evt.target && evt.target.id === 'encuvages-table') {
        setLoading(false);
        const meta = document.getElementById('encuvages-table-meta');
        if (meta && info) {
          const total = meta.getAttribute('data-total') || '0';
          info.textContent = total + ' encuvage' + (parseInt(total) > 1 ? 's' : '');
        }
      }
    });
  });
</script>

<!-- Section: À encuver (Vendanges en attente) -->
{% if vendanges_todo %}
<div class="card border-warning mb-4 shadow-sm">
  <div class="card-header bg-warning bg-opacity-10 border-warning text-warning-emphasis d-flex align-items-center fw-bold">
    <i class="bi bi-exclamation-triangle me-2"></i>Vendanges en attente d'encuvage
  </div>
  <div class="list-group list-group-flush">
    {% for v in vendanges_todo %}
    <div class="list-group-item d-flex justify-content-between align-items-center">
      <div>
        <div class="fw-bold">{{ v.parcelle.nom }} <span class="badge bg-light text-dark border ms-2">{{ v.date|date:"d/m" }}</span></div>
        <div class="small text-muted">
           Reçu: {{ v.poids_kg|default:"0" }} kg &middot; Reste à encuver: <strong class="text-dark">{{ v.kg_restant }} kg</strong>
        </div>
      </div>
      <a href="{% url 'production:vendange_encuvage' v.id %}" class="btn btn-sm btn-warning fw-bold shadow-sm">
        Encuver &rarr;
      </a>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Section: Lots en cours -->
<div class="card shadow-sm border-0">
  <div class="card-header bg-transparent py-3">
    <h6 class="mb-0 fw-bold">Cuves en fermentation / macération</h6>
  </div>
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="bg-light text-muted small text-uppercase">
        <tr>
          <th class="ps-3">Lot / Code</th>
          <th>Cuve</th>
          <th>Volume</th>
          <th>Statut</th>
          <th>Créé le</th>
          <th class="text-end pe-3">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for lot in lots %}
        <tr class="row-click cursor-pointer" data-href="{% url 'production:lot_tech_detail' lot.id %}">
          <td class="ps-3">
            <div class="fw-bold text-dark">{{ lot.code }}</div>
            <div class="small text-muted">{{ lot.cuvee.nom|default:"Sans cuvée" }}</div>
          </td>
          <td>
             {% if lot.contenant %}
             <span class="badge bg-secondary">{{ lot.contenant }}</span>
             {% else %}
             <span class="text-muted">—</span>
             {% endif %}
          </td>
          <td><span class="font-monospace fw-bold">{{ lot.volume_l|floatformat:0 }}</span> <small class="text-muted">L</small></td>
          <td>
            {% if 'FA' in lot.statut %}<span class="badge bg-danger bg-opacity-10 text-danger border border-danger">FA En cours</span>
            {% elif 'ENCUVE' in lot.statut %}<span class="badge bg-primary bg-opacity-10 text-primary border border-primary">Encuvé</span>
            {% else %}<span class="badge bg-light text-dark border">{{ lot.get_statut_display }}</span>
            {% endif %}
          </td>
          <td class="text-muted small">{{ lot.created_at|date:"d/m/Y" }}</td>
          <td class="text-end pe-3" onclick="event.stopPropagation()">
            <div class="dropdown">
              <button class="btn btn-sm btn-light border" data-bs-toggle="dropdown">
                <i class="bi bi-three-dots"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="{% url 'production:lot_tech_detail' lot.id %}">Voir fiche lot</a></li>
                <li><a class="dropdown-item" href="{% url 'production:lot_tech_pressurage' lot.id %}">Pressurage / Décuvage...</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#">Saisir analyse</a></li>
              </ul>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center py-5 text-muted">
            <i class="bi bi-inbox fs-1 d-block mb-3 opacity-25"></i>
            Aucun lot en cours de vinification.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  {% if is_paginated %}
  <div class="card-footer bg-white">
    <!-- Pagination simple -->
    <ul class="pagination justify-content-center mb-0">
        {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">&laquo;</a></li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>
        {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">&raquo;</a></li>
        {% endif %}
    </ul>
  </div>
  {% endif %}
</div>
{% endblock %}
