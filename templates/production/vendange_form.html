{% extends 'production/base_production.html' %}
{% load widget_tweaks %}
{% block title %}{% if is_edit %}Modifier la vendange{% else %}Nouvelle vendange{% endif %} - Mon Chai{% endblock %}
{% block production_content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb mb-0">
    <li class="breadcrumb-item"><a href="{% url 'production:production_home' %}" class="text-decoration-none">Production</a></li>
    <li class="breadcrumb-item"><a href="{% url 'production:vendanges_list' %}" class="text-decoration-none">Vendanges</a></li>
    <li class="breadcrumb-item active" aria-current="page">{% if is_edit %}{{ vendange.code }}{% else %}Nouvelle{% endif %}</li>
  </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 mb-0">{% if is_edit %}Modifier la vendange {{ vendange.code }}{% else %}Nouvelle vendange{% endif %}</h1>
    <p class="text-muted mb-0 small">{% if is_edit %}Modifiez les informations de cette réception{% else %}Enregistrez une réception de raisins{% endif %}</p>
  </div>
  <a href="{% url 'production:vendanges_list' %}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left me-1"></i>Retour</a>
</div>

<form method="post" class="">
  {% csrf_token %}
  
  {% if form.non_field_errors %}
  <div class="alert alert-danger shadow-sm border-danger">
      <div class="d-flex">
          <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
          <div>
              <h6 class="alert-heading fw-bold mb-1">Erreur de validation</h6>
              <ul class="mb-0 ps-3">
              {% for error in form.non_field_errors %}
                  <li>{{ error }}</li>
              {% endfor %}
              </ul>
          </div>
      </div>
  </div>
  {% endif %}
  
  {% if lignes_formset.non_form_errors %}
  <div class="alert alert-danger">{{ lignes_formset.non_form_errors }}</div>
  {% endif %}

  <div class="row">
    <!-- Colonne principale -->
    <div class="col-lg-8">
      <!-- Étape 1 : Infos générales -->
      <div class="card mb-3 shadow-sm border-0">
        <div class="card-header bg-white fw-semibold py-3 border-bottom"><i class="bi bi-1-circle me-2 text-primary"></i>Infos générales</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-medium">Parcelle <span class="text-danger">*</span></label>
              <div class="input-group has-validation">
                {{ form.parcelle|add_class:'form-select' }}
                <a class="btn btn-outline-secondary" href="{% url 'referentiels:parcelle_create' %}?next={% url 'production:vendange_new' %}" target="_blank" title="Créer une parcelle">+</a>
                {% if form.parcelle.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.parcelle.errors|join:", " }}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="col-md-3">
              <label class="form-label fw-medium">{{ form.date.label }} <span class="text-danger">*</span></label>
              {{ form.date|add_class:'form-control' }}
              {% if form.date.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.date.errors|join:", " }}
                  </div>
              {% endif %}
            </div>
            <div class="col-md-3">
              {{ form.type_vendange.label_tag }}
              {{ form.type_vendange }}
              {% if form.type_vendange.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.type_vendange.errors|join:", " }}
                  </div>
              {% endif %}
            </div>
          </div>
          <div class="row g-3 mt-1">
            <div class="col-md-4">
              <label class="form-label">Cuvée (destination)</label>
              {{ form.cuvee }}
              <div class="form-text text-muted">Optionnel</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Type de récolte</label>
              <!-- Widget manuel pour matcher le design system mais connecté au form -->
              <select name="type_recolte" class="form-select">
                <option value="">— Sélectionner —</option>
                {% with val=form.type_recolte.value|default:form.instance.type_recolte|default:'' %}
                <option value="blanc" {% if val == 'blanc' %}selected{% endif %}>Blanc</option>
                <option value="rouge" {% if val == 'rouge' %}selected{% endif %}>Rouge</option>
                <option value="rose" {% if val == 'rose' or val == 'rosé' %}selected{% endif %}>Rosé</option>
                <option value="base_effervescente" {% if val == 'base_effervescente' %}selected{% endif %}>Base effervescente</option>
                {% endwith %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Statut</label>
              {{ form.statut }}
              {% if form.statut.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.statut.errors|join:", " }}
                  </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      
      <!-- Étape 2 : Répartition par cépage -->
      <div class="card mb-3">
        <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
          <span><i class="bi bi-2-circle me-2"></i>Répartition par cépage</span>
          <span class="badge bg-primary" id="total-kg-badge">Total: 0 kg</span>
        </div>
        <div class="card-body p-0">
          <!-- Info encépagement parcelle -->
          <div class="alert alert-light border-0 rounded-0 mb-0 py-2 px-3" id="encepagement-info" style="display: none;">
            <small><i class="bi bi-info-circle text-primary me-1"></i><strong>Cépages sur cette parcelle :</strong> <span id="encepagement-detail">—</span></small>
          </div>
          
          {{ lignes_formset.management_form }}
          
          <!-- Template caché pour le JS (empty_form) -->
          <div id="empty-row-template" style="display:none">
            <tr class="ligne-row">
              <td>
                {{ lignes_formset.empty_form.id }}
                {{ lignes_formset.empty_form.cepage }}
              </td>
              <td>{{ lignes_formset.empty_form.quantite_kg }}</td>
              <td>{{ lignes_formset.empty_form.rangs_texte }}</td>
              <td>{{ lignes_formset.empty_form.degre_potentiel }}</td>
              <td>{{ lignes_formset.empty_form.notes }}</td>
              <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger remove-row-btn" title="Supprimer">
                    <i class="bi bi-trash"></i>
                </button>
                <div style="display:none">{{ lignes_formset.empty_form.DELETE }}</div>
              </td>
            </tr>
          </div>

          <div class="table-responsive">
            <table class="table table-sm mb-0" id="lignes-table">
              <thead class="table-light">
                <tr>
                  <th style="width: 25%;">Cépage <span class="text-danger">*</span></th>
                  <th style="width: 15%;">Kg <span class="text-danger">*</span></th>
                  <th style="width: 20%;">Rangs</th>
                  <th style="width: 10%;">Degré</th>
                  <th style="width: 25%;">Notes</th>
                  <th style="width: 5%;"></th>
                </tr>
              </thead>
              <tbody id="lignes-tbody">
                {% for ligne_form in lignes_formset %}
                <tr class="ligne-row">
                  <td>
                    {{ ligne_form.id }}
                    {{ ligne_form.cepage }}
                    {% if ligne_form.cepage.errors %}
                        <div class="invalid-feedback d-block small">{{ ligne_form.cepage.errors|join:", " }}</div>
                    {% endif %}
                  </td>
                  <td>
                      {{ ligne_form.quantite_kg }}
                      {% if ligne_form.quantite_kg.errors %}
                        <div class="invalid-feedback d-block small">{{ ligne_form.quantite_kg.errors|join:", " }}</div>
                      {% endif %}
                  </td>
                  <td>{{ ligne_form.rangs_texte }}</td>
                  <td>{{ ligne_form.degre_potentiel }}</td>
                  <td>{{ ligne_form.notes }}</td>
                  <td class="text-center">
                    {% if ligne_form.instance.pk %}
                    <div class="form-check d-flex justify-content-center">
                      {{ ligne_form.DELETE }}
                    </div>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="p-2 border-top bg-light">
            <button type="button" class="btn btn-sm btn-outline-success" id="add-ligne-btn">
              <i class="bi bi-plus-lg me-1"></i>Ajouter une ligne
            </button>
          </div>
        </div>
      </div>
      
      <!-- Onglets secondaires -->
      <ul class="nav nav-tabs mb-3" id="vendangeTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-reception-tab" data-bs-toggle="tab" data-bs-target="#tab-reception" type="button" role="tab">Réception & tri</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-mesures-tab" data-bs-toggle="tab" data-bs-target="#tab-mesures" type="button" role="tab">Mesures</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-notes-tab" data-bs-toggle="tab" data-bs-target="#tab-notes" type="button" role="tab">Notes</button>
        </li>
      </ul>
      
      <div class="tab-content" id="vendangeTabsContent">
        <div class="tab-pane fade show active" id="tab-reception" role="tabpanel">
          <div class="row g-3">
            <div class="col-md-3">{{ form.temperature_c.label_tag }} {{ form.temperature_c|add_class:'form-control' }}</div>
            <div class="col-md-3">{{ form.tri.label_tag }} <div>{{ form.tri }}</div></div>
            <div class="col-md-6">{{ form.tri_notes.label_tag }} {{ form.tri_notes|add_class:'form-control' }}</div>
            <div class="col-md-6">{{ form.bennes_palox.label_tag }} {{ form.bennes_palox|add_class:'form-control' }}</div>
            <div class="col-md-3">{{ form.etat_sanitaire.label_tag }} {{ form.etat_sanitaire|add_class:'form-control' }}</div>
            <div class="col-md-9">{{ form.etat_sanitaire_notes.label_tag }} {{ form.etat_sanitaire_notes|add_class:'form-control' }}</div>
          </div>
        </div>
        <div class="tab-pane fade" id="tab-mesures" role="tabpanel">
          <div class="row g-3">
            <div class="col-md-4">{{ form.rendement_pct.label_tag }} {{ form.rendement_pct|add_class:'form-control' }}</div>
            <div class="col-md-4">{{ form.volume_mesure_l.label_tag }} {{ form.volume_mesure_l|add_class:'form-control' }}</div>
            <div class="col-md-4">{{ form.prix_raisin_eur_kg.label_tag }} {{ form.prix_raisin_eur_kg|add_class:'form-control' }}</div>
          </div>
          <p class="text-muted small mt-2"><i class="bi bi-info-circle me-1"></i>Le degré potentiel est renseigné par cépage dans le tableau ci-dessus.</p>
        </div>
        <div class="tab-pane fade" id="tab-notes" role="tabpanel">
          <div class="mb-3">
            {{ form.notes|add_class:'form-control' }}
          </div>
          <div class="form-check">{{ form.auto_create_lot }} {{ form.auto_create_lot.label_tag }}</div>
        </div>
      </div>
    </div>
    
    <!-- Colonne résumé -->
    <div class="col-lg-4">
      <div class="card mb-3 sticky-top" style="top: 1rem;">
        <div class="card-header fw-semibold"><i class="bi bi-clipboard-check me-2"></i>Résumé</div>
        <div class="card-body">
          <div class="mb-3">
            <div class="d-flex justify-content-between">
              <span class="text-muted">Poids total :</span>
              <strong id="resume-poids">0 kg</strong>
            </div>
            <div class="d-flex justify-content-between">
              <span class="text-muted">Nb cépages :</span>
              <strong id="resume-cepages">0</strong>
            </div>
          </div>
          <hr>
          <div class="d-grid gap-2">
            <button class="btn btn-primary" type="submit">
              <i class="bi bi-check-lg me-1"></i>{% if is_edit %}Enregistrer{% else %}Créer la vendange{% endif %}
            </button>
            {% if is_edit %}
            <a class="btn btn-outline-secondary" href="{% url 'production:vendange_detail' vendange.pk %}">Annuler</a>
            {% else %}
            <a class="btn btn-outline-secondary" href="{% url 'production:vendanges_list' %}">Annuler</a>
            {% endif %}
          </div>
        </div>
      </div>
      
      <div class="card mb-3">
        <div class="card-header fw-semibold"><i class="bi bi-lightbulb me-2"></i>Aide</div>
        <div class="card-body small text-muted">
          <p><strong>Comment ça marche ?</strong></p>
          <ol class="ps-3 mb-0">
            <li>Sélectionnez la parcelle vendangée</li>
            <li>Renseignez le poids par cépage dans le tableau</li>
            <li>Optionnel : indiquez les rangs concernés</li>
            <li>Validez pour créer la vendange</li>
          </ol>
        </div>
      </div>
    </div>
  </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const parcelleSelect = document.getElementById('id_parcelle');
    const encepagementInfo = document.getElementById('encepagement-info');
    const encepagementDetail = document.getElementById('encepagement-detail');
    const totalKgBadge = document.getElementById('total-kg-badge');
    const resumePoids = document.getElementById('resume-poids');
    const resumeCepages = document.getElementById('resume-cepages');
    
    // Gestion du formset de lignes
    const lignesTbody = document.getElementById('lignes-tbody');
    const addLigneBtn = document.getElementById('add-ligne-btn');
    const totalFormsInput = document.querySelector('input[name="lignes-TOTAL_FORMS"]');
    
    // Template d'une ligne vide (on clone la dernière ligne vide)
    let formIndex = parseInt(totalFormsInput.value);
    
    // Calculer le total des kg
    function updateTotals() {
        let total = 0;
        let count = 0;
        document.querySelectorAll('.ligne-row').forEach(row => {
            const deleteCheck = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
            if (deleteCheck && deleteCheck.checked) return;
            
            const kgInput = row.querySelector('input[name$="-quantite_kg"]');
            const cepageSelect = row.querySelector('select[name$="-cepage"]');
            if (kgInput && parseFloat(kgInput.value)) {
                total += parseFloat(kgInput.value);
            }
            if (cepageSelect && cepageSelect.value) {
                count++;
            }
        });
        
        if (totalKgBadge) totalKgBadge.textContent = `Total: ${total.toFixed(1)} kg`;
        if (resumePoids) resumePoids.textContent = `${total.toFixed(1)} kg`;
        if (resumeCepages) resumeCepages.textContent = count;
    }
    
    // Écouter les changements sur les inputs de kg
    document.addEventListener('input', function(e) {
        if (e.target.name && (e.target.name.includes('-quantite_kg') || e.target.name.includes('-cepage'))) {
            updateTotals();
        }
    });
    document.addEventListener('change', function(e) {
        if (e.target.name && e.target.name.includes('-DELETE')) {
            updateTotals();
        }
    });
    
    // Ajouter une nouvelle ligne
    if (addLigneBtn && lignesTbody) {
        addLigneBtn.addEventListener('click', function() {
            const templateDiv = document.getElementById('empty-row-template');
            if (!templateDiv) return;
            
            // Récupérer le HTML du template et remplacer __prefix__
            let html = templateDiv.innerHTML.replace(/__prefix__/g, formIndex);
            
            // Créer un élément temporaire pour parser le HTML
            const temp = document.createElement('tbody');
            temp.innerHTML = html;
            const newRow = temp.firstElementChild;
            
            // Nettoyage visuel (au cas où)
            if (newRow) {
                // Initialiser les select si nécessaire
                newRow.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
                
                // Ajouter au tableau
                lignesTbody.appendChild(newRow);
                
                // Gestionnaire de suppression pour la nouvelle ligne
                const removeBtn = newRow.querySelector('.remove-row-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        newRow.remove();
                        updateTotals();
                        // On ne décrémente pas formIndex pour éviter les conflits d'ID
                        // Mais on met à jour TOTAL_FORMS ? Non, Django gère les trous si on ne change pas TOTAL_FORMS, 
                        // mais ici on ajoute. Il faut incrémenter TOTAL_FORMS.
                        // Si on supprime, on devrait peut-être marquer DELETE caché ?
                        // Pour une ligne ajoutée dynamiquement (pas encore sauvée), on peut juste la virer du DOM.
                    });
                }
                
                formIndex++;
                totalFormsInput.value = formIndex;
            }
        });
    }

    // Si le tableau est vide au chargement (ex: bug de données), ajouter une ligne par défaut
    if (lignesTbody && lignesTbody.children.length === 0) {
        // Petit délai pour être sûr que tout est chargé
        setTimeout(() => {
            if (addLigneBtn) addLigneBtn.click();
        }, 100);
    }
    
    // Charger les cépages de la parcelle
    function loadEncepagements(parcelleId) {
        if (!parcelleId) {
            if (encepagementInfo) encepagementInfo.style.display = 'none';
            return;
        }
        
        fetch(`/ref/parcelles/${parcelleId}/cepages-api/`)
            .then(r => r.json())
            .then(data => {
                if (data.cepages && data.cepages.length > 0) {
                    let infoText = data.cepages.map(c => {
                        let txt = `<strong>${c.nom}</strong>`;
                        if (c.rang_debut && c.rang_fin) {
                            txt += ` (rangs ${c.rang_debut}-${c.rang_fin})`;
                        } else if (c.pourcentage) {
                            txt += ` (${c.pourcentage}%)`;
                        }
                        return txt;
                    }).join(' • ');
                    
                    if (encepagementDetail) encepagementDetail.innerHTML = infoText;
                    if (encepagementInfo) encepagementInfo.style.display = 'block';
                } else {
                    if (encepagementInfo) encepagementInfo.style.display = 'none';
                }
            })
            .catch(err => {
                console.error('Erreur chargement cépages:', err);
            });
    }
    
    // Écouter les changements de parcelle
    if (parcelleSelect) {
        parcelleSelect.addEventListener('change', function() {
            loadEncepagements(this.value);
        });
        
        // Initialiser si parcelle déjà sélectionnée
        if (parcelleSelect.value) {
            loadEncepagements(parcelleSelect.value);
        }
    }
    
    // Calcul initial
    updateTotals();
});
</script>
{% endblock %}
