{% extends 'production/base_production.html' %}
{% load widget_tweaks %}

{% block title %}Journal des op√©rations - Mon Chai{% endblock %}

{% block production_content %}
<style>
.cursor-pointer { cursor: pointer; }
.cursor-pointer:hover { background-color: rgba(0,0,0,0.02); }
</style>
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h4 mb-0 fw-bold">
            <i class="bi bi-journal-code me-2 text-primary"></i>Journal des op√©rations
        </h1>
        <p class="text-muted small mb-0">Toutes les op√©rations de cave : vinification, √©levage, stabilisation</p>
    </div>
    <div class="btn-group">
        <a href="{% url 'production:operation_create' %}" class="btn btn-primary">
            <i class="bi bi-plus-lg me-1"></i> Nouvelle op√©ration
        </a>
        <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown">
            <span class="visually-hidden">Options</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
            <li><h6 class="dropdown-header">Op√©rations rapides</h6></li>
            <li><a class="dropdown-item" href="{% url 'production:operation_create' %}?type=remontage">üîÑ Remontage</a></li>
            <li><a class="dropdown-item" href="{% url 'production:operation_create' %}?type=pigeage">üëä Pigeage</a></li>
            <li><a class="dropdown-item" href="{% url 'production:operation_create' %}?type=controle_densite_temp">üå°Ô∏è Contr√¥le densit√©/T¬∞</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{% url 'production:operation_create' %}?type=soutirage">‚ÜïÔ∏è Soutirage</a></li>
            <li><a class="dropdown-item" href="{% url 'production:operation_create' %}?type=so2">‚öóÔ∏è Ajout SO‚ÇÇ</a></li>
            <li><a class="dropdown-item" href="{% url 'production:operation_create' %}?type=ouillage">üíß Ouillage</a></li>
        </ul>
    </div>
</div>

<!-- Filtres & Recherche -->
<div class="card border-0 shadow-sm mb-3">
    <div class="card-body p-2">
        <form class="row g-2">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text bg-light border-end-0"><i class="bi bi-search text-muted"></i></span>
                    <input type="text" name="q" class="form-control border-start-0 ps-0" 
                           placeholder="Rechercher (lot, notes)..."
                           hx-get="{% url 'production:vinification_table' %}"
                           hx-trigger="keyup changed delay:300ms"
                           hx-target="#vinification-table-body"
                           hx-include="[name='type']">
                </div>
            </div>
            <div class="col-md-4">
                <select name="type" class="form-select" 
                        hx-get="{% url 'production:vinification_table' %}"
                        hx-trigger="change"
                        hx-target="#vinification-table-body"
                        hx-include="[name='q']">
                    <option value="">üç∑ Toutes les op√©rations</option>
                    <optgroup label="üçá Pr√©-fermentaire">
                        <option value="pressurage">Pressurage</option>
                        <option value="debourbage">D√©bourbage</option>
                        <option value="enzymage">Enzymage</option>
                        <option value="sulfitage_preferm">Sulfitage pr√©-ferm.</option>
                    </optgroup>
                    <optgroup label="üç∑ Fermentation alcoolique">
                        <option value="inoculation_levures">Inoculation levures</option>
                        <option value="debut_fa">D√©but FA</option>
                        <option value="chaptalisation">Chaptalisation</option>
                        <option value="remontage">Remontage</option>
                        <option value="pigeage">Pigeage</option>
                        <option value="delestage">D√©lestage</option>
                        <option value="controle_densite_temp">Contr√¥le densit√©/T¬∞</option>
                        <option value="fin_fa">Fin FA</option>
                        <option value="ecoulage">√âcoulage</option>
                    </optgroup>
                    <optgroup label="üß´ FML">
                        <option value="inoculation_bacteries">Inoculation bact√©ries</option>
                        <option value="debut_fml">D√©but FML</option>
                        <option value="fin_fml">Fin FML</option>
                    </optgroup>
                    <optgroup label="üè∫ √âlevage">
                        <option value="soutirage">Soutirage</option>
                        <option value="ouillage">Ouillage</option>
                        <option value="batonnage">B√¢tonnage</option>
                        <option value="so2">Ajout SO‚ÇÇ</option>
                        <option value="collage">Collage</option>
                        <option value="filtration">Filtration</option>
                    </optgroup>
                </select>
            </div>
        </form>
    </div>
</div>

<!-- Liste des op√©rations -->
<div class="card border-0 shadow-sm">
    <div class="table-responsive">
        <table class="table align-middle mb-0 table-hover">
            <thead class="bg-light text-muted small text-uppercase">
                <tr>
                    <th class="ps-3 border-0">Date</th>
                    <th class="border-0">Lot</th>
                    <th class="border-0">Op√©ration</th>
                    <th class="border-0">D√©tails</th>
                    <th class="border-0">Notes</th>
                    <th class="border-0 text-end pe-3">Actions</th>
                </tr>
            </thead>
            <tbody id="vinification-table-body">
                {% for op in operations %}
                <tr class="cursor-pointer" onclick="window.location='{% url 'production:operation_detail' op.obj.id %}'">
                    <td class="ps-3 fw-medium text-nowrap">{{ op.date|date:"d/m/Y" }}</td>
                    <td><span class="badge bg-light text-dark border">{{ op.lot.code }}</span></td>
                    <td>
                        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25">
                            {{ op.type_icon|default:"üìù" }} {{ op.type_display }}
                        </span>
                    </td>
                    <td class="font-monospace small">{{ op.valeur|default:"-" }}</td>
                    <td class="small text-muted text-truncate" style="max-width: 200px;">{{ op.notes|default:""|truncatewords:8 }}</td>
                    <td class="text-end pe-3">
                        <a href="{% url 'production:operation_detail' op.obj.id %}" class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation();">
                            <i class="bi bi-eye"></i>
                        </a>
                        <a href="{% url 'production:alerts_create' %}?operation={{ op.obj.id }}" class="btn btn-sm btn-outline-warning" onclick="event.stopPropagation();" title="Cr√©er alerte">
                            <i class="bi bi-bell"></i>
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center py-5 text-muted">
                        <i class="bi bi-journal-text fs-1 d-block mb-2 opacity-50"></i>
                        Aucune op√©ration enregistr√©e.
                        <div class="mt-3">
                            <a href="{% url 'production:operation_create' %}" class="btn btn-primary">
                                <i class="bi bi-plus-lg me-1"></i>Cr√©er la premi√®re op√©ration
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Ajout Op√©ration -->
<div class="modal fade" id="addOpModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Nouvelle op√©ration de vinification</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'production:vinification_op_create' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row g-3">
                        <!-- Champs communs -->
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Lot technique</label>
                            {{ form.lot_id|add_class:"form-select" }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Date</label>
                            {{ form.date|add_class:"form-control" }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Type d'op√©ration</label>
                            {{ form.type|add_class:"form-select"|attr:"id:opTypeSelect" }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Volume concern√© (L)</label>
                            {{ form.volume_concerne|add_class:"form-control" }}
                        </div>

                        <!-- Champs conditionnels -->
                        <div id="conditionalFields" class="col-12 border-top pt-3 mt-3 bg-light rounded p-3">
                            <p class="text-muted small mb-2 fst-italic" id="defaultMsg">S√©lectionnez un type pour voir les champs sp√©cifiques.</p>
                            
                            <div class="row g-3">
                                <!-- Duree -->
                                <div class="col-md-6 field-container d-none" data-for="debourbage">
                                    <label class="form-label">Dur√©e (h)</label>
                                    {{ form.duree_heures|add_class:"form-control" }}
                                </div>
                                
                                <!-- Temperature -->
                                <div class="col-md-6 field-container d-none" data-for="debourbage controle_densite_temp">
                                    <label class="form-label">Temp√©rature (¬∞C)</label>
                                    {{ form.temperature|add_class:"form-control" }}
                                </div>

                                <!-- Produit -->
                                <div class="col-md-6 field-container d-none" data-for="inoculation_levures inoculation_bacteries so2 correction_acidite">
                                    <label class="form-label">Produit</label>
                                    {{ form.produit|add_class:"form-control" }}
                                </div>

                                <!-- Dose -->
                                <div class="col-md-6 field-container d-none" data-for="inoculation_levures inoculation_bacteries so2 correction_acidite">
                                    <label class="form-label">Dose / Quantit√©</label>
                                    {{ form.dose|add_class:"form-control" }}
                                </div>

                                <!-- Quantit√© sucre -->
                                <div class="col-md-6 field-container d-none" data-for="chaptalisation">
                                    <label class="form-label">Quantit√© sucre (kg)</label>
                                    {{ form.quantite_sucre|add_class:"form-control" }}
                                </div>

                                <!-- Correction Type -->
                                <div class="col-md-6 field-container d-none" data-for="correction_acidite">
                                    <label class="form-label">Type correction</label>
                                    {{ form.correction_type|add_class:"form-select" }}
                                </div>

                                <!-- Action m√©canique -->
                                <div class="col-md-6 field-container d-none" data-for="remontage">
                                    <label class="form-label">Action</label>
                                    {{ form.action_mecanique|add_class:"form-select" }}
                                </div>

                                <!-- Nb Cycles -->
                                <div class="col-md-6 field-container d-none" data-for="remontage">
                                    <label class="form-label">Nb cycles / Dur√©e</label>
                                    {{ form.nb_cycles|add_class:"form-control" }}
                                </div>

                                <!-- Densite -->
                                <div class="col-md-6 field-container d-none" data-for="controle_densite_temp debut_fa fin_fa debut_fml fin_fml">
                                    <label class="form-label">Densit√©</label>
                                    {{ form.densite|add_class:"form-control" }}
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Commentaire / Notes</label>
                            {{ form.comment|add_class:"form-control" }}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const opTypeSelect = document.getElementById('opTypeSelect');
    const fieldContainers = document.querySelectorAll('.field-container');
    const defaultMsg = document.getElementById('defaultMsg');

    function updateFields() {
        const type = opTypeSelect.value;
        let hasVisible = false;
        
        fieldContainers.forEach(container => {
            const types = container.dataset.for.split(' ');
            if (types.includes(type)) {
                container.classList.remove('d-none');
                hasVisible = true;
            } else {
                container.classList.add('d-none');
            }
        });

        if (hasVisible) {
            defaultMsg.classList.add('d-none');
        } else {
            defaultMsg.classList.remove('d-none');
        }
    }

    opTypeSelect.addEventListener('change', updateFields);
    updateFields(); // Initial call
});
</script>
{% endblock %}
