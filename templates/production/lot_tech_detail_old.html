{% extends 'production/base_production.html' %}
{% block title %}Lot technique - Mon Chai{% endblock %}
{% block production_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Lot technique {{ lot.code }}
    {% if lot.location_kind == 'OFFSITE' %}
      <span class="badge text-bg-warning ms-2">Hors site</span>
    {% endif %}
  </h1>
  <div class="d-flex gap-2">
    <a href="/production/services/entry/?entity_type=lottech&entity_id={{ lot.id }}" class="btn btn-outline-primary btn-sm">+ Service</a>
    <a href="/production/assemblages/nouveau/?step=1&source={{ lot.id }}" class="btn btn-outline-dark btn-sm">Assembler</a>
    <a href="/production/mises/nouveau/?step=1" class="btn btn-primary btn-sm">Mise</a>
    <a href="/production/lots-elevage/journal/?lot={{ lot.code }}" class="btn btn-outline-secondary btn-sm">Journal vrac</a>
    <form method="post" action="/production/lots-techniques/{{ lot.id }}/action/pret_mise/" class="d-inline">{% csrf_token %}
      <button class="btn btn-outline-success btn-sm">Prêt mise</button>
    </form>
    {% if lot.location_kind != 'OFFSITE' %}
    <form method="post" action="/production/lots-techniques/{{ lot.id }}/action/offsite_send/" class="d-inline ms-2">{% csrf_token %}
      <input type="hidden" name="tiers" value="">
      <button class="btn btn-outline-warning btn-sm" title="Envoyer chez un faiseur">Envoyer hors site</button>
    </form>
    {% else %}
    <form method="post" action="/production/lots-techniques/{{ lot.id }}/action/offsite_return_neutral/" class="d-inline ms-2">{% csrf_token %}
      <button class="btn btn-outline-primary btn-sm" title="Retour sans changement de composition">Retour (neutre)</button>
    </form>
    <form method="post" action="/production/lots-techniques/{{ lot.id }}/action/offsite_return_non_neutral/" class="d-inline ms-1">{% csrf_token %}
      <button class="btn btn-outline-danger btn-sm" title="Retour avec modification (nouveau lot)">Retour (non neutre)</button>
    </form>
    {% endif %}
  </div>
</div>
{% if next_step %}
<div class="card mb-3">
  <div class="card-body d-flex justify-content-between align-items-center">
    <div>
      <div class="small text-muted">Prochaine étape</div>
      <div class="fw-semibold">{{ next_step.label }}</div>
    </div>
    <a href="{{ next_step.url }}" class="btn btn-primary">Continuer</a>
  </div>
</div>
{% endif %}

<div class="card mb-3"><div class="card-body">
  <div class="row g-3">
    <div class="col-md-2"><strong>Campagne</strong><div>{{ lot.campagne }}</div></div>
    <div class="col-md-3"><strong>Volume net (L)</strong><div>{{ volume_net_calc }}</div></div>
    <div class="col-md-2"><strong>Vol @20°C (hL)</strong><div>{% if lot.volume_hl20 %}{{ lot.volume_hl20 }}{% else %}-{% endif %}</div></div>
    <div class="col-md-2"><strong>Contenant</strong><div>{{ lot.contenant|default:'-' }}</div></div>
    <div class="col-md-2"><strong>Statut</strong><div>{{ lot.get_statut_display }}</div></div>
    <div class="col-md-3"><strong>Source</strong><div>{% if lot.source %}<a href="/production/vendanges/{{ lot.source.id }}/">Vendange</a>{% else %}-{% endif %}</div></div>
  </div>
  <div class="row g-3 mt-1">
    <div class="col-md-2"><strong>Densité</strong><div>{{ latest_densite|default:'-' }}</div></div>
    <div class="col-md-2"><strong>Titre (%)</strong><div>{% if abv_pct %}{{ abv_pct }}{% else %}-{% endif %}</div></div>
    <div class="col-md-4"><strong>Dernier transfert/soutirage</strong><div>{% if last_transfer_soutirage %}{{ last_transfer_soutirage|date:'Y-m-d H:i' }}{% else %}-{% endif %}</div></div>
    <div class="col-md-4"><strong>État technique</strong><div>{{ etat_technique|default:'-' }}</div></div>
  </div>
</div></div>

<ul class="nav nav-tabs mb-3" id="lotTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="origin-tab" data-bs-toggle="tab" data-bs-target="#origin" type="button" role="tab">Origine</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="container-tab" data-bs-toggle="tab" data-bs-target="#container" type="button" role="tab">Contenant & Emplacement</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="movements-tab" data-bs-toggle="tab" data-bs-target="#movements" type="button" role="tab">Mouvements</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="vinif-tab" data-bs-toggle="tab" data-bs-target="#vinif" type="button" role="tab">Paramètres & Analyses</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="docs-tab" data-bs-toggle="tab" data-bs-target="#docs" type="button" role="tab">Documents</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="costs-tab" data-bs-toggle="tab" data-bs-target="#costs" type="button" role="tab">Coûts</button>
  </li>
</ul>
<div class="tab-content">
  <div class="tab-pane fade show active" id="origin" role="tabpanel" aria-labelledby="origin-tab">
    <div class="card"><div class="card-body">
      <div class="row g-3">
        <div class="col-md-3"><div class="text-muted small">Encuvage source</div>
          <div>{% if origin and origin.vendange %}<a href="/production/vendanges/{{ origin.vendange.id }}/">{{ origin.vendange.code }}</a>{% else %}-{% endif %}</div>
        </div>
        <div class="col-md-3"><div class="text-muted small">Parcelle</div>
          <div>{% if origin and origin.parcelle %}{{ origin.parcelle.nom }}{% else %}-{% endif %}</div>
        </div>
        <div class="col-md-3"><div class="text-muted small">Créé le</div>
          <div>{% if origin %}{{ origin.created_at|date:'Y-m-d H:i' }}{% else %}-{% endif %}</div>
        </div>
        <div class="col-md-3"><div class="text-muted small">Rendement (L/kg)</div>
          <div>{% if origin and origin.rendement_l_kg %}{{ origin.rendement_l_kg }}{% else %}-{% endif %}</div>
        </div>
      </div>
      <div class="row g-3 mt-3">
        <div class="col-md-6">
          <h6>Parents</h6>
          <ul class="list-group list-group-flush">
            {% for ln in lineage_parents %}
            <li class="list-group-item d-flex justify-content-between">
              <span>{% if ln.parent_lot %}<a href="/production/lots-techniques/{{ ln.parent_lot.id }}/">{{ ln.parent_lot.code }}</a>{% else %}—{% endif %} <span class="text-muted small">({{ ln.operation.get_kind_display }} · {{ ln.operation.date|date:'Y-m-d' }})</span></span>
              {% if ln.ratio %}<span class="badge text-bg-light">{{ ln.ratio|floatformat:2 }}</span>{% endif %}
            </li>
            {% empty %}
            <li class="list-group-item text-muted">Aucun parent</li>
            {% endfor %}
          </ul>
        </div>
        <div class="col-md-6">
          <h6>Enfants</h6>
          <ul class="list-group list-group-flush">
            {% for ln in lineage_children %}
            <li class="list-group-item d-flex justify-content-between">
              <span><a href="/production/lots-techniques/{{ ln.child_lot.id }}/">{{ ln.child_lot.code }}</a> <span class="text-muted small">({{ ln.operation.get_kind_display }} · {{ ln.operation.date|date:'Y-m-d' }})</span></span>
              {% if ln.ratio %}<span class="badge text-bg-light">{{ ln.ratio|floatformat:2 }}</span>{% endif %}
            </li>
            {% empty %}
            <li class="list-group-item text-muted">Aucun enfant</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div></div>
  </div>

  <div class="tab-pane fade" id="docs" role="tabpanel" aria-labelledby="docs-tab">
    <div class="card"><div class="card-body">
      {% if lot_documents %}
      <div class="row g-3">
        {% for d in lot_documents %}
        <div class="col-md-4">
          <div class="border rounded p-2 h-100">
            <div class="small text-muted">{{ d.get_type_display }}</div>
            <div class="fw-semibold text-truncate">{{ d.description|default:d.document.name }}</div>
            <div class="text-muted small">{{ d.uploaded_at|date:'Y-m-d H:i' }}</div>
            <div class="mt-2"><a class="btn btn-sm btn-outline-primary" href="{{ d.document.url }}" target="_blank">Ouvrir</a></div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-muted">Aucun document attaché.</div>
      {% endif %}
    </div></div>
  </div>

  <div class="tab-pane fade" id="container" role="tabpanel" aria-labelledby="container-tab">
    <div class="row g-3">
      <div class="col-lg-6">
        <div class="card h-100"><div class="card-header">Contenant(s)</div><div class="card-body">
          {% if lot_containers %}
          <ul class="list-group list-group-flush">
            {% for c in lot_containers %}
              <li class="list-group-item d-flex justify-content-between"><span>{{ c.get_type_display }} {{ c.identifiant }} <span class="text-muted">({{ c.capacite_l }} L)</span></span><span class="badge text-bg-light">{{ c.volume_occupe_l }} L</span></li>
            {% endfor %}
          </ul>
          {% else %}<div class="text-muted">Aucun contenant lié.</div>{% endif %}
        </div></div>
      </div>
      <div class="col-lg-6">
        <div class="card h-100"><div class="card-header">Emplacement</div><div class="card-body">
          {% with ld=lot_detail %}
          <div class="row g-2">
            <div class="col-md-6"><div class="text-muted small">Allée / Travée / Niveau</div><div>{{ ld.emplacement_rangee|default:'-' }} / {{ ld.emplacement_travee|default:'-' }} / {{ ld.emplacement_niveau|default:'-' }}</div></div>
            <div class="col-md-6"><div class="text-muted small">Dernier ouillage</div><div>{% if ld and ld.ouillage_dernier_controle %}{{ ld.ouillage_dernier_controle|date:'Y-m-d' }} ({{ param_alerts.ouillage_days }} j){% else %}-{% endif %}</div></div>
          </div>
          {% endwith %}
        </div></div>
      </div>
    </div>
  </div>
  <div class="tab-pane fade" id="movements" role="tabpanel" aria-labelledby="movements-tab">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="text-muted">Historique des mouvements (du plus récent au plus ancien)</div>
      <a class="btn btn-sm btn-outline-secondary" href="/production/lots-techniques/{{ lot.id }}/mouvements/export/">Exporter CSV</a>
    </div>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th class="text-end">Volume (L)</th>
            <th>Méta</th>
          </tr>
        </thead>
        <tbody>
          {% for mv in mouvements %}
          <tr>
            <td>{{ mv.date|date:'Y-m-d H:i' }}</td>
            <td>{{ mv.type }}</td>
            <td class="text-end">{{ mv.volume_l }}</td>
            <td><code class="small">{{ mv.meta|default:'{}' }}</code></td>
          </tr>
          {% empty %}
          <tr><td colspan="4" class="text-muted">Aucun mouvement</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="tab-pane fade" id="vinif" role="tabpanel" aria-labelledby="vinif-tab">
    <div class="row g-3">
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Déclarer une mesure</span>
          </div>
          <div class="card-body">
            <form method="post" action="/production/lots-techniques/{{ lot.id }}/vinif/measure/add/">
              {% csrf_token %}
              <div class="row g-2 align-items-end">
                <div class="col-md-3">
                  <label class="form-label">Type</label>
                  <select name="type" class="form-select">
                    <option value="temperature">Température (°C)</option>
                    <option value="densite">Densité</option>
                    <option value="ph">pH</option>
                    <option value="sucre">Sucres (g/L)</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Valeur</label>
                  <input type="number" step="0.01" name="value" class="form-control" required>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Date</label>
                  <input type="datetime-local" name="date" class="form-control">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Notes</label>
                  <input type="text" name="notes" class="form-control">
                </div>
              </div>
              <div class="mt-3"><button class="btn btn-outline-primary">Ajouter</button></div>
            </form>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Intervention</span>
          </div>
          <div class="card-body">
            <form method="post" action="/production/lots-techniques/{{ lot.id }}/vinif/intervention/add/">
              {% csrf_token %}
              <div class="row g-2 align-items-end">
                <div class="col-md-4">
                  <label class="form-label">Type</label>
                  <select name="type" class="form-select">
                    <option value="remontage">Remontage</option>
                    <option value="pigeage">Pigeage</option>
                    <option value="so2">Ajout SO₂</option>
                    <option value="soutirage">Soutirage</option>
                    <option value="batonnage">Bâtonnage</option>
                    <option value="fml">FML</option>
                    <option value="filtration">Filtration</option>
                    <option value="collage">Collage</option>
                    <option value="ouillage">Ouillage</option>
                    <option value="correction">Correction autre</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Date</label>
                  <input type="date" name="date" class="form-control">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Notes</label>
                  <input type="text" name="notes" class="form-control">
                </div>
              </div>
              <!-- Intrants optionnels -->
              <div class="row g-2 mt-2 align-items-end">
                 <div class="col-md-4">
                   <label class="form-label text-muted small">Intrant (facultatif)</label>
                   <input type="text" name="produit_intrant" class="form-control form-control-sm" placeholder="ex: SO2">
                 </div>
                 <div class="col-md-4">
                   <label class="form-label text-muted small">Quantité</label>
                   <input type="number" step="0.001" name="quantite" class="form-control form-control-sm">
                 </div>
                 <div class="col-md-4">
                   <label class="form-label text-muted small">Unité</label>
                   <input type="text" name="unite" class="form-control form-control-sm" placeholder="g/hL...">
                 </div>
              </div>

              <div class="mt-3 d-flex gap-2">
                <a class="btn btn-outline-secondary" href="/production/lots-techniques/{{ lot.id }}/pressurage/">Écouler / Presser</a>
                <button class="btn btn-outline-primary">Ajouter</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="col-12">
        <div class="card">
          <div class="card-header">Timeline vinification</div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <h6>Interventions récentes</h6>
                <ul class="list-group list-group-flush">
                  {% for itv in vinif_interventions %}
                  <li class="list-group-item d-flex justify-content-between">
                    <span>{{ itv.date }} — {{ itv.get_type_display }} <span class="text-muted">{{ itv.notes }}</span></span>
                    {% if itv.volume_out_l %}<span class="badge text-bg-light">-{{ itv.volume_out_l }} L</span>{% endif %}
                  </li>
                  {% empty %}
                  <li class="list-group-item text-muted">Aucune intervention</li>
                  {% endfor %}
                </ul>
              </div>
              <div class="col-md-6">
                <h6>Mesures récentes</h6>
                <ul class="list-group list-group-flush">
                  {% for m in vinif_measurements %}
                  <li class="list-group-item">{{ m.date|date:'Y-m-d H:i' }} — {{ m.get_type_display }}: <strong>{{ m.value }}</strong> {{ m.unit }}</li>
                  {% empty %}
                  <li class="list-group-item text-muted">Aucune mesure</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-pane fade" id="costs" role="tabpanel" aria-labelledby="costs-tab">
    <div class="card">
      <div class="card-body">
        <div class="mb-2">
          <strong>CMP €/L</strong>:
          {% if cost_snapshot %}{{ cost_snapshot.cmp_vrac_eur_l }}{% else %}0.0000{% endif %}
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Date</th>
                <th>Nature</th>
                <th class="text-end">Quantité</th>
                <th class="text-end">Montant (€)</th>
              </tr>
            </thead>
            <tbody>
              {% for e in cost_entries %}
              <tr>
                <td>{{ e.date|date:'Y-m-d H:i' }}</td>
                <td>{{ e.get_nature_display }}</td>
                <td class="text-end">{{ e.qty }}</td>
                <td class="text-end">{{ e.amount_eur }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="4" class="text-muted">Aucune écriture</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-3">
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header">Perte</div>
      <div class="card-body">
        <form method="post" action="/production/lots-techniques/{{ lot.id }}/action/perte/">
          {% csrf_token %}
          <div class="row g-2 align-items-end">
            <div class="col-md-4"><label class="form-label">Volume (L)</label><input type="number" step="0.01" name="volume_l" class="form-control" required></div>
            <div class="col-md-6"><label class="form-label">Notes</label><input type="text" name="notes" class="form-control"></div>
            <div class="col-md-2"><button class="btn btn-outline-danger w-100" type="submit">Enregistrer</button></div>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header">Transfert (A → B)</div>
      <div class="card-body">
        <form method="post" action="/production/lots-techniques/{{ lot.id }}/action/transfert/">
          {% csrf_token %}
          <div class="row g-2 align-items-end">
            <div class="col-md-4"><label class="form-label">Volume (L)</label><input type="number" step="0.01" name="volume_l" class="form-control" required></div>
            <div class="col-md-6">
              <label class="form-label">Lot destination</label>
              <select class="form-select" name="dst_lot_id" required>
                <option value="">— Choisir —</option>
                {% for other in other_lots %}
                <option value="{{ other.id }}">{{ other.code }} ({{ other.campagne }})</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2"><button class="btn btn-outline-primary w-100" type="submit">Transférer</button></div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="mt-3 d-flex gap-2">
  <a href="/production/mises/nouveau/?step=1" class="btn btn-primary">Planifier une mise</a>
  <form id="form-pret-mise" method="post" action="/production/lots-techniques/{{ lot.id }}/action/pret_mise/">{% csrf_token %}<button class="btn btn-outline-success">Marquer Prêt mise</button></form>
  <a href="/production/lots-elevage/journal/?lot={{ lot.code }}" class="btn btn-outline-secondary">Journal vrac</a>
  <a href="/production/assemblages/nouveau/?step=1&source={{ lot.id }}" class="btn btn-outline-dark">Créer un assemblage</a>
</div>
{% endblock %}
