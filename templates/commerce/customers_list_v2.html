{% extends '_layout/base_list_view.html' %}
{% load static %}

{# ===========================================
   LISTE DES CLIENTS - Nouveau Design MonChai
   =========================================== #}

{% block sidebar_title %}Commerce{% endblock %}

{% block sidebar_sections %}
<div class="mc-sidebar-section blue">
    Clients
    <span class="badge">{{ clients|length }}</span>
</div>
<a href="{% url 'clients:customers_list_v2' %}" class="mc-sidebar-link active">
    <i class="bi bi-people me-2"></i>Tous les clients
</a>
<a href="{% url 'clients:customers_list' %}?type=particulier" class="mc-sidebar-link">
    <i class="bi bi-person me-2"></i>Particuliers
</a>
<a href="{% url 'clients:customers_list' %}?type=professionnel" class="mc-sidebar-link">
    <i class="bi bi-building me-2"></i>Professionnels
</a>

<div class="mc-sidebar-section green">Ventes</div>
<a href="#" class="mc-sidebar-link">
    <i class="bi bi-receipt me-2"></i>Commandes
</a>
<a href="#" class="mc-sidebar-link">
    <i class="bi bi-file-earmark-text me-2"></i>Devis
</a>

<div class="mc-sidebar-section orange">Facturation</div>
<a href="#" class="mc-sidebar-link">
    <i class="bi bi-file-earmark-ruled me-2"></i>Factures
</a>
{% endblock %}

{% block page_title %}Clients{% endblock %}
{% block page_subtitle %}Gestion commerciale • {{ organization.name }}{% endblock %}

{% block toolbar_filters %}
<div class="mc-filter-pills">
    <button type="button" class="mc-filter-pill active" data-filter="all">Tout</button>
    <button type="button" class="mc-filter-pill" data-filter="particulier">Particuliers</button>
    <button type="button" class="mc-filter-pill" data-filter="professionnel">Pros</button>
    <button type="button" class="mc-filter-pill" data-filter="caviste">Cavistes</button>
    <button type="button" class="mc-filter-pill" data-filter="export">Export</button>
</div>
{% endblock %}

{% block action_label %}Nouveau Client{% endblock %}
{% block action_onclick %}window.location.href='{% url "clients:customer_create" %}'{% endblock %}

{% block grid_content %}
{% for c in clients %}
<div class="mc-card client-card" 
     data-id="{{ c.id }}" 
     data-filter="{{ c.type|default:'particulier' }}"
     onclick="selectClient('{{ c.id }}')">
    
    <div class="mc-card-header">
        <span class="mc-card-code">
            {% if c.type == 'professionnel' %}
            <i class="bi bi-building"></i>
            {% elif c.type == 'caviste' %}
            <i class="bi bi-shop"></i>
            {% elif c.type == 'export' %}
            <i class="bi bi-globe"></i>
            {% else %}
            <i class="bi bi-person"></i>
            {% endif %}
        </span>
        <span class="mc-card-badge {% if c.status == 'actif' %}mc-badge-green{% elif c.status == 'prospect' %}mc-badge-orange{% else %}mc-badge-gray{% endif %}">
            {{ c.get_status_display|default:c.status|upper }}
        </span>
    </div>
    
    <div class="mc-card-body">
        <h4 class="mc-card-title">{{ c.name }}</h4>
        <p class="mc-card-subtitle">
            {% if c.first_name %}{{ c.first_name }} {{ c.last_name }}{% endif %}
        </p>
        
        <div class="mc-card-stats mt-2">
            {% if c.email_main %}
            <div class="small text-muted text-truncate">
                <i class="bi bi-envelope"></i> {{ c.email_main }}
            </div>
            {% endif %}
            {% if c.phone_main %}
            <div class="small text-muted">
                <i class="bi bi-telephone"></i> {{ c.phone_main }}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% empty %}
<div class="mc-empty-state" style="grid-column: 1 / -1;">
    <i class="bi bi-people"></i>
    <p>Aucun client enregistré</p>
    <a href="{% url 'commerce:customer_create' %}" class="mc-btn-primary mt-3">
        <i class="bi bi-plus-lg"></i> Créer un client
    </a>
</div>
{% endfor %}
{% endblock %}

{% block table_headers %}
<th>Nom</th>
<th>Type</th>
<th>Contact</th>
<th>Email</th>
<th>Téléphone</th>
<th>Statut</th>
{% endblock %}

{% block table_rows %}
{% for c in clients %}
<tr data-id="{{ c.id }}" 
    data-filter="{{ c.type|default:'particulier' }}"
    onclick="selectClient('{{ c.id }}')">
    <td><strong>{{ c.name }}</strong></td>
    <td>
        <span class="badge bg-light text-dark">
            {{ c.get_type_display|default:c.type }}
        </span>
    </td>
    <td>{% if c.first_name %}{{ c.first_name }} {{ c.last_name }}{% else %}—{% endif %}</td>
    <td>{{ c.email_main|default:"—" }}</td>
    <td>{{ c.phone_main|default:"—" }}</td>
    <td>
        <span class="badge {% if c.status == 'actif' %}bg-success{% elif c.status == 'prospect' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
            {{ c.get_status_display|default:c.status }}
        </span>
    </td>
</tr>
{% endfor %}
{% endblock %}

{% block preview_stats %}
<div class="mc-preview-stat">
    <div class="mc-preview-stat-label">CA 12 mois</div>
    <div class="mc-preview-stat-value" id="stat-ca">—</div>
</div>
<div class="mc-preview-stat">
    <div class="mc-preview-stat-label">Commandes</div>
    <div class="mc-preview-stat-value" id="stat-orders">—</div>
</div>
<div class="mc-preview-stat">
    <div class="mc-preview-stat-label">Panier</div>
    <div class="mc-preview-stat-value" id="stat-panier">—</div>
</div>
{% endblock %}

{% block preview_quick_actions %}
<div class="mc-quick-actions">
    <div class="mc-quick-actions-title">
        <i class="bi bi-lightning-fill"></i> Actions Rapides
    </div>
    <div class="mc-quick-actions-grid">
        <button type="button" class="mc-quick-action-btn" onclick="actionCommande()">
            <i class="bi bi-cart-plus"></i> Commande
        </button>
        <button type="button" class="mc-quick-action-btn" onclick="actionDevis()">
            <i class="bi bi-file-earmark-plus"></i> Devis
        </button>
        <button type="button" class="mc-quick-action-btn" onclick="actionEmail()">
            <i class="bi bi-envelope"></i> Email
        </button>
        <button type="button" class="mc-quick-action-btn" onclick="actionModifier()">
            <i class="bi bi-pencil"></i> Modifier
        </button>
    </div>
</div>
{% endblock %}

{% block preview_sections %}
<div class="mc-preview-section">
    <h3 class="mc-preview-section-title">Coordonnées</h3>
    <div id="preview-contact" class="bg-white border rounded p-3">
        <p class="text-muted small mb-0">Sélectionnez un client</p>
    </div>
</div>

<div class="mc-preview-section">
    <h3 class="mc-preview-section-title">Dernières commandes</h3>
    <div class="mc-timeline" id="preview-timeline">
        <div class="mc-timeline-item muted">
            <div class="mc-timeline-date">—</div>
            <div class="mc-timeline-title">Aucune commande</div>
        </div>
    </div>
</div>
{% endblock %}

{% block list_view_css %}
<style>
.client-card {
    min-height: 160px;
}
.client-card .mc-card-header {
    background: linear-gradient(135deg, #3b82f622 0%, transparent 100%);
}
</style>
{% endblock %}

{% block list_view_js %}
<script>
const clientsData = {
    {% for c in clients %}
    "{{ c.id }}": {
        id: "{{ c.id }}",
        name: "{{ c.name }}",
        firstName: "{{ c.first_name|default:'' }}",
        lastName: "{{ c.last_name|default:'' }}",
        type: "{{ c.get_type_display|default:c.type }}",
        email: "{{ c.email_main|default:'' }}",
        phone: "{{ c.phone_main|default:'' }}",
        status: "{{ c.get_status_display|default:c.status }}",
        detailUrl: "{% url 'commerce:customer_detail' c.id %}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
};

function selectClient(id) {
    const data = clientsData[id];
    if (!data) return;
    
    document.getElementById('preview-title').innerHTML = `
        ${data.name}
        <span class="badge mc-badge-blue ms-2">${data.type}</span>
    `;
    document.getElementById('preview-subtitle').textContent = 
        data.firstName ? `${data.firstName} ${data.lastName}` : '—';
    
    document.getElementById('stat-ca').textContent = '—';
    document.getElementById('stat-orders').textContent = '—';
    document.getElementById('stat-panier').textContent = '—';
    
    const contactDiv = document.getElementById('preview-contact');
    contactDiv.innerHTML = `
        <div class="mb-2">
            <i class="bi bi-envelope text-muted me-2"></i>
            ${data.email || '<span class="text-muted">Non renseigné</span>'}
        </div>
        <div>
            <i class="bi bi-telephone text-muted me-2"></i>
            ${data.phone || '<span class="text-muted">Non renseigné</span>'}
        </div>
    `;
    
    document.getElementById('preview-detail-link').href = data.detailUrl;
    
    selectItem(id, {
        title: data.name,
        subtitle: data.firstName ? `${data.firstName} ${data.lastName}` : data.type,
        detailUrl: data.detailUrl
    });
}

function onFilterChange(filter) {
    const cards = document.querySelectorAll('.mc-card[data-filter]');
    const rows = document.querySelectorAll('.mc-table tbody tr[data-filter]');
    
    [...cards, ...rows].forEach(el => {
        if (filter === 'all' || el.dataset.filter === filter) {
            el.style.display = '';
        } else {
            el.style.display = 'none';
        }
    });
}

function actionCommande() {
    if (!selectedItemId) return;
    window.location.href = `/commerce/commandes/nouvelle/?client=${selectedItemId}`;
}

function actionDevis() {
    if (!selectedItemId) return;
    window.location.href = `/commerce/devis/nouveau/?client=${selectedItemId}`;
}

function actionEmail() {
    if (!selectedItemId) return;
    const data = clientsData[selectedItemId];
    if (data && data.email) {
        window.location.href = `mailto:${data.email}`;
    }
}

function actionModifier() {
    if (!selectedItemId) return;
    window.location.href = `/commerce/clients/${selectedItemId}/edit/`;
}
</script>
{% endblock %}
