{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }} - Mon Chai{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            {% for item in breadcrumb_items %}
                {% if item.url %}
                    <li class="breadcrumb-item">
                        <a href="{{ item.url }}" class="text-decoration-none">{{ item.name }}</a>
                    </li>
                {% else %}
                    <li class="breadcrumb-item active" aria-current="page">{{ item.name }}</li>
                {% endif %}
            {% endfor %}
        </ol>
    </nav>

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-1">
                        <i class="bi bi-upc me-2 text-info"></i>{{ page_title }}
                    </h1>
                    <p class="text-muted mb-0">Créer un produit fini</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'catalogue:products_skus' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>Retour à la liste
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulaire -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-info-circle me-2"></i>Informations du produit fini
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        <div class="row g-3">
                            <!-- Étiquette -->
                            <div class="col-md-6">
                                <label for="label" class="form-label">
                                    Étiquette <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="label" name="label" required>
                                <div class="form-text">Nom commercial du produit</div>
                            </div>

                            <!-- Cuvée -->
                            <div class="col-md-6">
                                <label for="id_sku_cuvee_input" class="form-label">
                                    Cuvée <span class="text-danger">*</span>
                                </label>
                                <div class="cbx cbx--sense"
                                     data-endpoint="{% url 'catalogue:catalogue_api' %}?page_size=200"
                                     data-mode="text"
                                     data-items-key="items"
                                     data-id-field="id"
                                     data-label-template="{name}">
                                    <div class="cbx-top">
                                        <input id="id_sku_cuvee_input" class="form-control" type="text" role="combobox"
                                               aria-expanded="false" aria-autocomplete="list" aria-controls="id_sku_cuvee_listbox"
                                               autocomplete="off" placeholder="Rechercher une cuvée…">
                                        <ul id="id_sku_cuvee_listbox" role="listbox" class="cbx-list" hidden></ul>
                                    </div>
                                    <div class="cbx-chips" aria-label="Suggestions rapides"></div>
                                    <div class="cbx-meta"><span class="cbx-help form-hint">Chargement…</span></div>
                                    <select id="cuvee" name="cuvee" hidden required>
                                        <option value="">— Sélectionner —</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Unité de mesure -->
                            <div class="col-md-6">
                                <label for="id_sku_uom_input" class="form-label">
                                    Unité de mesure <span class="text-danger">*</span>
                                </label>
                                <div class="cbx cbx--sense"
                                     data-endpoint="/referentiels/unites/?format=json"
                                     data-mode="unit">
                                    <div class="cbx-top">
                                        <input id="id_sku_uom_input" class="form-control" type="text" role="combobox"
                                               aria-expanded="false" aria-autocomplete="list" aria-controls="id_sku_uom_listbox"
                                               autocomplete="off" placeholder="Rechercher une unité…">
                                        <ul id="id_sku_uom_listbox" role="listbox" class="cbx-list" hidden></ul>
                                    </div>
                                    <div class="cbx-chips" aria-label="Suggestions rapides"></div>
                                    <div class="cbx-meta"><span class="cbx-help form-hint">Chargement…</span></div>
                                    <select id="uom" name="uom" hidden required>
                                        <option value="">— Sélectionner —</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Volume par unité -->
                            <div class="col-md-6">
                                <label for="volume_by_uom_to_l" class="form-label">Volume par unité (L)</label>
                                <input type="number" class="form-control" id="volume_by_uom_to_l" name="volume_by_uom_to_l" step="0.01" min="0">
                                <div class="form-text">Volume en litres pour une unité</div>
                            </div>

                            <!-- Code EAN -->
                            <div class="col-md-6">
                                <label for="ean_code" class="form-label">Code EAN</label>
                                <input type="text" class="form-control" id="ean_code" name="ean_code">
                                <div class="form-text">Code-barres EAN (optionnel)</div>
                            </div>

                            <!-- Prix de vente -->
                            <div class="col-md-6">
                                <label for="price" class="form-label">Prix de vente (€)</label>
                                <input type="number" class="form-control" id="price" name="price" step="0.01" min="0">
                                <div class="form-text">Prix de vente unitaire</div>
                            </div>

                            <!-- Statut actif -->
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="is_active" name="is_active" checked>
                                    <label class="form-check-label" for="is_active">
                                        Produit fini actif
                                    </label>
                                    <div class="form-text">Les produits finis inactifs n'apparaissent pas dans les listes par défaut</div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <a href="{% url 'catalogue:products_skus' %}" class="btn btn-outline-secondary">
                                Annuler
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg me-1"></i>Créer le produit fini
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar d'aide -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-lightbulb me-2"></i>Aide
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>Étiquette</h6>
                        <p class="small text-muted">
                            Le nom commercial qui apparaîtra sur vos documents de vente.
                        </p>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Unité de mesure</h6>
                        <p class="small text-muted">
                            L'unité dans laquelle ce produit est vendu (bouteille, carton, etc.).
                        </p>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Volume par unité</h6>
                        <p class="small text-muted">
                            Le volume en litres contenu dans une unité de vente.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Statistiques rapides -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-graph-up me-2"></i>Statistiques
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <div class="h4 mb-0 text-primary">{{ cuvees|length }}</div>
                                <small class="text-muted">Cuvées</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="h4 mb-0 text-info">{{ uoms|length }}</div>
                            <small class="text-muted">Unités</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animation d'entrée
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'all 0.3s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });

    // Validation du formulaire
    const form = document.querySelector('form');
    const labelInput = document.getElementById('label');
    const cuveeSelect = document.getElementById('cuvee');
    const uomSelect = document.getElementById('uom');
    
    form.addEventListener('submit', function(e) {
        let hasError = false;
        
        if (!labelInput.value.trim()) {
            labelInput.classList.add('is-invalid');
            hasError = true;
        }
        
        if (!cuveeSelect.value) {
            cuveeSelect.classList.add('is-invalid');
            hasError = true;
        }
        
        if (!uomSelect.value) {
            uomSelect.classList.add('is-invalid');
            hasError = true;
        }
        
        if (hasError) {
            e.preventDefault();
        }
    });

    // Suppression des erreurs lors de la saisie
    [labelInput, cuveeSelect, uomSelect].forEach(input => {
        input.addEventListener('input', function() {
            this.classList.remove('is-invalid');
        });
    });
});
</script>
<script src="{% static 'catalogue/cuvees_form.js' %}"></script>
<style>
.cbx{position:relative}
.cbx-list{position:absolute;z-index:10;left:0;right:0;max-height:260px;overflow:auto;margin:.25rem 0;padding:0;list-style:none;border:1px solid #ddd;border-radius:.5rem;background:#fff}
.cbx-list li{padding:.5rem .75rem;cursor:pointer;display:flex;justify-content:space-between;gap:.5rem}
.cbx-list li[aria-selected="true"],.cbx-list li:hover{background:#f5f5f5}
.cbx-badges{display:flex;gap:.25rem;align-items:center}
.cbx-badge{font-size:.75rem;opacity:.7}
.cbx-meta{display:flex;gap:.5rem;margin-top:.25rem;align-items:center}
.cbx-add{font-size:.875rem}
.cbx-chips{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.5rem}
.chip{border:1px solid #ddd;border-radius:999px;padding:.25rem .6rem;cursor:pointer;font-size:.85rem;background:#fafafa}
.chip:hover{background:#f1f1f1}
</style>
{% endblock %}
