{% extends 'base.html' %}

{% block title %}Catalogue - {{ organization.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="bi bi-collection me-2 text-success"></i>Catalogue
            </h1>
            <div class="d-flex align-items-center">
                <!-- Boutons Import/Export -->
                {% include 'components/import_export_buttons.html' with entity_type='cuvee' entity_name='Cuvées' %}
                
                {% if user.get_active_membership.can_edit_data %}
                    <a href="{% url 'catalogue:cuvee_create' %}" class="btn btn-primary">
                        <i class="bi bi-plus"></i> Nouvelle cuvée
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recherche avancée par champs -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="bi bi-funnel me-2"></i>Filtres de recherche
            </h6>
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary" id="toggle-advanced-search">
                    <i class="bi bi-chevron-down"></i> Avancé
                </button>
                <button type="button" class="btn btn-outline-danger" id="clear-filters">
                    <i class="bi bi-x-circle"></i> Effacer
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Recherche rapide -->
        <div class="row mb-3">
            <div class="col-md-8">
                <div class="position-relative">
                    <input type="text" 
                           id="quick-search" 
                           name="search"
                           value="{{ search_query|default:'' }}" 
                           placeholder="Recherche rapide dans tous les champs..." 
                           class="form-control pe-5"
                           autocomplete="off">
                    <div class="position-absolute top-50 end-0 translate-middle-y me-3">
                        <i class="bi bi-search text-muted" id="search-icon"></i>
                        <div class="spinner-border spinner-border-sm text-primary d-none" id="search-spinner" role="status">
                            <span class="visually-hidden">Recherche...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div id="search-info" class="text-muted small mt-2">
                    {{ total_count }} cuvée{{ total_count|pluralize }}
                </div>
            </div>
        </div>

        {% if search_query %}
        <hr>
        <div class="mt-2">
            <h6 class="mb-3"><i class="bi bi-journal-text me-2"></i>Registre des liens pour "{{ search_query }}"</h6>
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="p-3 border rounded-3 bg-white h-100">
                        <div class="fw-semibold mb-1">Catalogue (grille)</div>
                        <div class="text-muted small mb-2">Vue grille des cuvées avec filtres et tri.</div>
                        <div class="small">
                            <a href="{% url 'catalogue:home' %}?q={{ search_query|urlencode }}">{% url 'catalogue:home' %}?q={{ search_query|urlencode }}</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="p-3 border rounded-3 bg-white h-100">
                        <div class="fw-semibold mb-1">Cuvées</div>
                        <div class="text-muted small mb-2">Administration des cuvées (appellation, millésime, UoM).</div>
                        <div class="small">
                            <a href="{% url 'catalogue:products_cuvees' %}?q={{ search_query|urlencode }}">{% url 'catalogue:products_cuvees' %}?q={{ search_query|urlencode }}</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="p-3 border rounded-3 bg-white h-100">
                        <div class="fw-semibold mb-1">Lots</div>
                        <div class="text-muted small mb-2">Lots vrac et états (volume, entrepôt, statut).</div>
                        <div class="small">
                            <a href="{% url 'catalogue:products_lots' %}?q={{ search_query|urlencode }}">{% url 'catalogue:products_lots' %}?q={{ search_query|urlencode }}</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="p-3 border rounded-3 bg-white h-100">
                        <div class="fw-semibold mb-1">Produits (SKU)</div>
                        <div class="text-muted small mb-2">Produits finis étiquetés, codes-barres et UoM.</div>
                        <div class="small">
                            <a href="{% url 'catalogue:products_skus' %}?q={{ search_query|urlencode }}">{% url 'catalogue:products_skus' %}?q={{ search_query|urlencode }}</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="p-3 border rounded-3 bg-white h-100">
                        <div class="fw-semibold mb-1">Clients</div>
                        <div class="text-muted small mb-2">Recherche globale dans le registre clients (nom, email, téléphone, TVA).</div>
                        <div class="small">
                            <a href="{% url 'clients:customers_list' %}?search={{ search_query|urlencode }}">{% url 'clients:customers_list' %}?search={{ search_query|urlencode }}</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Filtres avancés (masqués par défaut) -->
        <div id="advanced-filters" class="collapse">
            <hr>
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="filter-nom" class="form-label">Nom</label>
                    <input type="text" 
                           id="filter-nom" 
                           name="nom"
                           value="{{ filters.nom|default:'' }}" 
                           placeholder="Nom de la cuvée..." 
                           class="form-control">
                </div>
                <div class="col-md-2">
                    <label for="filter-appellation" class="form-label">Appellation</label>
                    <select id="filter-appellation" name="appellation" class="form-select">
                        <option value="">Toutes</option>
                        {% for facet in appellations_facets %}
                            <option value="{{ facet.appellation__id }}" 
                                    {% if appellation_filter == facet.appellation__id|stringformat:"s" %}selected{% endif %}>
                                {{ facet.appellation__name }} ({{ facet.count }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="filter-vintage" class="form-label">Millésime</label>
                    <select id="filter-vintage" name="vintage" class="form-select">
                        <option value="">Tous</option>
                        {% for facet in vintages_facets %}
                            <option value="{{ facet.vintage__id }}" 
                                    {% if vintage_filter == facet.vintage__id|stringformat:"s" %}selected{% endif %}>
                                {{ facet.vintage__year }} ({{ facet.count }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filter-couleur" class="form-label">Couleur</label>
                    <select id="filter-couleur" name="couleur" class="form-select">
                        <option value="">Toutes</option>
                        {% for facet in colors_facets %}
                            <option value="{{ facet.appellation__type }}" 
                                    {% if color_filter == facet.appellation__type %}selected{% endif %}>
                                {{ facet.appellation__type|title }} ({{ facet.count }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="filter-sort" class="form-label">Tri</label>
                    <div class="input-group">
                        <select id="filter-sort" name="sort" class="form-select">
                            <option value="name_asc" {% if sort_param == 'name_asc' %}selected{% endif %}>Nom A→Z</option>
                            <option value="name_desc" {% if sort_param == 'name_desc' %}selected{% endif %}>Nom Z→A</option>
                            <option value="updated_desc" {% if sort_param == 'updated_desc' %}selected{% endif %}>Récemment modifiées</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Liste des cuvées -->
{% if cuvees %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Nom</th>
                                    <th>Appellation</th>
                                    <th>Millésime</th>
                                    <th>Couleur</th>
                                    <th>Créé le</th>
                                    <th width="120">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="results-table">
                                {% for cuvee in cuvees %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-cup-straw text-success me-2"></i>
                                                <div>
                                                    <div class="fw-medium">{{ cuvee.name }}</div>
                                                    {% if cuvee.code %}
                                                        <small class="text-muted">{{ cuvee.code }}</small>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            {% if cuvee.appellation %}
                                                {{ cuvee.appellation.name }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if cuvee.vintage %}
                                                <span class="badge bg-info">{{ cuvee.vintage.year }}</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if cuvee.appellation.type %}
                                                {% if cuvee.appellation.type == 'rouge' %}
                                                    <span class="badge bg-danger">Rouge</span>
                                                {% elif cuvee.appellation.type == 'blanc' %}
                                                    <span class="badge bg-light text-dark">Blanc</span>
                                                {% elif cuvee.appellation.type == 'rose' %}
                                                    <span class="badge bg-warning">Rosé</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ cuvee.appellation.type|title }}</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ cuvee.created_at|date:"d/m/Y" }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <a href="{% url 'catalogue:cuvee_detail' cuvee.id %}" class="btn btn-outline-primary" title="Voir fiche">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                {% if user.get_active_membership.can_edit_data %}
                                                    <a href="{% url 'admin:viticulture_cuvee_change' cuvee.id %}" class="btn btn-outline-secondary" title="Modifier">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
        <div class="row mt-3">
            <div class="col-12" id="pagination-container">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-muted small">
                        Affichage de {{ page_obj.start_index }} à {{ page_obj.end_index }} sur {{ page_obj.paginator.count }} résultats
                    </div>
                    
                    <nav aria-label="Pagination catalogue">
                        <ul class="pagination pagination-sm mb-0">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">
                                        <i class="bi bi-chevron-left"></i>
                                    </a>
                                </li>
                            {% endif %}
                            
                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                                    </li>
                                {% elif num == 1 or num == page_obj.paginator.num_pages %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                                    </li>
                                {% elif num == page_obj.number|add:'-4' or num == page_obj.number|add:'4' %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">
                                        <i class="bi bi-chevron-right"></i>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    {% endif %}
{% else %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle fs-1 mb-3"></i>
                <h4>Aucune cuvée trouvée</h4>
                <p>Vous n'avez pas encore créé de cuvée.</p>
                {% if user.get_active_membership.can_edit_data %}
                    <a href="{% url 'catalogue:cuvee_create' %}" class="btn btn-primary">
                        <i class="bi bi-plus"></i> Créer votre première cuvée
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Éléments du DOM
    const quickSearchInput = document.getElementById('quick-search');
    const filterInputs = {
        nom: document.getElementById('filter-nom'),
        appellation: document.getElementById('filter-appellation'),
        vintage: document.getElementById('filter-vintage'),
        couleur: document.getElementById('filter-couleur'),
        sort: document.getElementById('filter-sort')
    };
    
    const searchInfo = document.getElementById('search-info');
    const toggleAdvancedBtn = document.getElementById('toggle-advanced-search');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const advancedFilters = document.getElementById('advanced-filters');
    const searchIcon = document.getElementById('search-icon');
    const searchSpinner = document.getElementById('search-spinner');
    
    let searchTimeout;
    
    // Configuration
    const DEBOUNCE_MS = 300;
    
    // Collecter tous les filtres actifs
    function collectFilters() {
        const filters = {};
        
        // Recherche rapide
        const quickSearch = quickSearchInput.value.trim();
        if (quickSearch) filters.q = quickSearch;
        
        // Filtres avancés
        Object.keys(filterInputs).forEach(key => {
            const input = filterInputs[key];
            if (input && input.value.trim()) {
                // Mapper les noms de champs
                const mappedKey = key === 'couleur' ? 'color' : key;
                filters[mappedKey] = input.value.trim();
            }
        });
        
        return filters;
    }
    
    // Fonction de recherche (rechargement de page pour l'instant)
    function performSearch() {
        const filters = collectFilters();
        const params = new URLSearchParams();
        
        Object.keys(filters).forEach(key => {
            if (filters[key]) {
                params.set(key, filters[key]);
            }
        });
        
        const newURL = `/catalogue/${params.toString() ? '?' + params.toString() : ''}`;
        window.location.href = newURL;
    }
    
    // Gérer l'affichage/masquage des filtres avancés
    if (toggleAdvancedBtn && advancedFilters) {
        toggleAdvancedBtn.addEventListener('click', function() {
            const isCollapsed = advancedFilters.classList.contains('show');
            const icon = this.querySelector('i');
            
            if (isCollapsed) {
                advancedFilters.classList.remove('show');
                icon.className = 'bi bi-chevron-down';
            } else {
                advancedFilters.classList.add('show');
                icon.className = 'bi bi-chevron-up';
            }
        });
    }
    
    // Effacer tous les filtres
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
            window.location.href = '/catalogue/';
        });
    }
    
    // Événements de saisie avec debounce
    function setupInputEvents() {
        // Recherche rapide
        if (quickSearchInput) {
            quickSearchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                
                if (this.value.trim() === '') {
                    performSearch();
                } else {
                    searchTimeout = setTimeout(() => {
                        performSearch();
                    }, DEBOUNCE_MS);
                }
            });
            
            quickSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    clearTimeout(searchTimeout);
                    performSearch();
                }
            });
        }
        
        // Filtres avancés
        Object.values(filterInputs).forEach(input => {
            if (input) {
                const eventType = input.type === 'select-one' ? 'change' : 'input';
                input.addEventListener(eventType, function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        performSearch();
                    }, DEBOUNCE_MS);
                });
            }
        });
    }
    
    // Raccourci clavier Ctrl+K / Cmd+K
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            quickSearchInput.focus();
            quickSearchInput.select();
        }
    });
    
    // Initialisation
    setupInputEvents();
    
    // Focus sur le champ de recherche rapide
    if (quickSearchInput) {
        quickSearchInput.focus();
    }
    
    console.log('Recherche catalogue initialisée');
});
</script>

<!-- Modals Import/Export -->
{% include 'components/import_export_modals.html' %}

{% endblock %}
