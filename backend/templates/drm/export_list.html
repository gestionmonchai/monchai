{% extends "base.html" %}
{% load static %}

{% block title %}Exports DRM{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Exports DRM</h1>
        <button 
            id="btn-nouveau-export"
            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
        >
            <i class="fas fa-plus mr-2"></i>
            Nouvel Export
        </button>
    </div>

    <!-- Filtres -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4">Filtres</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Période</label>
                <input 
                    type="month" 
                    id="filter-periode"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Statut</label>
                <select 
                    id="filter-status"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    <option value="">Tous les statuts</option>
                    <option value="brouillon">Brouillon</option>
                    <option value="genere">Généré</option>
                    <option value="transmis">Transmis</option>
                    <option value="valide">Validé</option>
                </select>
            </div>
            <div class="flex items-end">
                <button 
                    id="btn-filtrer"
                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
                >
                    <i class="fas fa-search mr-2"></i>
                    Filtrer
                </button>
            </div>
        </div>
    </div>

    <!-- Liste des exports -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="px-6 py-4 bg-gray-50 border-b">
            <h2 class="text-lg font-semibold">Historique des exports</h2>
        </div>
        
        <div id="exports-container">
            <div class="p-6 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Chargement des exports...</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nouvel Export -->
<div id="modal-nouveau-export" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b">
                <h3 class="text-lg font-semibold">Nouvel Export DRM</h3>
            </div>
            
            <form id="form-nouveau-export" class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Période <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="month" 
                        id="nouvelle-periode"
                        name="periode"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Région
                    </label>
                    <select 
                        id="nouvelle-region"
                        name="region"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        <option value="Loire">Loire</option>
                        <option value="Bordeaux">Bordeaux</option>
                        <option value="Bourgogne">Bourgogne</option>
                        <option value="Champagne">Champagne</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button 
                        type="button"
                        id="btn-annuler-export"
                        class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition duration-200"
                    >
                        Annuler
                    </button>
                    <button 
                        type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200"
                    >
                        <i class="fas fa-cog mr-2"></i>
                        Générer Export
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Template pour les exports -->
<template id="template-export-item">
    <div class="border-b border-gray-200 p-6 hover:bg-gray-50 transition duration-200">
        <div class="flex items-center justify-between">
            <div class="flex-1">
                <div class="flex items-center space-x-4 mb-2">
                    <h3 class="text-lg font-semibold text-gray-900" data-field="periode"></h3>
                    <span class="px-2 py-1 text-xs font-medium rounded-full" data-field="status-badge"></span>
                    <span class="text-sm text-gray-500" data-field="region"></span>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600 mb-3">
                    <div>
                        <span class="font-medium">Stock début:</span>
                        <span data-field="stock_debut_hl"></span> HL
                    </div>
                    <div>
                        <span class="font-medium">Entrées:</span>
                        <span data-field="entrees_hl"></span> HL
                    </div>
                    <div>
                        <span class="font-medium">Sorties:</span>
                        <span data-field="sorties_hl"></span> HL
                    </div>
                    <div>
                        <span class="font-medium">Stock fin:</span>
                        <span data-field="stock_fin_hl"></span> HL
                    </div>
                </div>
                
                <div class="text-xs text-gray-500">
                    Créé le <span data-field="created_at"></span>
                </div>
            </div>
            
            <div class="flex items-center space-x-2 ml-4">
                <button 
                    class="btn-download-csv px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition duration-200"
                    data-export-id=""
                >
                    <i class="fas fa-file-csv mr-1"></i>
                    CSV
                </button>
                <button 
                    class="btn-download-pdf px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition duration-200"
                    data-export-id=""
                >
                    <i class="fas fa-file-pdf mr-1"></i>
                    PDF
                </button>
                <button 
                    class="btn-regenerer px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition duration-200"
                    data-export-id=""
                >
                    <i class="fas fa-sync mr-1"></i>
                    Régénérer
                </button>
            </div>
        </div>
    </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('modal-nouveau-export');
    const btnNouveauExport = document.getElementById('btn-nouveau-export');
    const btnAnnulerExport = document.getElementById('btn-annuler-export');
    const formNouveauExport = document.getElementById('form-nouveau-export');
    const exportsContainer = document.getElementById('exports-container');
    const btnFiltrer = document.getElementById('btn-filtrer');
    
    // Ouvrir modal
    btnNouveauExport.addEventListener('click', function() {
        modal.classList.remove('hidden');
    });
    
    // Fermer modal
    btnAnnulerExport.addEventListener('click', function() {
        modal.classList.add('hidden');
        formNouveauExport.reset();
    });
    
    // Fermer modal en cliquant à l'extérieur
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.classList.add('hidden');
            formNouveauExport.reset();
        }
    });
    
    // Soumettre nouveau export
    formNouveauExport.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(formNouveauExport);
        const data = {
            periode: formData.get('periode'),
            region: formData.get('region')
        };
        
        // Désactiver le bouton
        const submitBtn = formNouveauExport.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Génération...';
        submitBtn.disabled = true;
        
        fetch('/api/drm/exports/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Erreur: ' + data.error);
            } else {
                modal.classList.add('hidden');
                formNouveauExport.reset();
                chargerExports();
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de la génération de l\'export');
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });
    
    // Charger les exports
    function chargerExports() {
        const filterPeriode = document.getElementById('filter-periode').value;
        const filterStatus = document.getElementById('filter-status').value;
        
        let url = '/api/drm/exports/';
        const params = new URLSearchParams();
        
        if (filterPeriode) params.append('periode', filterPeriode);
        if (filterStatus) params.append('status', filterStatus);
        
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        fetch(url)
        .then(response => response.json())
        .then(data => {
            afficherExports(data.results || data);
        })
        .catch(error => {
            console.error('Erreur:', error);
            exportsContainer.innerHTML = '<div class="p-6 text-center text-red-500">Erreur lors du chargement des exports</div>';
        });
    }
    
    // Afficher les exports
    function afficherExports(exports) {
        if (!exports || exports.length === 0) {
            exportsContainer.innerHTML = '<div class="p-6 text-center text-gray-500">Aucun export trouvé</div>';
            return;
        }
        
        const template = document.getElementById('template-export-item');
        exportsContainer.innerHTML = '';
        
        exports.forEach(exportItem => {
            const clone = template.content.cloneNode(true);
            
            // Remplir les données
            clone.querySelector('[data-field="periode"]').textContent = exportItem.periode;
            clone.querySelector('[data-field="region"]').textContent = exportItem.region;
            clone.querySelector('[data-field="stock_debut_hl"]').textContent = parseFloat(exportItem.stock_debut_hl).toFixed(2);
            clone.querySelector('[data-field="entrees_hl"]').textContent = parseFloat(exportItem.entrees_hl).toFixed(2);
            clone.querySelector('[data-field="sorties_hl"]').textContent = parseFloat(exportItem.sorties_hl).toFixed(2);
            clone.querySelector('[data-field="stock_fin_hl"]').textContent = parseFloat(exportItem.stock_fin_hl).toFixed(2);
            clone.querySelector('[data-field="created_at"]').textContent = new Date(exportItem.created_at).toLocaleDateString('fr-FR');
            
            // Badge de statut
            const statusBadge = clone.querySelector('[data-field="status-badge"]');
            statusBadge.textContent = exportItem.status_display;
            statusBadge.className += getStatusBadgeClass(exportItem.status);
            
            // Boutons d'action
            const btnCSV = clone.querySelector('.btn-download-csv');
            const btnPDF = clone.querySelector('.btn-download-pdf');
            const btnRegenerer = clone.querySelector('.btn-regenerer');
            
            btnCSV.dataset.exportId = exportItem.id;
            btnPDF.dataset.exportId = exportItem.id;
            btnRegenerer.dataset.exportId = exportItem.id;
            
            // Désactiver les boutons si pas de fichiers
            if (!exportItem.chemin_csv) {
                btnCSV.disabled = true;
                btnCSV.classList.add('opacity-50', 'cursor-not-allowed');
            }
            if (!exportItem.chemin_pdf) {
                btnPDF.disabled = true;
                btnPDF.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            // Désactiver régénération si transmis/validé
            if (['transmis', 'valide'].includes(exportItem.status)) {
                btnRegenerer.disabled = true;
                btnRegenerer.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            exportsContainer.appendChild(clone);
        });
        
        // Ajouter les event listeners
        ajouterEventListeners();
    }
    
    // Ajouter les event listeners aux boutons
    function ajouterEventListeners() {
        // Téléchargement CSV
        document.querySelectorAll('.btn-download-csv').forEach(btn => {
            btn.addEventListener('click', function() {
                if (!this.disabled) {
                    window.open(`/api/drm/exports/${this.dataset.exportId}/download_csv/`);
                }
            });
        });
        
        // Téléchargement PDF
        document.querySelectorAll('.btn-download-pdf').forEach(btn => {
            btn.addEventListener('click', function() {
                if (!this.disabled) {
                    window.open(`/api/drm/exports/${this.dataset.exportId}/download_pdf/`);
                }
            });
        });
        
        // Régénération
        document.querySelectorAll('.btn-regenerer').forEach(btn => {
            btn.addEventListener('click', function() {
                if (!this.disabled && confirm('Êtes-vous sûr de vouloir régénérer cet export ?')) {
                    regenererExport(this.dataset.exportId);
                }
            });
        });
    }
    
    // Régénérer un export
    function regenererExport(exportId) {
        fetch(`/api/drm/exports/${exportId}/regenerer/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Erreur: ' + data.error);
            } else {
                chargerExports();
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de la régénération');
        });
    }
    
    // Classe CSS pour le badge de statut
    function getStatusBadgeClass(status) {
        const classes = {
            'brouillon': ' bg-gray-100 text-gray-800',
            'genere': ' bg-blue-100 text-blue-800',
            'transmis': ' bg-yellow-100 text-yellow-800',
            'valide': ' bg-green-100 text-green-800'
        };
        return classes[status] || ' bg-gray-100 text-gray-800';
    }
    
    // Fonction utilitaire pour récupérer le CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Event listeners pour les filtres
    btnFiltrer.addEventListener('click', chargerExports);
    
    // Charger les exports au démarrage
    chargerExports();
});
</script>
{% endblock %}
