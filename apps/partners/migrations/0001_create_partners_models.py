# Generated by Django 5.2.8 on 2026-01-08 18:05

import django.contrib.postgres.indexes
import django.contrib.postgres.search
import django.core.validators
import django.db.models.deletion
import django.utils.timezone
import uuid
from decimal import Decimal
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('accounts', '0020_invoice_subscription'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='PartnerRole',
            fields=[
                ('code', models.CharField(choices=[('client', 'Client'), ('supplier', 'Fournisseur'), ('prospect', 'Prospect'), ('carrier', 'Transporteur'), ('subcontractor', 'Prestataire'), ('other', 'Autre')], max_length=20, primary_key=True, serialize=False)),
                ('label', models.CharField(max_length=50)),
                ('icon', models.CharField(default='bi-person', max_length=30)),
                ('color', models.CharField(default='secondary', max_length=20)),
                ('sort_order', models.PositiveIntegerField(default=0)),
            ],
            options={
                'verbose_name': 'Rôle partenaire',
                'verbose_name_plural': 'Rôles partenaires',
                'db_table': 'partners_role',
                'ordering': ['sort_order', 'label'],
            },
        ),
        migrations.CreateModel(
            name='Partner',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('row_version', models.PositiveIntegerField(default=1)),
                ('code', models.CharField(editable=False, help_text='Code unique auto-généré (PAR-00001)', max_length=20, unique=True)),
                ('display_id', models.PositiveIntegerField(blank=True, editable=False, help_text='Identifiant numérique court pour URLs', null=True, unique=True)),
                ('partner_type', models.CharField(choices=[('individual', 'Personne physique'), ('company', 'Personne morale')], default='company', help_text='Personne physique ou morale', max_length=20)),
                ('name', models.CharField(help_text='Raison sociale ou Nom complet', max_length=200)),
                ('name_normalized', models.CharField(editable=False, help_text='Nom normalisé pour recherche', max_length=200)),
                ('first_name', models.CharField(blank=True, max_length=100)),
                ('last_name', models.CharField(blank=True, max_length=100)),
                ('segment', models.CharField(blank=True, choices=[('individual', 'Particulier'), ('business', 'Professionnel'), ('wine_shop', 'Caviste'), ('export', 'Export'), ('restaurant', 'CHR'), ('distributor', 'Distributeur'), ('other', 'Autre')], help_text='Segment commercial (optionnel)', max_length=20)),
                ('email', models.EmailField(blank=True, max_length=254, null=True)),
                ('phone', models.CharField(blank=True, help_text='Téléphone principal', max_length=30)),
                ('mobile', models.CharField(blank=True, help_text='Téléphone mobile', max_length=30)),
                ('website', models.URLField(blank=True)),
                ('siret', models.CharField(blank=True, help_text='SIRET (14 chiffres)', max_length=14)),
                ('siren', models.CharField(blank=True, help_text='SIREN (9 chiffres)', max_length=9)),
                ('vat_number', models.CharField(blank=True, help_text='N° TVA intracommunautaire', max_length=20)),
                ('naf_code', models.CharField(blank=True, help_text='Code NAF/APE', max_length=10)),
                ('country_code', models.CharField(default='FR', help_text='Code pays ISO', max_length=2)),
                ('language', models.CharField(default='fr', help_text='Langue préférée', max_length=5)),
                ('timezone', models.CharField(default='Europe/Paris', max_length=50)),
                ('currency', models.CharField(default='EUR', help_text='Devise par défaut', max_length=3)),
                ('is_active', models.BooleanField(default=True, help_text='Partenaire actif')),
                ('is_archived', models.BooleanField(default=False, help_text='Archivé (masqué par défaut)')),
                ('notes', models.TextField(blank=True, help_text='Notes internes')),
                ('internal_ref', models.CharField(blank=True, help_text='Référence interne libre', max_length=50)),
                ('search_vector', django.contrib.postgres.search.SearchVectorField(blank=True, null=True)),
                ('source', models.CharField(blank=True, help_text="Source d'acquisition (import, site web, salon...)", max_length=50)),
                ('organization', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='partners_%(class)s_set', to='accounts.organization')),
                ('roles', models.ManyToManyField(blank=True, help_text='Rôles du partenaire (client, fournisseur, etc.)', related_name='partners', to='partners.partnerrole')),
            ],
            options={
                'verbose_name': 'Partenaire',
                'verbose_name_plural': 'Partenaires',
                'db_table': 'partners_partner',
                'ordering': ['name'],
            },
        ),
        migrations.CreateModel(
            name='ClientProfile',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('row_version', models.PositiveIntegerField(default=1)),
                ('payment_terms', models.CharField(choices=[('immediate', 'Comptant'), ('15d', '15 jours'), ('30d', '30 jours'), ('45d', '45 jours'), ('60d', '60 jours'), ('end_of_month', 'Fin de mois'), ('custom', 'Personnalisé')], default='30d', max_length=20)),
                ('payment_terms_custom', models.CharField(blank=True, max_length=100)),
                ('price_category', models.CharField(choices=[('public', 'Tarif public'), ('pro', 'Tarif pro'), ('export', 'Tarif export'), ('custom', 'Tarif spécial')], default='public', max_length=20)),
                ('default_discount_pct', models.DecimalField(decimal_places=2, default=Decimal('0'), help_text='Remise par défaut (%)', max_digits=5, validators=[django.core.validators.MinValueValidator(0), django.core.validators.MaxValueValidator(100)])),
                ('credit_limit', models.DecimalField(decimal_places=2, default=Decimal('0'), help_text="Plafond d'encours autorisé", max_digits=12)),
                ('current_balance', models.DecimalField(decimal_places=2, default=Decimal('0'), help_text='Encours actuel (calculé)', max_digits=12)),
                ('accounting_code', models.CharField(blank=True, help_text='Compte comptable client', max_length=20)),
                ('total_revenue', models.DecimalField(decimal_places=2, default=Decimal('0'), help_text='CA total cumulé', max_digits=14)),
                ('total_orders', models.PositiveIntegerField(default=0, help_text='Nombre total de commandes')),
                ('last_order_date', models.DateField(blank=True, null=True)),
                ('average_basket', models.DecimalField(decimal_places=2, default=Decimal('0'), help_text='Panier moyen', max_digits=12)),
                ('preferred_shipping_method', models.CharField(blank=True, max_length=50)),
                ('preferred_carrier', models.CharField(blank=True, max_length=100)),
                ('cgv_accepted', models.BooleanField(default=False)),
                ('cgv_accepted_date', models.DateField(blank=True, null=True)),
                ('organization', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='partners_%(class)s_set', to='accounts.organization')),
                ('partner', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='client_profile', to='partners.partner')),
            ],
            options={
                'verbose_name': 'Profil client',
                'verbose_name_plural': 'Profils clients',
                'db_table': 'partners_client_profile',
            },
        ),
        migrations.CreateModel(
            name='PartnerTag',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('row_version', models.PositiveIntegerField(default=1)),
                ('name', models.CharField(max_length=50)),
                ('color', models.CharField(default='#6c757d', max_length=7)),
                ('description', models.TextField(blank=True)),
                ('organization', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='partners_%(class)s_set', to='accounts.organization')),
            ],
            options={
                'verbose_name': 'Tag partenaire',
                'verbose_name_plural': 'Tags partenaires',
                'db_table': 'partners_tag',
                'ordering': ['name'],
            },
        ),
        migrations.CreateModel(
            name='PartnerTagLink',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('partner', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='tag_links', to='partners.partner')),
                ('tag', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='partner_links', to='partners.partnertag')),
            ],
            options={
                'db_table': 'partners_tag_link',
            },
        ),
        migrations.CreateModel(
            name='SupplierProfile',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('row_version', models.PositiveIntegerField(default=1)),
                ('payment_terms', models.CharField(choices=[('immediate', 'Comptant'), ('15d', '15 jours'), ('30d', '30 jours'), ('45d', '45 jours'), ('60d', '60 jours'), ('end_of_month', 'Fin de mois'), ('custom', 'Personnalisé')], default='30d', max_length=20)),
                ('payment_terms_custom', models.CharField(blank=True, max_length=100)),
                ('incoterm', models.CharField(blank=True, choices=[('exw', 'EXW - Ex Works'), ('fca', 'FCA - Free Carrier'), ('cpt', 'CPT - Carriage Paid To'), ('cip', 'CIP - Carriage Insurance Paid'), ('dap', 'DAP - Delivered at Place'), ('dpu', 'DPU - Delivered at Place Unloaded'), ('ddp', 'DDP - Delivered Duty Paid'), ('fob', 'FOB - Free on Board'), ('cif', 'CIF - Cost Insurance Freight')], max_length=10)),
                ('lead_time_days', models.PositiveIntegerField(default=0, help_text='Délai de livraison moyen (jours)')),
                ('min_order_amount', models.DecimalField(decimal_places=2, default=Decimal('0'), help_text='Montant minimum de commande', max_digits=12)),
                ('accounting_code', models.CharField(blank=True, help_text='Compte comptable fournisseur', max_length=20)),
                ('total_purchases', models.DecimalField(decimal_places=2, default=Decimal('0'), help_text='Total achats cumulé', max_digits=14)),
                ('total_orders', models.PositiveIntegerField(default=0, help_text='Nombre total de commandes')),
                ('last_order_date', models.DateField(blank=True, null=True)),
                ('quality_rating', models.PositiveIntegerField(default=0, help_text='Note qualité (0-5)', validators=[django.core.validators.MaxValueValidator(5)])),
                ('is_approved', models.BooleanField(default=False, help_text='Fournisseur agréé')),
                ('approval_date', models.DateField(blank=True, null=True)),
                ('product_categories', models.JSONField(blank=True, default=list, help_text='Catégories de produits fournis')),
                ('organization', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='partners_%(class)s_set', to='accounts.organization')),
                ('partner', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='supplier_profile', to='partners.partner')),
            ],
            options={
                'verbose_name': 'Profil fournisseur',
                'verbose_name_plural': 'Profils fournisseurs',
                'db_table': 'partners_supplier_profile',
            },
        ),
        migrations.CreateModel(
            name='ContactPerson',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('row_version', models.PositiveIntegerField(default=1)),
                ('first_name', models.CharField(max_length=100)),
                ('last_name', models.CharField(max_length=100)),
                ('job_title', models.CharField(blank=True, help_text='Fonction', max_length=100)),
                ('department', models.CharField(blank=True, help_text='Service', max_length=100)),
                ('email', models.EmailField(blank=True, max_length=254)),
                ('phone', models.CharField(blank=True, max_length=30)),
                ('mobile', models.CharField(blank=True, max_length=30)),
                ('role', models.CharField(choices=[('general', 'Contact général'), ('buyer', 'Acheteur'), ('seller', 'Commercial'), ('accounting', 'Comptabilité'), ('logistics', 'Logistique'), ('technical', 'Technique'), ('management', 'Direction'), ('other', 'Autre')], default='general', max_length=20)),
                ('is_primary', models.BooleanField(default=False, help_text='Contact principal')),
                ('is_active', models.BooleanField(default=True)),
                ('notes', models.TextField(blank=True)),
                ('organization', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='partners_%(class)s_set', to='accounts.organization')),
                ('partner', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='contacts', to='partners.partner')),
            ],
            options={
                'verbose_name': 'Interlocuteur',
                'verbose_name_plural': 'Interlocuteurs',
                'db_table': 'partners_contact_person',
                'ordering': ['-is_primary', 'last_name', 'first_name'],
                'indexes': [models.Index(fields=['partner', 'role'], name='partners_co_partner_c2dc9a_idx'), models.Index(fields=['email'], name='partners_co_email_f8d14a_idx')],
            },
        ),
        migrations.CreateModel(
            name='Address',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('row_version', models.PositiveIntegerField(default=1)),
                ('label', models.CharField(blank=True, help_text='Libellé (ex: Siège Paris)', max_length=100)),
                ('address_type', models.CharField(choices=[('billing', 'Facturation'), ('shipping', 'Livraison'), ('headquarters', 'Siège social'), ('warehouse', 'Entrepôt'), ('other', 'Autre')], default='billing', max_length=20)),
                ('is_default', models.BooleanField(default=False, help_text='Adresse par défaut')),
                ('street', models.CharField(help_text='Rue et numéro', max_length=200)),
                ('street2', models.CharField(blank=True, help_text="Complément d'adresse", max_length=200)),
                ('postal_code', models.CharField(max_length=20)),
                ('city', models.CharField(max_length=100)),
                ('state', models.CharField(blank=True, help_text='Région/État', max_length=100)),
                ('country', models.CharField(default='FR', help_text='Code pays ISO', max_length=2)),
                ('contact_name', models.CharField(blank=True, help_text='Nom du contact sur site', max_length=100)),
                ('contact_phone', models.CharField(blank=True, help_text='Téléphone contact', max_length=30)),
                ('delivery_instructions', models.TextField(blank=True, help_text='Instructions de livraison')),
                ('delivery_hours', models.CharField(blank=True, help_text='Créneaux horaires', max_length=100)),
                ('latitude', models.DecimalField(blank=True, decimal_places=7, max_digits=10, null=True)),
                ('longitude', models.DecimalField(blank=True, decimal_places=7, max_digits=10, null=True)),
                ('organization', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='partners_%(class)s_set', to='accounts.organization')),
                ('partner', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='addresses', to='partners.partner')),
            ],
            options={
                'verbose_name': 'Adresse',
                'verbose_name_plural': 'Adresses',
                'db_table': 'partners_address',
                'ordering': ['-is_default', 'address_type', 'label'],
                'indexes': [models.Index(fields=['partner', 'address_type'], name='partners_ad_partner_04fb94_idx'), models.Index(fields=['postal_code'], name='partners_ad_postal__0f30db_idx')],
            },
        ),
        migrations.CreateModel(
            name='PartnerEvent',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('row_version', models.PositiveIntegerField(default=1)),
                ('event_type', models.CharField(choices=[('note', 'Note'), ('call', 'Appel'), ('email', 'Email'), ('meeting', 'Rendez-vous'), ('quote', 'Devis'), ('order', 'Commande'), ('delivery', 'Livraison'), ('invoice', 'Facture'), ('payment', 'Paiement'), ('complaint', 'Réclamation'), ('other', 'Autre')], default='note', max_length=20)),
                ('title', models.CharField(max_length=200)),
                ('description', models.TextField(blank=True)),
                ('event_date', models.DateTimeField(default=django.utils.timezone.now)),
                ('related_object_type', models.CharField(blank=True, max_length=50)),
                ('related_object_id', models.UUIDField(blank=True, null=True)),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='partner_events_created', to=settings.AUTH_USER_MODEL)),
                ('organization', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='partners_%(class)s_set', to='accounts.organization')),
                ('partner', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='events', to='partners.partner')),
            ],
            options={
                'verbose_name': 'Événement',
                'verbose_name_plural': 'Événements',
                'db_table': 'partners_event',
                'ordering': ['-event_date'],
                'indexes': [models.Index(fields=['partner', 'event_type'], name='partners_ev_partner_0eb493_idx'), models.Index(fields=['partner', '-event_date'], name='partners_ev_partner_74c914_idx')],
            },
        ),
        migrations.AddIndex(
            model_name='partner',
            index=django.contrib.postgres.indexes.GinIndex(fields=['name_normalized'], name='partner_name_gin'),
        ),
        migrations.AddIndex(
            model_name='partner',
            index=django.contrib.postgres.indexes.GinIndex(fields=['search_vector'], name='partner_search_gin'),
        ),
        migrations.AddIndex(
            model_name='partner',
            index=models.Index(fields=['organization', 'is_active'], name='partner_org_active_idx'),
        ),
        migrations.AddIndex(
            model_name='partner',
            index=models.Index(fields=['organization', 'segment'], name='partner_org_segment_idx'),
        ),
        migrations.AddIndex(
            model_name='partner',
            index=models.Index(fields=['organization', 'updated_at', 'id'], name='partner_keyset_idx'),
        ),
        migrations.AddIndex(
            model_name='partner',
            index=models.Index(fields=['vat_number'], name='partner_vat_idx'),
        ),
        migrations.AddIndex(
            model_name='partner',
            index=models.Index(fields=['siret'], name='partner_siret_idx'),
        ),
        migrations.AddConstraint(
            model_name='partner',
            constraint=models.UniqueConstraint(fields=('organization', 'name_normalized'), name='unique_partner_name_per_org'),
        ),
        migrations.AddConstraint(
            model_name='partner',
            constraint=models.UniqueConstraint(condition=models.Q(('vat_number__isnull', False), models.Q(('vat_number', ''), _negated=True)), fields=('organization', 'vat_number'), name='unique_partner_vat_per_org'),
        ),
        migrations.AddConstraint(
            model_name='partnertag',
            constraint=models.UniqueConstraint(fields=('organization', 'name'), name='unique_partner_tag_per_org'),
        ),
        migrations.AlterUniqueTogether(
            name='partnertaglink',
            unique_together={('partner', 'tag')},
        ),
    ]
