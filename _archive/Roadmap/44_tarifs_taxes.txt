Roadmap 44 â€” /tarifs/taxes (ParamÃ©trage TVA FR/UE/Export + policies) â€” VERSION DÃ‰TAILLÃ‰E
========================================================================================

ğŸ¯ Objectif
-----------
DÃ©finir des **rÃ¨gles TVA** par pays/segment/produit et des **politiques contextuelles** (export 0%, reverse charge intraâ€‘UE),
appliquer les arrondis (ligne v1), et intÃ©grer la vÃ©rification minimale du **nÂ° TVA** (format + prÃ©sence) cÃ´tÃ© client Pro/Export.

ğŸ“¦ ModÃ¨le (DDL suggÃ©rÃ©)
-----------------------
- `tax_rule(id, org_id, country_code, rate NUMERIC(5,2), name, segment ENUM NULL, product_type ENUM NULL, effective_from DATE, effective_to DATE NULL, priority INT DEFAULT 100, is_active BOOL)`
  - INDEX(org, country_code, segment, product_type, effective_from, effective_to, priority)

- `tax_context_policy(id, org_id, export_zero BOOL DEFAULT true, intra_eu_reverse_charge BOOL DEFAULT true, rounding ENUM('line','document') DEFAULT 'line', rounding_precision INT DEFAULT 2)`

âš–ï¸ RÃ©solution (algorithme)
--------------------------
1) DÃ©terminer **pays de taxation** (par dÃ©faut: pays du client/livraison).
2) Si **export hors UE** ET `export_zero=true` â†’ `rate=0`.
3) Si **intraâ€‘UE** ET client **segment Pro/Export** avec `vat_number` prÃ©sent ET `intra_eu_reverse_charge=true` â†’ `rate=0` + `reverse_charge=true`.
4) Sinon, choisir la `tax_rule` la plus spÃ©cifique (segment+product > segment only > country only) **active** Ã  la date.
5) Arrondi **ligne**: `round(ht * rate/100, precision)` ; `ttc = ht + tva`.

â›ï¸ Ã‰tapes dâ€™implÃ©mentation
--------------------------
Ã‰tape 0 â€” Base
- [ ] Migrations + seed : `FR 20%`, `FR 5.5%` (produits spÃ©ciaux v1.1), `DE 19%`, `ES 21%`.
- [ ] `tax_context_policy` par dÃ©faut.

Ã‰tape 1 â€” CRUD rÃ¨gles
- [ ] GET `/tarifs/taxes` filtres pays/segment/actives ; keyset.
- [ ] POST `/tarifs/taxes` : validation taux 0..100, dates cohÃ©rentes.
- [ ] Disable (soft).

Ã‰tape 2 â€” RÃ©solveur
- [ ] `resolve_tax(org, client, cuvee?, date)` :
      - DÃ©termine pays (client.country_code), segment (CRM), nÂ° TVA.
      - Applique 2/3 (export/reverse) ; sinon cherche `tax_rule` la plus spÃ©cifique.
- [ ] Expose `GET /tarifs/taxes/resolve?client_id=...&date=...` (debug interne).

Ã‰tape 3 â€” Arrondis & Policies
- [ ] ImplÃ©menter rounding **line** (v1) ; stocker `rounding` dans policy (pour v1.1 document-level).
- [ ] Tests arrondis aux 2 dÃ©cimales (configurable).

Ã‰tape 4 â€” ObservabilitÃ©
- [ ] Metrics : `tax_resolve_latency_ms`, `reverse_charge_rate`, `export_zero_rate`.
- [ ] Logs : `org, client, country, rate, reverse_charge, rule_id`.

Ã‰tape 5 â€” SÃ©curitÃ©
- [ ] RBAC/RLS/Audit ; validations strictes ; XSS sur labels.

ğŸ§ª AC
-----
- ACâ€‘44â€‘01 : Client FR Particulier â†’ 20 % appliquÃ© (ex FR).
- ACâ€‘44â€‘02 : Client Pro DE (VAT prÃ©sent) â†’ reverse charge 0 % pour livraison intraâ€‘UE.
- ACâ€‘44â€‘03 : Client Export (hors UE) â†’ 0 % si policy active.
- ACâ€‘44â€‘04 : Arrondis ligne corrects (ex: 10.00 HT @ 20% â†’ TVA 2.00, TTC 12.00).

ğŸ›¡ï¸ Robustesse
--------------
- Chevauchements : si 2 rÃ¨gles concurrentes, prendre la plus **spÃ©cifique** puis `priority`.
- Taux invalides â†’ 400 ; dates inversÃ©es â†’ 400.
- Changement policy (lineâ†’document) : tests nonâ€‘rÃ©gression (v1.1).

ğŸ“š Dev Book
-----------
- `tax_rules.md` : matrices de dÃ©cision, exemples chiffrÃ©s, rÃ©fÃ©rences lÃ©gales (Ã  complÃ©ter mÃ©tier), schÃ©ma dâ€™arrondis.
