Roadmap 45 â€” /tarifs/simulateur (Liste + Remises + Taxes, audit explicable) â€” VERSION DÃ‰TAILLÃ‰E
===============================================================================================

ğŸ¯ Objectif
-----------
Construire un **simulateur** de prix final **explicable**. EntrÃ©es : client (ou segment+pays), cuvÃ©e, UOM, quantitÃ©, date. 
Sortie : dÃ©tail â€œliste â†’ remises â†’ taxesâ€ avec **audit** pasâ€‘Ã â€‘pas et **caches**.

ğŸ”— Contrat API
--------------
POST `/tarifs/simulateur`
Body:
{
  "client_id": "UUID" OR {"segment":"business","country_code":"FR"},
  "cuvee_id": "UUID",
  "uom_id": "UUID",
  "quantity": 12,
  "date": "2025-10-01",
  "currency": "EUR",
  "explain": true
}
RÃ©ponse:
{
  "base_price": 7.80,
  "list_source": {"price_list_id": "...", "version": 2, "item_id": "..."},
  "discounts": [{"rule_id":"...","type":"percent","value":2.0,"stack_mode":"stack","after_price":7.644}, ...],
  "subtotal_ht": 7.30,
  "tax_rate": 20.0,
  "tax_amount": 1.46,
  "total_ttc": 8.76,
  "audit": {"steps":[...], "warnings":["floor_price_hit"]}
}

â›ï¸ Pipeline de calcul (services)
--------------------------------
1) `resolve_customer_context(client_id or segment+country)` â†’ {segment, country, vat_number?}
2) `resolve_price_list(org, segment, country, date)` (42) â†’ {price_list_id, version_id}
3) `resolve_price_item(version_id, cuvee_id, uom_id, quantity)` â†’ {base_price_ht, floor_price?}
4) `select_applicable_rules(org, client, segment, cuvee, quantity, date)` (43) â†’ [rules]
5) `apply_discounts(base_price_ht, rules)` â†’ {price_after_discounts, applied_rules[], floor_hit?}
6) `resolve_tax(org, client, date)` (44) â†’ {rate, reverse_charge?}
7) `compute_totals(ht, rate, rounding_policy)` â†’ {subtotal_ht, tax_amount, total_ttc}
8) `build_audit(...)` â†’ steps explicites + warnings

ğŸ§± Ã‰tapes dâ€™implÃ©mentation
--------------------------
Ã‰tape 0 â€” Squelette & stubs
- [ ] Route POST, validations dâ€™entrÃ©e, stubs services 42/43/44.

Ã‰tape 1 â€” RÃ©solutions rÃ©elles (42)
- [ ] Plug `resolve_price_list`, `resolve_price_item` + caches (300 s & 120 s).
- [ ] Gestion `NotFound` item â†’ 422 avec suggestion UOM dÃ©faut.

Ã‰tape 2 â€” Remises (43)
- [ ] Plug `select_applicable_rules` + `apply_discounts` (audit after_price).

Ã‰tape 3 â€” Taxes (44)
- [ ] Plug `resolve_tax` + `compute_totals` (arrondis ligne).

Ã‰tape 4 â€” Audit & Explain
- [ ] Ã‰tapes dÃ©taillÃ©es : pour chaque rÃ¨gle â†’ `rule_id`, `scope`, `priority`, `stack_mode`, `before`, `after`.
- [ ] Flags : `floor_price_hit`, `reverse_charge`.
- [ ] `explain=1` â†’ inclure les requÃªtes sources (ids + versions).

Ã‰tape 5 â€” UI
- [ ] Form simulateur : sÃ©lecteur client **ou** segment+pays, cuvÃ©e, UOM, qty, date.
- [ ] Carte â€œTotalâ€ + tableaux â€œRemisesâ€ & â€œTaxesâ€ ; badges â€œListe vXâ€, â€œReverse chargeâ€.

Ã‰tape 6 â€” Caches & invalidations
- [ ] ClÃ© : `sim:{org}:{client_or_segment}:{cuvee}:{uom}:{qty_bucket}:{date_bucket}` TTL 60â€“300 s.
- [ ] Invalidations sur activation version liste, CRUD remises, CRUD taxes.

Ã‰tape 7 â€” ObservabilitÃ© & erreurs
- [ ] Metrics : `pricing_sim_latency_ms`, `sim_cache_hit_ratio`, `sim_errors_total{type}`.
- [ ] Logs audit JSON (corrÃ©lables aux devis/commandes plus tard).
- [ ] Codes dâ€™erreurs prÃ©cis : 404 client/cuvÃ©e/uom ; 422 item manquant/devise `amount_off` ; 409 incohÃ©rences.

ğŸ§ª AC
-----
- ACâ€‘45â€‘01 : Pro FR, cuvÃ©e X, qty=12 â†’ palier + remises multiplicatives + TVA FR = total TTC attendu.
- ACâ€‘45â€‘02 : Client DE avec VAT â†’ TVA 0 % (reverse) ; audit explicite.
- ACâ€‘45â€‘03 : RÃ¨gle `exclusive` client > rÃ¨gle segment ; `stop` arrÃªte lâ€™empilement.
- ACâ€‘45â€‘04 : `floor_price` coupÃ©, warning prÃ©sent.

ğŸ›¡ï¸ Robustesse
--------------
- Item absent â†’ 422 + suggestion UOM par dÃ©faut.
- Conflit devise `amount_off` â†’ 422.
- Cache stale aprÃ¨s activation version â†’ invalider et prouver rÃ©sultat diffÃ©rent.

ğŸ“š Dev Book
-----------
- `pricing_engine.md` : pipeline, structures audit, exemples chiffrÃ©s, caches, invalidations, codes dâ€™erreurs.
